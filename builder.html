<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>micro:bit BLE GUI Builder</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 16px; }
    .top { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    button, select, input { padding: 8px 10px; }
    .layout { display:grid; grid-template-columns: 360px 1fr; gap: 14px; margin-top: 14px; }
    .panel { border:1px solid #ddd; border-radius:16px; padding: 12px; }
    .muted { color:#666; font-size: .95em; }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    label { display:block; font-size:.9em; color:#444; margin-top: 10px; }
    textarea { width:100%; height:160px; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; }
    #preview { display:grid; gap:10px; }
    .card { border:1px solid #ddd; border-radius:14px; padding:12px; }
    .hdr { display:flex; justify-content:space-between; gap:10px; align-items:center; }
    .title { font-weight:700; }
    .small { color:#666; font-size:.95em; }
    .danger { color:#b00; }
    .pill { font-size:.85em; background:#f3f3f3; padding: 2px 8px; border-radius:999px; }
  </style>
</head>
<body>
  <h2>GUI Builder (micro:bit BLE)</h2>
  <div class="muted">Build a GUI → export JSON or MakeCode (no escaping). Saved automatically for Runtime offline preview.</div>

  <div class="top" style="margin-top:10px;">
    <span class="pill">Grid</span>
    <label style="margin:0;">
      W <input id="gridW" type="number" value="12" min="6" max="24" style="width:70px;">
    </label>
    <label style="margin:0;">
      H <input id="gridH" type="number" value="8" min="4" max="24" style="width:70px;">
    </label>
    <label style="margin:0;">
      Title <input id="title" value="micro:bit Controller" style="width:220px;">
    </label>

    <span class="pill">Add widget</span>
    <select id="addType">
      <option value="btn">Button</option>
      <option value="tgl">Toggle</option>
      <option value="sld">Slider</option>
      <option value="g">Gauge (read-only)</option>
      <option value="lvl">Level (read-only)</option>
      <option value="txt">Text (read-only)</option>
      <option value="joy">Joystick</option>
      <option value="led">LED 5x5</option>
      <option value="snd">Sound</option>
    </select>
    <button id="addBtn">Add</button>
    <button id="clearBtn">Clear</button>
  </div>

  <div class="layout">
    <div class="panel">
      <div class="title">Selected widget</div>
      <div id="selNone" class="muted" style="margin-top:8px;">Click a widget in preview to edit it.</div>

      <div id="editor" style="display:none; margin-top:8px;">
        <div class="row">
          <span class="pill" id="wType"></span>
          <span class="pill">id: <b id="wId"></b></span>
        </div>

        <label>Label <input id="wLabel" style="width:100%"></label>

        <div class="row" style="margin-top:8px;">
          <label style="margin:0;">x <input id="wx" type="number" style="width:70px"></label>
          <label style="margin:0;">y <input id="wy" type="number" style="width:70px"></label>
          <label style="margin:0;">w <input id="ww" type="number" style="width:70px"></label>
          <label style="margin:0;">h <input id="wh" type="number" style="width:70px"></label>
        </div>

        <div id="rangeFields" style="display:none;">
          <div class="row" style="margin-top:8px;">
            <label style="margin:0;">min <input id="wMin" type="number" style="width:90px"></label>
            <label style="margin:0;">max <input id="wMax" type="number" style="width:90px"></label>
            <label style="margin:0;">step <input id="wStep" type="number" style="width:90px"></label>
          </div>
          <label>default value <input id="wVal" type="number" style="width:100%"></label>
        </div>

        <div id="joyFields" style="display:none;">
          <label>deadzone (0..20) <input id="wDead" type="number" style="width:100%"></label>
        </div>

        <div id="ledFields" style="display:none;">
          <label>bits (25 chars 0/1) <input id="wBits" style="width:100%"></label>
        </div>

        <div id="sndFields" style="display:none;">
          <div class="row" style="margin-top:8px;">
            <label style="margin:0;">freq <input id="wFreq" type="number" style="width:120px"></label>
            <label style="margin:0;">ms <input id="wMs" type="number" style="width:120px"></label>
          </div>
        </div>

        <div id="textFields" style="display:none;">
          <label>default text/value <input id="wText" style="width:100%"></label>
        </div>

        <div class="row" style="margin-top:10px;">
          <button id="deleteBtn">Delete</button>
          <span id="err" class="danger"></span>
        </div>
      </div>

      <hr style="margin:14px 0; border:none; border-top:1px solid #eee;">

      <div class="title">Export</div>
      <div class="row" style="margin-top:8px;">
        <button id="exportJson">Export JSON</button>
        <button id="exportMakeCode">Export MakeCode</button>
      </div>

      <label style="margin-top:10px;">Output</label>
      <textarea id="out" spellcheck="false"></textarea>
      <div class="muted">Runtime offline preview uses the last saved JSON automatically.</div>
    </div>

    <div class="panel">
      <div class="hdr">
        <div class="title">Preview</div>
        <div class="small">Click widgets to edit • Auto-layout on grid</div>
      </div>
      <div id="preview" style="margin-top:10px;"></div>
    </div>
  </div>

<script>
  let cfg = {
    v: 1,
    title: "micro:bit Controller",
    grid: { w: 12, h: 8 },
    widgets: []
  };

  let selectedId = null;

  const $ = (id) => document.getElementById(id);

  function saveLocal(){
    try { localStorage.setItem("mb_ui_last_json", JSON.stringify(cfg)); } catch(e){}
  }

  function nextId(prefix){
    let i = 1;
    const ids = new Set(cfg.widgets.map(w => w.id));
    while(ids.has(prefix + i)) i++;
    return prefix + i;
  }

  function overlaps(a, b){
    return !(a.x + a.w <= b.x || b.x + b.w <= a.x || a.y + a.h <= b.y || b.y + b.h <= a.y);
  }

  function firstFreeRect(w, h){
    const GW = cfg.grid.w, GH = cfg.grid.h;
    for(let y = 0; y <= GH - h; y++){
      for(let x = 0; x <= GW - w; x++){
        const r = {x,y,w,h};
        let ok = true;
        for(const ww of cfg.widgets){
          if(overlaps(r, ww)){ ok = false; break; }
        }
        if(ok) return r;
      }
    }
    return null;
  }

  function defaultWidget(type){
    if(type === "btn") return { t:"btn", w:4, h:2, label:"Button" };
    if(type === "tgl") return { t:"tgl", w:4, h:2, label:"Toggle", value:0 };
    if(type === "sld") return { t:"sld", w:12, h:2, label:"Slider", min:0, max:100, step:1, value:50 };
    if(type === "g")   return { t:"g",   w:9, h:2, label:"Gauge", min:0, max:100, value:0 };
    if(type === "lvl") return { t:"lvl", w:3, h:4, label:"Level", min:0, max:255, value:0 };
    if(type === "txt") return { t:"txt", w:12, h:2, label:"Text", value:"Hello" };
    if(type === "joy") return { t:"joy", w:6, h:6, label:"Joystick", deadzone:5 };
    if(type === "led") return { t:"led", w:6, h:6, label:"LED 5x5", bits:"0000000000000000000000000" };
    if(type === "snd") return { t:"snd", w:6, h:3, label:"Sound", freq:440, ms:150 };
    return { t:type, w:4, h:2, label:type };
  }

  function validateWidget(w){
    const GW = cfg.grid.w, GH = cfg.grid.h;
    if(w.x < 0 || w.y < 0 || w.w <= 0 || w.h <= 0) return "Bad geometry.";
    if(w.x + w.w > GW || w.y + w.h > GH) return "Out of grid bounds.";
    for(const other of cfg.widgets){
      if(other.id === w.id) continue;
      if(overlaps(w, other)) return "Overlaps another widget.";
    }
    if((w.t === "sld" || w.t === "g" || w.t === "lvl") && (w.min >= w.max)) return "min must be < max.";
    if(w.t === "led" && String(w.bits||"").length !== 25) return "LED bits must be 25 chars.";
    return "";
  }

  function renderPreview(){
    const ui = $("preview");
    ui.innerHTML = "";
    ui.style.gridTemplateColumns = `repeat(${cfg.grid.w}, 1fr)`;

    for(const w of cfg.widgets){
      const card = document.createElement("div");
      card.className = "card";
      card.style.gridColumn = `${w.x+1} / span ${w.w}`;
      card.style.gridRow = `${w.y+1} / span ${w.h}`;
      card.style.cursor = "pointer";
      card.onclick = () => select(w.id);

      if(w.id === selectedId) card.style.outline = "2px solid #999";

      const hdr = document.createElement("div");
      hdr.className = "hdr";
      const title = document.createElement("div");
      title.className = "title";
      title.textContent = w.label || w.id;
      const meta = document.createElement("div");
      meta.className = "small";
      meta.textContent = `${w.t} • ${w.id}`;
      hdr.appendChild(title);
      hdr.appendChild(meta);
      card.appendChild(hdr);

      const body = document.createElement("div");
      body.className = "small";
      body.textContent = (w.t === "joy") ? "joystick pad" :
                         (w.t === "led") ? "5x5 grid" :
                         (w.t === "snd") ? "tone" :
                         (w.t === "txt") ? String(w.value ?? "") : "";
      card.appendChild(body);

      ui.appendChild(card);
    }
    saveLocal();
  }

  function select(id){
    selectedId = id;
    const w = cfg.widgets.find(x => x.id === id);
    $("selNone").style.display = w ? "none" : "block";
    $("editor").style.display = w ? "block" : "none";
    $("err").textContent = "";

    if(!w) { renderPreview(); return; }

    $("wType").textContent = w.t;
    $("wId").textContent = w.id;
    $("wLabel").value = w.label ?? "";

    $("wx").value = w.x; $("wy").value = w.y; $("ww").value = w.w; $("wh").value = w.h;

    const isRange = (w.t === "sld" || w.t === "g" || w.t === "lvl");
    $("rangeFields").style.display = isRange ? "block" : "none";
    if(isRange){
      $("wMin").value = w.min; $("wMax").value = w.max;
      $("wStep").value = (w.t === "sld") ? w.step : 1;
      $("wVal").value = w.value ?? 0;
      $("wStep").disabled = (w.t !== "sld");
    }

    $("textFields").style.display = (w.t === "txt") ? "block" : "none";
    if(w.t === "txt") $("wText").value = String(w.value ?? "");

    $("joyFields").style.display = (w.t === "joy") ? "block" : "none";
    if(w.t === "joy") $("wDead").value = w.deadzone ?? 5;

    $("ledFields").style.display = (w.t === "led") ? "block" : "none";
    if(w.t === "led") $("wBits").value = String(w.bits ?? "0000000000000000000000000");

    $("sndFields").style.display = (w.t === "snd") ? "block" : "none";
    if(w.t === "snd") { $("wFreq").value = w.freq ?? 440; $("wMs").value = w.ms ?? 150; }

    renderPreview();
  }

  function updateSelected(){
    const w = cfg.widgets.find(x => x.id === selectedId);
    if(!w) return;

    w.label = $("wLabel").value;
    w.x = parseInt($("wx").value);
    w.y = parseInt($("wy").value);
    w.w = parseInt($("ww").value);
    w.h = parseInt($("wh").value);

    if(w.t === "sld" || w.t === "g" || w.t === "lvl"){
      w.min = parseInt($("wMin").value);
      w.max = parseInt($("wMax").value);
      if(w.t === "sld") w.step = parseInt($("wStep").value);
      w.value = parseInt($("wVal").value);
    }
    if(w.t === "txt"){
      w.value = $("wText").value;
    }
    if(w.t === "joy"){
      w.deadzone = parseInt($("wDead").value);
    }
    if(w.t === "led"){
      w.bits = $("wBits").value;
    }
    if(w.t === "snd"){
      w.freq = parseInt($("wFreq").value);
      w.ms = parseInt($("wMs").value);
    }

    const err = validateWidget(w);
    $("err").textContent = err;
    renderPreview();
  }

  $("gridW").oninput = () => { cfg.grid.w = parseInt($("gridW").value); renderPreview(); };
  $("gridH").oninput = () => { cfg.grid.h = parseInt($("gridH").value); renderPreview(); };
  $("title").oninput = () => { cfg.title = $("title").value; renderPreview(); };

  $("addBtn").onclick = () => {
    const type = $("addType").value;
    const base = defaultWidget(type);
    const rect = firstFreeRect(base.w, base.h);
    if(!rect){ alert("No space left on the grid for this widget size."); return; }

    const prefix = type;
    const w = { id: nextId(prefix), ...base, x: rect.x, y: rect.y };
    cfg.widgets.push(w);
    select(w.id);
  };

  $("clearBtn").onclick = () => {
    cfg.widgets = [];
    selectedId = null;
    $("out").value = "";
    select(null);
    renderPreview();
  };

  ["wLabel","wx","wy","ww","wh","wMin","wMax","wStep","wVal","wText","wDead","wBits","wFreq","wMs"].forEach(id => {
    const el = $(id);
    if(el) el.oninput = () => updateSelected();
  });

  $("deleteBtn").onclick = () => {
    cfg.widgets = cfg.widgets.filter(w => w.id !== selectedId);
    selectedId = null;
    select(null);
    renderPreview();
  };

  $("exportJson").onclick = () => {
    $("out").value = JSON.stringify(cfg, null, 2);
    saveLocal();
  };

  // Export MakeCode snippet: UI_CFG_LINES + UI_CFG_JSON + sendConfig() helper
  function makeCodeExport(){
    // minified JSON is smaller and stable for length framing
    const json = JSON.stringify(cfg);
    // split into readable chunks
    const chunks = [];
    const MAX = 60;
    for(let i=0;i<json.length;i+=MAX){
      let part = json.slice(i,i+MAX);
      part = part.replace(/\\/g, "\\\\").replace(/'/g, "\\'");
      chunks.push("'" + part + "'");
    }
    return `// Paste into MakeCode JavaScript (micro:bit)
bluetooth.startUartService()

const UI_CFG_LINES: string[] = [
  ${chunks.join(",\n  ")}
]
const UI_CFG_JSON = UI_CFG_LINES.join("")

let sendingCfg = false

function sendConfig() {
  sendingCfg = true
  bluetooth.uartWriteLine("CFGBEGIN " + UI_CFG_JSON.length)
  bluetooth.uartWriteString(UI_CFG_JSON)
  bluetooth.uartWriteLine("")
  bluetooth.uartWriteLine("CFGEND")
  sendingCfg = false
}

// In onUartDataReceived: if line == "GETCFG" then sendConfig()
`;
  }

  $("exportMakeCode").onclick = () => {
    $("out").value = makeCodeExport();
    saveLocal();
  };

  // Load last config if present
  try {
    const saved = localStorage.getItem("mb_ui_last_json");
    if(saved) cfg = JSON.parse(saved);
  } catch(e){}

  $("title").value = cfg.title;
  $("gridW").value = cfg.grid.w;
  $("gridH").value = cfg.grid.h;
  renderPreview();
  select(null);
</script>
</body>
</html>
