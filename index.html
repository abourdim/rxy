<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>micro:bit Remote</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/interact.js/1.10.27/interact.min.js"></script>
<link rel="stylesheet" href="style.css">
<style>
:root {
  --bg: #1a1a2e;
  --surface: #16213e;
  --card: #1f3460;
  --accent: #00d4ff;
  --pink: #ff6b9d;
  --green: #00e676;
  --orange: #ff9100;
  --purple: #b388ff;
  --red: #ff5252;
  --yellow: #ffea00;
  --text: #ffffff;
  --text-dim: #8892b0;
}

* { box-sizing: border-box; margin: 0; padding: 0; }
html, body { height: 100%; overflow: hidden; touch-action: manipulation; font-family: 'Segoe UI', system-ui, sans-serif; }
body { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); color: var(--text); }

.app { display: flex; flex-direction: column; height: 100dvh; }

/* Header */
header {
  display: flex; align-items: center; gap: 10px;
  padding: 8px 12px; background: rgba(22,33,62,0.95);
  border-bottom: 2px solid var(--card);
}
.logo { font-size: 1.3rem; font-weight: 800; }
.logo span { background: linear-gradient(90deg, var(--accent), var(--pink)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
.spacer { flex: 1; }

.tabs { display: flex; background: var(--card); border-radius: 30px; padding: 4px; }
.tab {
  padding: 10px 20px; border: none; background: none;
  color: var(--text-dim); font-weight: 700; font-size: 0.9rem;
  border-radius: 30px; cursor: pointer; transition: 0.2s;
}
.tab.active { background: linear-gradient(135deg, var(--accent), var(--purple)); color: #000; }

.ble-btn {
  display: flex; align-items: center; gap: 8px;
  padding: 10px 16px; border-radius: 30px;
  background: var(--card); border: 2px solid var(--red);
  color: var(--red); font-weight: 700; cursor: pointer;
}
.ble-btn.connected { border-color: var(--green); color: var(--green); }
.ble-dot {  height: 12px; border-radius: 50%; background: currentColor; }

/* Main Content */
main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
.view { display: none; flex-direction: column; height: 100%; }
.view.active { display: flex; }

/* Builder View */
.builder-header {
  display: flex; align-items: center; gap: 8px;
  padding: 10px 12px; background: var(--surface);
  flex-wrap: wrap;
}
.title-input {
  flex: 1; min- padding: 12px 16px;
  background: var(--card); border: 2px solid transparent;
  border-radius: 16px; color: var(--text); font-size: 1rem; font-weight: 600;
}
.title-input:focus { outline: none; border-color: var(--accent); }
.header-btn {
  padding: 12px 20px; border: none; border-radius: 16px;
  font-weight: 700; font-size: 0.85rem; cursor: pointer; transition: 0.2s;
  display: flex; align-items: center; gap: 6px;
}
.header-btn:hover { transform: scale(1.05); }
.btn-demo { background: linear-gradient(135deg, var(--yellow), var(--orange)); color: #000; }
.btn-code { background: linear-gradient(135deg, var(--accent), var(--purple)); color: #000; }
.btn-delete { background: var(--red); color: #fff; }

/* Palette - Bottom on mobile */
.palette {
  display: flex; gap: 8px; padding: 10px;
  background: var(--surface); border-top: 2px solid var(--card);
  overflow-x: auto; order: 2;
}
.palette-item {
  flex-shrink: 0; display: flex; flex-direction: column;
  align-items: center; gap: 6px; padding: 12px 16px;
  background: var(--card); border: 3px solid transparent;
  border-radius: 16px; cursor: pointer; transition: 0.2s;
  min-
}
.palette-item:hover, .palette-item.selected { border-color: var(--accent); transform: scale(1.05); }
.palette-item.selected { background: linear-gradient(135deg, var(--accent), var(--purple)); }
.palette-item.selected .palette-name { color: #000; }
.palette-icon { font-size: 28px; }
.palette-name { font-size: 0.7rem; font-weight: 700; color: var(--text-dim); text-transform: uppercase; }

/* Canvas */
.canvas-wrap { flex: 1; padding: 10px; overflow: hidden; order: 1; display: flex; flex-direction: column; }
.canvas-hint { text-align: center; padding: 8px; color: var(--text-dim); font-size: 0.85rem; }
.canvas-hint span { color: var(--accent); font-weight: 700; }
.canvas {
  flex: 1; position: relative; background: var(--card);
  border: 3px dashed var(--text-dim); border-radius: 20px;
  overflow: auto; min-height: 250px;
}
#widgetsLayer { position: absolute; inset: 0; }

.widget {
  position: absolute; background: var(--surface);
  border: 3px solid var(--text-dim); border-radius: 16px;
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  cursor: move; touch-action: none; user-select: none; gap: 4px; padding: 8px;
}
.widget.selected { border-color: var(--accent); box-shadow: 0 0 30px rgba(0,212,255,0.5); }
.widget-icon { font-size: 2rem; pointer-events: none; }
.widget-label { font-size: 0.75rem; font-weight: 700; color: var(--text-dim); pointer-events: none; }
.widget .resize-handle {
  position: absolute; bottom: -2px; right: -2px;
   height: 24px; cursor: se-resize;
  background: var(--accent); border-radius: 0 0 14px 0;
  clip-path: polygon(100% 0, 100% 100%, 0 100%);
}

/* Runtime View */
.runtime-view { align-items: center; justify-content: center; padding: 20px; }
.connect-box { text-align: center; }
.connect-icon { font-size: 6rem; margin-bottom: 20px; animation: bounce 1s infinite; }
@keyframes bounce { 0%,100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }
.connect-text { font-size: 1.3rem; font-weight: 700; margin-bottom: 24px; }
.connect-btn {
  padding: 18px 40px; border: none; border-radius: 30px;
  background: linear-gradient(135deg, var(--green), var(--accent));
  color: #000; font-size: 1.2rem; font-weight: 800; cursor: pointer;
}
#runtimeContent { display: none; flex-direction: column; align-items: center; width: 100%; }
#runtimeTitle { font-size: 1.6rem; font-weight: 800; color: var(--accent); margin-bottom: 20px; }
#runtimeGrid { position: relative; background: var(--card); border: 3px solid var(--surface); border-radius: 20px; }

/* Runtime Widgets */
/* Graph (Online) */
.rt-graph-wrap{
  width: 100%; height: 100%;
  display:flex; flex-direction:column; gap:8px;
  padding: 10px;
  border-radius: 16px;
}
.rt-graph-head{ display:flex; justify-content:space-between; font-weight:800; font-size:0.9rem; color: var(--text); }
.rt-graph-sub{ display:flex; gap:8px; flex-wrap:wrap; font-size:0.75rem; color: var(--text-dim); font-weight:800; }
.rt-graph-dot{  height:10px; border-radius:999px; display:inline-block; vertical-align:middle; margin-right:6px; }
.rt-graph-canvas{
  width: 100%; flex:1;
  border-radius: 14px;
  background: rgba(0,0,0,0.14);
  border: 2px solid rgba(255,255,255,0.10);
}
.rt-graph-wrap.model-grid{
  background: linear-gradient(135deg, rgba(0,212,255,0.10), rgba(179,136,255,0.10));
}
.rt-graph-wrap.model-dark{
  background: rgba(0,0,0,0.15);
}
.rt-graph-wrap.model-min{
  background: transparent;
  border: 2px solid rgba(255,255,255,0.10);
}

/* Gauge */
.rt-gauge-wrap{
  width:100%; height:100%;
  display:flex; flex-direction:column; align-items:center; justify-content:center;
  gap:8px; padding:10px;
  border-radius: 16px;
}
.rt-gauge-svg{ width: 100%; height: 100%; max-height: 130px; }
.rt-gauge-ticks line{ stroke: rgba(255,255,255,0.22); stroke-width: 2; stroke-linecap: round; }
.rt-gauge-bg{ fill:none; stroke: rgba(255,255,255,0.14); stroke-width: 12; stroke-linecap: round; }
.rt-gauge-fg{ fill:none; stroke: var(--green); stroke-width: 12; stroke-linecap: round;
  stroke-dasharray: 157.1; /* approx half circumference with r=50 */
  stroke-dashoffset: 157.1;
  transition: stroke-dashoffset 0.25s ease, stroke 0.25s ease;
}

.rt-gauge-label{ font-weight:800; color: var(--text-dim); font-size:0.85rem; text-align:center; }
.rt-gauge-value{ font-weight:900; font-size:1.1rem; color: var(--text); text-align:center; }
.rt-gauge-wrap.model-classic{ background: rgba(0,0,0,0.10); border: 2px solid rgba(255,255,255,0.10); }
.rt-gauge-wrap.model-neon{ background: linear-gradient(135deg, rgba(0,212,255,0.12), rgba(255,107,157,0.10)); box-shadow: 0 0 30px rgba(0,212,255,0.12); }
.rt-gauge-wrap.model-min{ background: transparent; border: 2px solid rgba(255,255,255,0.10); }

.rt-widget { position: absolute; padding: 10px; display: flex; align-items: center; justify-content: center; }
.rt-button {
  width: 100%; height: 100%; border: none; border-radius: 16px;
  background: linear-gradient(135deg, #6366f1, var(--purple));
  color: #fff; font-weight: 700; cursor: pointer;
  display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 6px;
  font-size: 1rem; transition: 0.1s;
}
.rt-button:active { transform: scale(0.9); }
.rt-button .icon { font-size: 2rem; }

.rt-slider-wrap { width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; gap: 10px; }
.rt-slider-info { display: flex; justify-content: space-between; font-weight: 700; }
.rt-slider { width: 100%; height: 12px; border-radius: 6px; background: var(--surface); -webkit-appearance: none; }
.rt-slider::-webkit-slider-thumb { -webkit-appearance: none;  height: 30px; border-radius: 50%; background: linear-gradient(135deg, var(--purple), var(--pink)); cursor: pointer; }

.rt-toggle-wrap { display: flex; flex-direction: column; align-items: center; gap: 10px; }
.rt-toggle {  height: 70px; border: none; border-radius: 16px; background: var(--red); color: #fff; font-size: 2rem; cursor: pointer; transition: 0.2s; }
.rt-toggle.on { background: var(--green); }

.rt-led-wrap { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 10px; }
.rt-led {  height: 60px; border-radius: 50%; background: rgba(255,82,82,0.2); transition: 0.2s; }
.rt-led.on { background: var(--red); box-shadow: 0 0 40px var(--red); }

.rt-joystick-wrap { display: flex; flex-direction: column; align-items: center; gap: 6px; }
.rt-joystick-base {  height: 100px; border-radius: 50%; background: var(--surface); border: 4px solid var(--accent); display: flex; align-items: center; justify-content: center; touch-action: none; }
.rt-joystick-stick {  height: 50px; border-radius: 50%; background: linear-gradient(135deg, var(--accent), var(--purple)); pointer-events: none; }

.rt-label-text { font-weight: 700; font-size: 1.2rem; text-align: center; }

/* --- Widget Models (Runtime) --- */
/* Buttons */
.rt-button.model-neo{
  background: linear-gradient(135deg, #6366f1, var(--purple));
  box-shadow: 0 10px 25px rgba(0,0,0,0.25);
}
.rt-button.model-flat{
  background: var(--accent);
  color: #000;
  box-shadow: none;
}
.rt-button.model-glass{
  background: rgba(255,255,255,0.08);
  border: 2px solid rgba(255,255,255,0.18);
  backdrop-filter: blur(10px);
  box-shadow: 0 12px 30px rgba(0,0,0,0.35);
}

/* Sliders */
.rt-slider.model-track{ height: 12px; border-radius: 6px; }
.rt-slider.model-min{ height: 6px; border-radius: 999px; }
.rt-slider.model-neon{
  height: 12px;
  border-radius: 999px;
  box-shadow: 0 0 20px rgba(0,212,255,0.25);
}
.rt-slider.model-neon::-webkit-slider-thumb{
  box-shadow: 0 0 25px rgba(179,136,255,0.7);
}
.rt-slider.model-min::-webkit-slider-thumb{
   height: 26px;
  background: linear-gradient(135deg, var(--accent), var(--pink));
}

/* Toggles */
.rt-toggle.model-square{ border-radius: 16px; }
.rt-toggle.model-pill{
   height: 46px;
  border-radius: 999px;
  display:flex; align-items:center; justify-content:center;
  font-size: 1.4rem;
}
.rt-toggle.model-icon{
  background: var(--card);
  border: 3px solid var(--surface);
  color: var(--text);
}
.rt-toggle.model-icon.on{
  border-color: var(--green);
  box-shadow: 0 0 30px rgba(0,230,118,0.35);
}

/* LEDs */
.rt-led.model-dot{ border-radius: 50%; }
.rt-led.model-bar{
  width: 90%;
  height: 28%;
  min-height: 18px;
  border-radius: 999px;
}
.rt-led.model-ring{
  background: transparent !important;
  border: 6px solid rgba(255,255,255,0.18);
  box-shadow: none !important;
}
.rt-led.model-ring.on{
  background: transparent !important;
}

/* Joysticks */
.rt-joystick-base.model-classic{ border: 4px solid var(--accent); }
.rt-joystick-base.model-neon{
  border: 4px solid var(--accent);
  box-shadow: 0 0 35px rgba(0,212,255,0.35);
}
.rt-joystick-base.model-min{
  border: 3px solid rgba(255,255,255,0.18);
}
.rt-joystick-stick.model-min{
  background: rgba(255,255,255,0.14);
}

/* Labels */
.rt-label-text.model-plain{ }
.rt-label-text.model-card{
  background: rgba(255,255,255,0.06);
  border: 2px solid rgba(255,255,255,0.14);
  border-radius: 16px;
  padding: 10px 14px;
}
.rt-label-text.model-glow{
  text-shadow: 0 0 18px rgba(0,212,255,0.55);
}

/* Props panel helpers */
.props-row{
  display:flex;
  gap:8px;
  align-items:center;
}
.props-apply{
  margin-top: 10px;
  width: 100%;
  padding: 10px 12px;
  border-radius: 14px;
  border: 2px solid rgba(255,255,255,0.12);
  background: rgba(255,255,255,0.06);
  color: var(--text);
  font-weight: 800;
  cursor: pointer;
}
.props-apply:hover{
  border-color: var(--accent);
}


/* Loading Overlay (kid-friendly) */
.loading-overlay{
  position: fixed; inset: 0;
  display: none;
  align-items: center; justify-content: center;
  background: rgba(0,0,0,0.65);
  z-index: 3000;
  padding: 18px;
}
.loading-overlay.show{ display:flex; }
.loading-card{
  width: min(520px, 95vw);
  background: linear-gradient(135deg, rgba(0,212,255,0.14), rgba(255,107,157,0.10));
  border: 2px solid rgba(255,255,255,0.18);
  border-radius: 22px;
  padding: 18px;
  box-shadow: 0 20px 60px rgba(0,0,0,0.45);
  text-align: center;
}
.loading-title{ font-weight: 900; font-size: 1.1rem; }
.loading-sub{ margin-top: 6px; color: var(--text-dim); font-weight: 800; }
.loading-bar{
  margin-top: 14px;
  height: 14px;
  background: rgba(0,0,0,0.22);
  border-radius: 999px;
  overflow: hidden;
  border: 2px solid rgba(255,255,255,0.12);
}
.loading-bar-fill{
  height: 100%;
  width: 0%;
  border-radius: 999px;
  background: linear-gradient(90deg, var(--accent), var(--pink), var(--yellow));
  transition: width 0.18s ease;
}
.loading-pct{ margin-top: 10px; font-weight: 900; color: var(--accent); }

/* Graph: clearer axes & legend */
.rt-graph-head{ align-items: center; }
.rt-graph-head span:first-child{ display:flex; gap:8px; align-items:center; }
.rt-graph-head span:first-child::before{ content:"ðŸ“ˆ"; }
.rt-graph-sub{ opacity: 0.92; }
.rt-graph-sub .legend-item{ display:flex; align-items:center; gap:6px; margin-right:10px; }
.rt-graph-dot{ box-shadow: 0 0 18px rgba(255,255,255,0.10); }

/* Gauge: nicer RemoteXY-like arc + ticks */
.rt-gauge-wrap{ position: relative; overflow: hidden; }
.rt-gauge-wrap::before{
  content:"";
  position:absolute; inset:0;
  background: radial-gradient(circle at 50% 40%, rgba(255,255,255,0.10), rgba(0,0,0,0) 60%);
  pointer-events:none;
}
.rt-gauge-svg{ max-height: 130px; }
.rt-gauge-center{ display:flex; flex-direction:column; align-items:center; gap:2px; }
.rt-gauge-value{ font-size: 1.2rem; }
.rt-gauge-emoji{ font-size: 1.05rem; margin-bottom: -2px; }

/* Toast */
.toast { position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%); padding: 16px 32px; background: var(--card); border: 3px solid var(--accent); border-radius: 30px; font-weight: 700; font-size: 1rem; transition: 0.3s; z-index: 1000; }
.toast.show { bottom: 30px; }
.toast.success { border-color: var(--green); color: var(--green); }
.toast.error { border-color: var(--red); color: var(--red); }

/* Modal */
.modal-bg { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 200; align-items: center; justify-content: center; padding: 20px; }
.modal-bg.show { display: flex; }
.modal { background: var(--surface); border: 3px solid var(--accent); border-radius: 24px; padding: 24px;  width: 100%; max-height: 85vh; overflow-y: auto; }
.modal-title { font-size: 1.4rem; font-weight: 800; color: var(--accent); margin-bottom: 16px; }
.modal-code { background: var(--card); padding: 16px; border-radius: 16px; font-family: 'Fira Code', 'Consolas', monospace; font-size: 0.8rem; max-height: 400px; overflow: auto; color: var(--green); white-space: pre-wrap; word-break: break-all; margin-bottom: 16px; line-height: 1.5; }
.modal-buttons { display: flex; gap: 10px; flex-wrap: wrap; }
.modal-btn { flex: 1; padding: 14px 20px; border: none; border-radius: 16px; font-weight: 700; cursor: pointer; }
.modal-btn.primary { background: linear-gradient(135deg, var(--accent), var(--purple)); color: #000; }
.modal-btn.secondary { background: var(--card); color: var(--text); }

/* Template Modal */
.template-modal { position: fixed; inset: 0; background: rgba(26,26,46,0.98); z-index: 100; display: flex; padding-top: 120px; box-sizing: border-box; align-items: center; justify-content: center; padding: 20px; }
.template-modal.hidden { display: none; }
.template-content { text-align: center;  width: 100%; }
.template-content h2 { font-size: 1.8rem; margin-bottom: 10px; background: linear-gradient(90deg, var(--accent), var(--pink)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
.template-content p { color: var(--text-dim); margin-bottom: 24px; font-size: 1rem; }
.templates-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
.template-card { background: var(--card); border: 3px solid transparent; border-radius: 20px; padding: 20px 10px; cursor: pointer; transition: 0.2s; }
.template-card:hover { border-color: var(--accent); transform: scale(1.05); }
.template-card:active { transform: scale(0.95); }
.template-icon { font-size: 3rem; margin-bottom: 10px; }
.template-name { font-weight: 700; font-size: 0.9rem; }

/* Responsive */
@media (min-width: 768px) {
  .builder-view { flex-direction: row; }
  .palette { flex-direction: column;  border-top: none; border-right: 2px solid var(--card); order: 0; overflow-y: auto; overflow-x: visible; }
  .canvas-wrap { order: 0; }
  .palette-item { width: 100%; min-width: unset; }
}
@media (max-width: 500px) {
  .logo { font-size: 1rem; }
  .tab { padding: 8px 14px; font-size: 0.8rem; }
  .ble-btn span:last-child { display: none; }
  .templates-grid { grid-template-columns: repeat(2, 1fr); }
  .template-icon { font-size: 2.2rem; }
  .header-btn { padding: 10px 14px; font-size: 0.75rem; }
}

/* Properties Panel */
.props-panel{
  background: var(--surface);
  border-left: 2px solid var(--card);
  padding: 12px;
  
  min-
  display: flex;
  flex-direction: column;
  gap: 10px;
}
.props-title{ font-weight: 800; color: var(--accent); }
.props-empty{ color: var(--text-dim); font-weight: 600; font-size: 0.9rem; }

.props-form label{
  display:block;
  margin-top: 10px;
  font-size: 0.8rem;
  color: var(--text-dim);
  font-weight: 800;
  text-transform: uppercase;
}
.props-form input, .props-form select{
  width: 100%;
  margin-top: 6px;
  padding: 10px 12px;
  border-radius: 14px;
  border: 2px solid transparent;
  background: var(--card);
  color: var(--text);
  font-weight: 700;
}
.props-form input:focus, .props-form select:focus{
  outline: none;
  border-color: var(--accent);
}

@media (max-width: 768px){
  .props-panel{
    width: 100%;
    border-left: none;
    border-top: 2px solid var(--card);
  }
}


/* RTL support (Arabic) */
body.rtl { direction: rtl; }
body.rtl header, body.rtl .builder-header, body.rtl .palette, body.rtl .props-panel, body.rtl .modal { direction: rtl; }
body.rtl .tabs { direction: ltr; } /* keep tab order */
body.rtl .modal-code { direction: ltr; } /* code stays LTR */


/* ===== Hero header (Serial Logger style) ===== */
.hero-header{
  position: sticky;
  top: 0;
  z-index: 300;
  padding: 14px 18px;
  background: transparent;
}
.hero-inner{
  
  margin: 0 auto;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:16px;
  padding: 14px 18px;
  border-radius: 18px;
  border: 1px solid rgba(255,255,255,.10);
  background: linear-gradient(180deg, rgba(12,24,54,.92), rgba(8,16,40,.88));
  box-shadow:
    0 16px 40px rgba(0,0,0,.40),
    inset 0 1px 0 rgba(255,255,255,.06);
  backdrop-filter: blur(10px);
}
.hero-left{
  display:flex;
  align-items:center;
  gap:14px;
  min-
}
.hero-logo{
  
  height: 56px;
  border-radius: 14px;
  display:flex;
  align-items:center;
  justify-content:center;
  background: rgba(255,255,255,.05);
  border: 1px solid rgba(255,255,255,.08);
  box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
  overflow:hidden;
}
.hero-logo svg{
  
  height: 54px;
}
.hero-titles{
  display:flex;
  flex-direction:column;
  gap:4px;
}
.hero-title{
  letter-spacing: .16em;
  font-weight: 900;
  font-size: 20px;
  color: #ffbf3a;
  text-transform: uppercase;
  line-height: 1.1;
}
.hero-subtitle{
  font-size: 13px;
  color: rgba(255,255,255,.75);
  line-height: 1.2;
}
.hero-center{
  flex: 1;
  display:flex;
  justify-content:center;
}
.bismillah{
  font-size: 12px;
  color: rgba(255,255,255,.45);
  padding: 6px 10px;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,.08);
  background: rgba(255,255,255,.03);
  
  text-align:center;
  white-space: nowrap;
  overflow:hidden;
  text-overflow: ellipsis;
}
.hero-right{
  display:flex;
  align-items:center;
  gap:10px;
}
.hero-pill{
  display:flex;
  align-items:center;
  gap:8px;
  padding: 9px 12px;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,.10);
  background: rgba(255,255,255,.04);
  color: rgba(255,255,255,.90);
  cursor:pointer;
  user-select:none;
  box-shadow: inset 0 1px 0 rgba(255,255,255,.05);
}
.hero-pill:hover{ background: rgba(255,255,255,.06); }
.pill-dot{
  
  height: 10px;
  border-radius: 50%;
  background: rgba(255,255,255,.35);
  box-shadow: 0 0 0 3px rgba(255,255,255,.06);
}
.hero-pill-ble .pill-dot{ background: rgba(255,80,80,.85); }
.hero-pill-ble.connected .pill-dot{ background: rgba(63,220,125,.90); }
.hero-pill-sound.connected .pill-dot{ background: rgba(0,200,255,.85); }
.hero-pill-lang .pill-dot{ background: rgba(170,120,255,.85); }
.pill-text{ font-weight: 700; font-size: 12px; }

/* Responsive */
@media (max-width: 900px){
  .hero-center{ display:none; }
  .hero-left{ min- }
  .hero-title{ font-size: 16px; }
}
@media (max-width: 620px){
  .hero-subtitle{ display:none; }
  .hero-inner{ padding: 12px 12px; }
  .hero-logo{  height:46px; }
  .hero-logo svg{  height:44px; }
  .pill-text{ display:none; }
  .hero-pill{ padding: 9px 10px; }
}


/* Fun kid animations */
@keyframes rainbowShift {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}
@keyframes logoWiggle {
  0%,100% { transform: rotate(-2deg) scale(1); }
  25% { transform: rotate(3deg) scale(1.03); }
  50% { transform: rotate(-4deg) scale(1.06); }
  75% { transform: rotate(2deg) scale(1.03); }
}
@keyframes popBounce {
  0% { transform: translateY(0); }
  40% { transform: translateY(-4px); }
  70% { transform: translateY(1px); }
  100% { transform: translateY(0); }
}

.hero-logo { animation: logoWiggle 3.2s ease-in-out infinite; }
.hero-title{
  background: linear-gradient(90deg, #ffbf3a, #00c8ff, #aa78ff, #3fdc7d, #ff5a8a, #ffbf3a);
  background-size: 350% 350%;
  -webkit-background-clip: text;
  background-clip: text;
  color: transparent;
  text-shadow: 0 10px 30px rgba(0,0,0,.25);
  animation: rainbowShift 5s ease-in-out infinite, popBounce 2.4s ease-in-out infinite;
}
.hero-subtitle{
  background: linear-gradient(90deg, rgba(255,255,255,.85), rgba(255,255,255,.55));
  -webkit-background-clip: text;
  background-clip: text;
  color: transparent;
}
.hero-logo svg { filter: drop-shadow(0 10px 18px rgba(0,0,0,.35)); }
@media (prefers-reduced-motion: reduce){
  .hero-logo, .hero-title { animation: none !important; }
}


.hero-tabs{ margin-top: 8px; display:flex; gap:8px; }
.hero-tabs .tab{
  padding: 8px 12px;
  border-radius: 999px;
  font-size: 12px;
  font-weight: 800;
}


/* === Safe overrides so external style.css won't break header controls === */
.serial-header-safe button{
  border-radius: 999px !important;
}
.serial-header-safe .hero-pill{
  border-radius: 999px !important;
  border: 1px solid rgba(255,255,255,.10) !important;
  background: rgba(255,255,255,.04) !important;
  color: rgba(255,255,255,.90) !important;
}
.serial-header-safe .hero-tabs .tab{
  border-radius: 999px !important;
  border: 1px solid rgba(255,255,255,.14) !important;
  background: rgba(255,255,255,.05) !important;
  color: rgba(255,255,255,.90) !important;
}
.serial-header-safe .hero-tabs .tab.active{
  background: rgba(255,255,255,.10) !important;
  box-shadow: 0 0 0 1px rgba(255,255,255,.10) inset !important;
}


/* ===== Flexible canvas width ===== */
.canvas,
#canvas,
.board,
.builder-canvas{
  width: 100%;
  max-width: 100%;
  min-width: 280px;
}

.builder-layout,
.main-layout{
  display: flex;
  justify-content: center;
  align-items: stretch;
}

@media (min-width: 900px){
  .canvas,
  #canvas,
  .board,
  .builder-canvas{
    max-width: 780px; /* soft limit like before */
  }
}


/* ===== Canvas flexibility (builder screen) ===== */
/* Make the center column flexible and allow the canvas to grow */
.builder-main, .main, .main-content, .builder-content, .builder-area, .center-panel, .center-col {
  flex: 1 1 auto;
  min-width: 0; /* prevents overflow forcing scroll */
}

/* Target the dashed canvas container and its inner board */
.canvas-dropzone, .dropzone, .board-drop, .canvas-wrap, .canvas-container, .canvas-frame {
  width: 100% !important;
  max-width: none !important;
  min-width: 320px;
  box-sizing: border-box;
}

.canvas-dropzone *, .dropzone *, .board-drop * {
  box-sizing: border-box;
}

/* If there's an inner scrolling element, disable it */
.canvas-dropzone, .dropzone, .board-drop, .canvas-wrap, .canvas-container, .canvas-frame {
  overflow: visible !important;
}

/* Actual board element (where widgets are placed) */
#canvasBoard, #board, .board, .canvas, .builder-canvas {
  width: 100% !important;
  max-width: none !important;
  min-width: 320px;
}

/* Remove forced fixed sizes if any were applied inline */
#canvasBoard, #board, .board, .canvas, .builder-canvas {
  height: auto !important;
}

/* Keep a soft max width only on very large screens so it still looks nice */
@media (min-width: 1200px){
  #canvasBoard, #board, .board, .canvas, .builder-canvas {
    max-width: 980px !important;
    margin-left: auto;
    margin-right: auto;
  }
}


/* ===== Resizable builder canvas (drag corner) ===== */
.resizable-wrap{
  position: relative;
  width: min(100%, 980px);
  height: 520px;
  max-width: 100%;
  border-radius: 18px;
}
@media (max-width: 700px){
  .resizable-wrap{ height: 460px; }
}
.canvas-resizer{
  position:absolute;
  width: 18px;
  height: 18px;
  right: 10px;
  bottom: 10px;
  border-radius: 6px;
  background: rgba(255,255,255,.18);
  border: 1px solid rgba(255,255,255,.25);
  cursor: nwse-resize;
  box-shadow: 0 10px 18px rgba(0,0,0,.25);
}
.canvas-resizer:after{
  content:'';
  position:absolute;
  right:4px; bottom:4px;
  width: 8px; height: 8px;
  border-right: 2px solid rgba(255,255,255,.65);
  border-bottom: 2px solid rgba(255,255,255,.65);
  border-radius: 1px;
  opacity:.9;
}
.canvas-size-badge{
  position:absolute;
  left: 12px;
  bottom: 10px;
  padding: 6px 10px;
  border-radius: 999px;
  font-size: 11px;
  font-weight: 800;
  color: rgba(255,255,255,.85);
  background: rgba(0,0,0,.22);
  border: 1px solid rgba(255,255,255,.12);
  user-select:none;
}

</style>

<style>
.vertical-toolbar{
  display:flex;
  flex-direction:column;
  gap:10px;
  background:rgba(20,40,80,0.85);
  padding:12px;
  border-radius:16px;
  box-shadow:0 10px 30px rgba(0,0,0,.35);
}
.vertical-toolbar button{
  width:100%;
}

/* ===== Hero header (Serial Logger style) ===== */
.hero-header{
  position: sticky;
  top: 0;
  z-index: 50;
  padding: 14px 18px;
  background: transparent;
}
.hero-inner{
  
  margin: 0 auto;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:16px;
  padding: 14px 18px;
  border-radius: 18px;
  border: 1px solid rgba(255,255,255,.10);
  background: linear-gradient(180deg, rgba(12,24,54,.92), rgba(8,16,40,.88));
  box-shadow:
    0 16px 40px rgba(0,0,0,.40),
    inset 0 1px 0 rgba(255,255,255,.06);
  backdrop-filter: blur(10px);
}
.hero-left{
  display:flex;
  align-items:center;
  gap:14px;
  min-
}
.hero-logo{
  
  height: 56px;
  border-radius: 14px;
  display:flex;
  align-items:center;
  justify-content:center;
  background: rgba(255,255,255,.05);
  border: 1px solid rgba(255,255,255,.08);
  box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
  overflow:hidden;
}
.hero-logo svg{
  
  height: 54px;
}
.hero-titles{
  display:flex;
  flex-direction:column;
  gap:4px;
}
.hero-title{
  letter-spacing: .16em;
  font-weight: 900;
  font-size: 20px;
  color: #ffbf3a;
  text-transform: uppercase;
  line-height: 1.1;
}
.hero-subtitle{
  font-size: 13px;
  color: rgba(255,255,255,.75);
  line-height: 1.2;
}
.hero-center{
  flex: 1;
  display:flex;
  justify-content:center;
}
.bismillah{
  font-size: 12px;
  color: rgba(255,255,255,.45);
  padding: 6px 10px;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,.08);
  background: rgba(255,255,255,.03);
  
  text-align:center;
  white-space: nowrap;
  overflow:hidden;
  text-overflow: ellipsis;
}
.hero-right{
  display:flex;
  align-items:center;
  gap:10px;
}
.hero-pill{
  display:flex;
  align-items:center;
  gap:8px;
  padding: 9px 12px;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,.10);
  background: rgba(255,255,255,.04);
  color: rgba(255,255,255,.90);
  cursor:pointer;
  user-select:none;
  box-shadow: inset 0 1px 0 rgba(255,255,255,.05);
}
.hero-pill:hover{ background: rgba(255,255,255,.06); }
.pill-dot{
  
  height: 10px;
  border-radius: 50%;
  background: rgba(255,255,255,.35);
  box-shadow: 0 0 0 3px rgba(255,255,255,.06);
}
.hero-pill-ble .pill-dot{ background: rgba(255,80,80,.85); }
.hero-pill-ble.connected .pill-dot{ background: rgba(63,220,125,.90); }
.hero-pill-sound.connected .pill-dot{ background: rgba(0,200,255,.85); }
.hero-pill-lang .pill-dot{ background: rgba(170,120,255,.85); }
.pill-text{ font-weight: 700; font-size: 12px; }

/* Responsive */
@media (max-width: 900px){
  .hero-center{ display:none; }
  .hero-left{ min- }
  .hero-title{ font-size: 16px; }
}
@media (max-width: 620px){
  .hero-subtitle{ display:none; }
  .hero-inner{ padding: 12px 12px; }
  .hero-logo{  height:46px; }
  .hero-logo svg{  height:44px; }
  .pill-text{ display:none; }
  .hero-pill{ padding: 9px 10px; }
}


/* Fun kid animations */
@keyframes rainbowShift {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}
@keyframes logoWiggle {
  0%,100% { transform: rotate(-2deg) scale(1); }
  25% { transform: rotate(3deg) scale(1.03); }
  50% { transform: rotate(-4deg) scale(1.06); }
  75% { transform: rotate(2deg) scale(1.03); }
}
@keyframes popBounce {
  0% { transform: translateY(0); }
  40% { transform: translateY(-4px); }
  70% { transform: translateY(1px); }
  100% { transform: translateY(0); }
}

.hero-logo { animation: logoWiggle 3.2s ease-in-out infinite; }
.hero-title{
  background: linear-gradient(90deg, #ffbf3a, #00c8ff, #aa78ff, #3fdc7d, #ff5a8a, #ffbf3a);
  background-size: 350% 350%;
  -webkit-background-clip: text;
  background-clip: text;
  color: transparent;
  text-shadow: 0 10px 30px rgba(0,0,0,.25);
  animation: rainbowShift 5s ease-in-out infinite, popBounce 2.4s ease-in-out infinite;
}
.hero-subtitle{
  background: linear-gradient(90deg, rgba(255,255,255,.85), rgba(255,255,255,.55));
  -webkit-background-clip: text;
  background-clip: text;
  color: transparent;
}
.hero-logo svg { filter: drop-shadow(0 10px 18px rgba(0,0,0,.35)); }
@media (prefers-reduced-motion: reduce){
  .hero-logo, .hero-title { animation: none !important; }
}


.hero-tabs{ margin-top: 8px; display:flex; gap:8px; }
.hero-tabs .tab{
  padding: 8px 12px;
  border-radius: 999px;
  font-size: 12px;
  font-weight: 800;
}


/* === Safe overrides so external style.css won't break header controls === */
.serial-header-safe button{
  border-radius: 999px !important;
}
.serial-header-safe .hero-pill{
  border-radius: 999px !important;
  border: 1px solid rgba(255,255,255,.10) !important;
  background: rgba(255,255,255,.04) !important;
  color: rgba(255,255,255,.90) !important;
}
.serial-header-safe .hero-tabs .tab{
  border-radius: 999px !important;
  border: 1px solid rgba(255,255,255,.14) !important;
  background: rgba(255,255,255,.05) !important;
  color: rgba(255,255,255,.90) !important;
}
.serial-header-safe .hero-tabs .tab.active{
  background: rgba(255,255,255,.10) !important;
  box-shadow: 0 0 0 1px rgba(255,255,255,.10) inset !important;
}


/* ===== Flexible canvas width ===== */
.canvas,
#canvas,
.board,
.builder-canvas{
  width: 100%;
  max-width: 100%;
  min-width: 280px;
}

.builder-layout,
.main-layout{
  display: flex;
  justify-content: center;
  align-items: stretch;
}

@media (min-width: 900px){
  .canvas,
  #canvas,
  .board,
  .builder-canvas{
    max-width: 780px; /* soft limit like before */
  }
}


/* ===== Canvas flexibility (builder screen) ===== */
/* Make the center column flexible and allow the canvas to grow */
.builder-main, .main, .main-content, .builder-content, .builder-area, .center-panel, .center-col {
  flex: 1 1 auto;
  min-width: 0; /* prevents overflow forcing scroll */
}

/* Target the dashed canvas container and its inner board */
.canvas-dropzone, .dropzone, .board-drop, .canvas-wrap, .canvas-container, .canvas-frame {
  width: 100% !important;
  max-width: none !important;
  min-width: 320px;
  box-sizing: border-box;
}

.canvas-dropzone *, .dropzone *, .board-drop * {
  box-sizing: border-box;
}

/* If there's an inner scrolling element, disable it */
.canvas-dropzone, .dropzone, .board-drop, .canvas-wrap, .canvas-container, .canvas-frame {
  overflow: visible !important;
}

/* Actual board element (where widgets are placed) */
#canvasBoard, #board, .board, .canvas, .builder-canvas {
  width: 100% !important;
  max-width: none !important;
  min-width: 320px;
}

/* Remove forced fixed sizes if any were applied inline */
#canvasBoard, #board, .board, .canvas, .builder-canvas {
  height: auto !important;
}

/* Keep a soft max width only on very large screens so it still looks nice */
@media (min-width: 1200px){
  #canvasBoard, #board, .board, .canvas, .builder-canvas {
    max-width: 980px !important;
    margin-left: auto;
    margin-right: auto;
  }
}


/* ===== Resizable builder canvas (drag corner) ===== */
.resizable-wrap{
  position: relative;
  width: min(100%, 980px);
  height: 520px;
  max-width: 100%;
  border-radius: 18px;
}
@media (max-width: 700px){
  .resizable-wrap{ height: 460px; }
}
.canvas-resizer{
  position:absolute;
  width: 18px;
  height: 18px;
  right: 10px;
  bottom: 10px;
  border-radius: 6px;
  background: rgba(255,255,255,.18);
  border: 1px solid rgba(255,255,255,.25);
  cursor: nwse-resize;
  box-shadow: 0 10px 18px rgba(0,0,0,.25);
}
.canvas-resizer:after{
  content:'';
  position:absolute;
  right:4px; bottom:4px;
  width: 8px; height: 8px;
  border-right: 2px solid rgba(255,255,255,.65);
  border-bottom: 2px solid rgba(255,255,255,.65);
  border-radius: 1px;
  opacity:.9;
}
.canvas-size-badge{
  position:absolute;
  left: 12px;
  bottom: 10px;
  padding: 6px 10px;
  border-radius: 999px;
  font-size: 11px;
  font-weight: 800;
  color: rgba(255,255,255,.85);
  background: rgba(0,0,0,.22);
  border: 1px solid rgba(255,255,255,.12);
  user-select:none;
}

</style>


<style>
/* Action buttons card (kids-friendly) */
.builder-header{display:flex;align-items:flex-start;gap:14px;justify-content:flex-start;}
.action-card{
  display:flex;
  flex-direction:column;
  gap:10px;
  background:rgba(20,40,80,0.85);
  padding:12px;
  border-radius:16px;
  box-shadow:0 10px 30px rgba(0,0,0,.35);
}
.action-card .header-btn{justify-content:center;}
@media (max-width: 900px){
  .action-card .header-btn{}
}

/* ===== Hero header (Serial Logger style) ===== */
.hero-header{
  position: sticky;
  top: 0;
  z-index: 50;
  padding: 14px 18px;
  background: transparent;
}
.hero-inner{
  
  margin: 0 auto;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:16px;
  padding: 14px 18px;
  border-radius: 18px;
  border: 1px solid rgba(255,255,255,.10);
  background: linear-gradient(180deg, rgba(12,24,54,.92), rgba(8,16,40,.88));
  box-shadow:
    0 16px 40px rgba(0,0,0,.40),
    inset 0 1px 0 rgba(255,255,255,.06);
  backdrop-filter: blur(10px);
}
.hero-left{
  display:flex;
  align-items:center;
  gap:14px;
  min-
}
.hero-logo{
  
  height: 56px;
  border-radius: 14px;
  display:flex;
  align-items:center;
  justify-content:center;
  background: rgba(255,255,255,.05);
  border: 1px solid rgba(255,255,255,.08);
  box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
  overflow:hidden;
}
.hero-logo svg{
  
  height: 54px;
}
.hero-titles{
  display:flex;
  flex-direction:column;
  gap:4px;
}
.hero-title{
  letter-spacing: .16em;
  font-weight: 900;
  font-size: 20px;
  color: #ffbf3a;
  text-transform: uppercase;
  line-height: 1.1;
}
.hero-subtitle{
  font-size: 13px;
  color: rgba(255,255,255,.75);
  line-height: 1.2;
}
.hero-center{
  flex: 1;
  display:flex;
  justify-content:center;
}
.bismillah{
  font-size: 12px;
  color: rgba(255,255,255,.45);
  padding: 6px 10px;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,.08);
  background: rgba(255,255,255,.03);
  
  text-align:center;
  white-space: nowrap;
  overflow:hidden;
  text-overflow: ellipsis;
}
.hero-right{
  display:flex;
  align-items:center;
  gap:10px;
}
.hero-pill{
  display:flex;
  align-items:center;
  gap:8px;
  padding: 9px 12px;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,.10);
  background: rgba(255,255,255,.04);
  color: rgba(255,255,255,.90);
  cursor:pointer;
  user-select:none;
  box-shadow: inset 0 1px 0 rgba(255,255,255,.05);
}
.hero-pill:hover{ background: rgba(255,255,255,.06); }
.pill-dot{
  
  height: 10px;
  border-radius: 50%;
  background: rgba(255,255,255,.35);
  box-shadow: 0 0 0 3px rgba(255,255,255,.06);
}
.hero-pill-ble .pill-dot{ background: rgba(255,80,80,.85); }
.hero-pill-ble.connected .pill-dot{ background: rgba(63,220,125,.90); }
.hero-pill-sound.connected .pill-dot{ background: rgba(0,200,255,.85); }
.hero-pill-lang .pill-dot{ background: rgba(170,120,255,.85); }
.pill-text{ font-weight: 700; font-size: 12px; }

/* Responsive */
@media (max-width: 900px){
  .hero-center{ display:none; }
  .hero-left{ min- }
  .hero-title{ font-size: 16px; }
}
@media (max-width: 620px){
  .hero-subtitle{ display:none; }
  .hero-inner{ padding: 12px 12px; }
  .hero-logo{  height:46px; }
  .hero-logo svg{  height:44px; }
  .pill-text{ display:none; }
  .hero-pill{ padding: 9px 10px; }
}


/* Fun kid animations */
@keyframes rainbowShift {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}
@keyframes logoWiggle {
  0%,100% { transform: rotate(-2deg) scale(1); }
  25% { transform: rotate(3deg) scale(1.03); }
  50% { transform: rotate(-4deg) scale(1.06); }
  75% { transform: rotate(2deg) scale(1.03); }
}
@keyframes popBounce {
  0% { transform: translateY(0); }
  40% { transform: translateY(-4px); }
  70% { transform: translateY(1px); }
  100% { transform: translateY(0); }
}

.hero-logo { animation: logoWiggle 3.2s ease-in-out infinite; }
.hero-title{
  background: linear-gradient(90deg, #ffbf3a, #00c8ff, #aa78ff, #3fdc7d, #ff5a8a, #ffbf3a);
  background-size: 350% 350%;
  -webkit-background-clip: text;
  background-clip: text;
  color: transparent;
  text-shadow: 0 10px 30px rgba(0,0,0,.25);
  animation: rainbowShift 5s ease-in-out infinite, popBounce 2.4s ease-in-out infinite;
}
.hero-subtitle{
  background: linear-gradient(90deg, rgba(255,255,255,.85), rgba(255,255,255,.55));
  -webkit-background-clip: text;
  background-clip: text;
  color: transparent;
}
.hero-logo svg { filter: drop-shadow(0 10px 18px rgba(0,0,0,.35)); }
@media (prefers-reduced-motion: reduce){
  .hero-logo, .hero-title { animation: none !important; }
}


.hero-tabs{ margin-top: 8px; display:flex; gap:8px; }
.hero-tabs .tab{
  padding: 8px 12px;
  border-radius: 999px;
  font-size: 12px;
  font-weight: 800;
}


/* === Safe overrides so external style.css won't break header controls === */
.serial-header-safe button{
  border-radius: 999px !important;
}
.serial-header-safe .hero-pill{
  border-radius: 999px !important;
  border: 1px solid rgba(255,255,255,.10) !important;
  background: rgba(255,255,255,.04) !important;
  color: rgba(255,255,255,.90) !important;
}
.serial-header-safe .hero-tabs .tab{
  border-radius: 999px !important;
  border: 1px solid rgba(255,255,255,.14) !important;
  background: rgba(255,255,255,.05) !important;
  color: rgba(255,255,255,.90) !important;
}
.serial-header-safe .hero-tabs .tab.active{
  background: rgba(255,255,255,.10) !important;
  box-shadow: 0 0 0 1px rgba(255,255,255,.10) inset !important;
}


/* ===== Flexible canvas width ===== */
.canvas,
#canvas,
.board,
.builder-canvas{
  width: 100%;
  max-width: 100%;
  min-width: 280px;
}

.builder-layout,
.main-layout{
  display: flex;
  justify-content: center;
  align-items: stretch;
}

@media (min-width: 900px){
  .canvas,
  #canvas,
  .board,
  .builder-canvas{
    max-width: 780px; /* soft limit like before */
  }
}


/* ===== Canvas flexibility (builder screen) ===== */
/* Make the center column flexible and allow the canvas to grow */
.builder-main, .main, .main-content, .builder-content, .builder-area, .center-panel, .center-col {
  flex: 1 1 auto;
  min-width: 0; /* prevents overflow forcing scroll */
}

/* Target the dashed canvas container and its inner board */
.canvas-dropzone, .dropzone, .board-drop, .canvas-wrap, .canvas-container, .canvas-frame {
  width: 100% !important;
  max-width: none !important;
  min-width: 320px;
  box-sizing: border-box;
}

.canvas-dropzone *, .dropzone *, .board-drop * {
  box-sizing: border-box;
}

/* If there's an inner scrolling element, disable it */
.canvas-dropzone, .dropzone, .board-drop, .canvas-wrap, .canvas-container, .canvas-frame {
  overflow: visible !important;
}

/* Actual board element (where widgets are placed) */
#canvasBoard, #board, .board, .canvas, .builder-canvas {
  width: 100% !important;
  max-width: none !important;
  min-width: 320px;
}

/* Remove forced fixed sizes if any were applied inline */
#canvasBoard, #board, .board, .canvas, .builder-canvas {
  height: auto !important;
}

/* Keep a soft max width only on very large screens so it still looks nice */
@media (min-width: 1200px){
  #canvasBoard, #board, .board, .canvas, .builder-canvas {
    max-width: 980px !important;
    margin-left: auto;
    margin-right: auto;
  }
}


/* ===== Resizable builder canvas (drag corner) ===== */
.resizable-wrap{
  position: relative;
  width: min(100%, 980px);
  height: 520px;
  max-width: 100%;
  border-radius: 18px;
}
@media (max-width: 700px){
  .resizable-wrap{ height: 460px; }
}
.canvas-resizer{
  position:absolute;
  width: 18px;
  height: 18px;
  right: 10px;
  bottom: 10px;
  border-radius: 6px;
  background: rgba(255,255,255,.18);
  border: 1px solid rgba(255,255,255,.25);
  cursor: nwse-resize;
  box-shadow: 0 10px 18px rgba(0,0,0,.25);
}
.canvas-resizer:after{
  content:'';
  position:absolute;
  right:4px; bottom:4px;
  width: 8px; height: 8px;
  border-right: 2px solid rgba(255,255,255,.65);
  border-bottom: 2px solid rgba(255,255,255,.65);
  border-radius: 1px;
  opacity:.9;
}
.canvas-size-badge{
  position:absolute;
  left: 12px;
  bottom: 10px;
  padding: 6px 10px;
  border-radius: 999px;
  font-size: 11px;
  font-weight: 800;
  color: rgba(255,255,255,.85);
  background: rgba(0,0,0,.22);
  border: 1px solid rgba(255,255,255,.12);
  user-select:none;
}

</style>

</head>
<body>
<div class="app">
  
<header class="hero-header serial-header-safe">
  <div class="hero-inner">
    <div class="hero-left">
      <div class="hero-logo" aria-label="Logo">
        <?xml version="1.0" encoding="UTF-8" standalone="no"?>
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="6.000mm" height="3.214mm" viewBox="-92.820084 179.975632 6.000000 3.214096">
    <path style="stroke:none;fill:#007BFF;fill-rule:evenodd" d="M-90.26918,180.70665C-90.270096,180.703674,-90.280693,180.55484,-90.292725,180.3759C-90.304756,180.19696,-90.315605,180.042282,-90.316826,180.032166L-90.319046,180.013763L-90.29628,180.013763C-90.283752,180.013748,-90.25869,180.012115,-90.240585,180.010117C-90.222481,180.008118,-90.191841,180.005646,-90.172501,180.004608L-90.137344,180.002731L-90.128738,180.131226C-90.124008,180.201889,-90.119133,180.269699,-90.117897,180.281921L-90.115662,180.304123L-90.05497,180.20639C-90.021591,180.152634,-89.977379,180.08139,-89.956726,180.048065L-89.919182,179.987488L-89.883324,179.985062C-89.863602,179.983734,-89.824806,179.980759,-89.797112,179.978455C-89.769424,179.976166,-89.739342,179.974884,-89.73027,179.975632L-89.713783,179.976974L-89.825653,180.145996L-89.937531,180.315033L-89.796638,180.490601C-89.719147,180.587158,-89.655746,180.667526,-89.655746,180.669174C-89.655746,180.670837,-89.657356,180.672195,-89.659317,180.672195C-89.676155,180.672195,-89.856628,180.684464,-89.861404,180.685928C-89.865883,180.687317,-89.896164,180.651016,-89.971275,180.554199C-90.028305,180.480698,-90.076393,180.421448,-90.07814,180.422516C-90.079887,180.423599,-90.086746,180.433975,-90.093384,180.445587L-90.105461,180.466675L-90.097374,180.581726C-90.091408,180.66658,-90.090439,180.697479,-90.093674,180.699478C-90.099167,180.702866,-90.137032,180.7061,-90.21048,180.709442C-90.257515,180.711578,-90.267807,180.71109,-90.26918,180.70665z"/>
    <path style="stroke:none;fill:#007BFF;fill-rule:evenodd" d="M-89.190971,180.7686C-89.267868,180.753281,-89.31105,180.739975,-89.360039,180.716522C-89.393906,180.700302,-89.471527,180.651245,-89.480576,180.640335C-89.484718,180.635345,-89.482971,180.627808,-89.446373,180.493073C-89.44014,180.470108,-89.428429,180.473007,-89.40416,180.50351C-89.35006,180.571503,-89.267303,180.622406,-89.189331,180.635666C-89.152946,180.641846,-89.149734,180.641846,-89.129295,180.635406C-89.09346,180.624115,-89.075447,180.597748,-89.081604,180.565582C-89.085762,180.543793,-89.121902,180.514221,-89.183189,180.482422C-89.254944,180.44519,-89.27681,180.430908,-89.309555,180.399933C-89.365524,180.347,-89.382957,180.291809,-89.367203,180.217453C-89.349838,180.135468,-89.298691,180.084976,-89.207352,180.059616C-89.16906,180.048981,-89.099213,180.048294,-89.053474,180.058105C-88.98037,180.073776,-88.906212,180.104935,-88.843803,180.14621C-88.810745,180.16806,-88.807495,180.171295,-88.809486,180.180176C-88.810699,180.185577,-88.820007,180.220505,-88.830177,180.257782C-88.847977,180.323044,-88.849014,180.325516,-88.858116,180.324509C-88.863312,180.323944,-88.870895,180.31871,-88.874962,180.312897C-88.886063,180.297012,-88.932678,180.252243,-88.951851,180.239044C-89.003326,180.203629,-89.07032,180.181305,-89.113388,180.185211C-89.166359,180.190018,-89.195839,180.22757,-89.177078,180.266357C-89.168106,180.284912,-89.14418,180.302139,-89.078835,180.337082C-88.97522,180.392517,-88.924667,180.434921,-88.900993,180.486298C-88.888092,180.514282,-88.885109,180.566086,-88.894295,180.602661C-88.921547,180.711212,-89.010704,180.773865,-89.135971,180.772491C-89.156639,180.772263,-89.181389,180.770508,-89.190971,180.7686z"/>
    <path style="stroke:none;fill:#007BFF;fill-rule:evenodd" d="M-91.104111,180.90361C-91.134857,180.834915,-91.198944,180.691757,-91.246529,180.585495C-91.294121,180.479233,-91.332542,180.391785,-91.331917,180.391159C-91.330269,180.389511,-91.248558,180.352615,-91.135277,180.302368C-91.080956,180.278275,-91.021782,180.253952,-91.003784,180.248306C-90.923584,180.22316,-90.848717,180.234344,-90.799507,180.278824C-90.775833,180.300217,-90.757965,180.329971,-90.742996,180.372955C-90.732986,180.401703,-90.731194,180.412506,-90.731262,180.44368C-90.731339,180.474075,-90.733147,180.485123,-90.741638,180.507187C-90.753166,180.53714,-90.772163,180.572006,-90.780914,180.579269C-90.784096,180.581909,-90.786697,180.585449,-90.786697,180.587128C-90.786697,180.590454,-90.750763,180.609756,-90.581421,180.697388C-90.520706,180.72879,-90.466957,180.757034,-90.461975,180.760147C-90.4533,180.765549,-90.456924,180.767578,-90.547188,180.807983C-90.599037,180.831192,-90.645187,180.85022,-90.64975,180.850266C-90.654312,180.850327,-90.720131,180.816483,-90.796013,180.775055L-90.933975,180.699768L-90.960068,180.711792C-90.974419,180.718399,-90.986549,180.72406,-90.987015,180.72435C-90.987488,180.724655,-90.965302,180.775085,-90.937721,180.836411C-90.910133,180.897751,-90.887093,180.950424,-90.886513,180.953476C-90.885788,180.957291,-90.909706,180.96991,-90.96286,180.993774C-91.005432,181.012878,-91.042053,181.028519,-91.044235,181.028519C-91.046425,181.028519,-91.073364,180.972321,-91.104111,180.90361zM-90.99427,180.585632C-90.928116,180.554184,-90.903168,180.526901,-90.902977,180.485809C-90.902802,180.449066,-90.926598,180.406387,-90.953178,180.395752C-90.982254,180.384109,-91.00518,180.388504,-91.073784,180.418884C-91.095886,180.428665,-91.114441,180.437119,-91.115021,180.437668C-91.116417,180.439011,-91.04142,180.606354,-91.039421,180.606354C-91.038567,180.606354,-91.018242,180.597031,-90.99427,180.585632z"/>
    <path style="stroke:none;fill:#007BFF;fill-rule:evenodd" d="M-88.328873,181.18129C-88.367035,181.1548,-88.399017,181.132355,-88.399948,181.131424C-88.400887,181.130493,-88.36216,181.072723,-88.313889,181.003052C-88.265625,180.933365,-88.227539,180.875137,-88.229256,180.873642C-88.232262,180.871017,-88.36467,180.779251,-88.401207,180.754456L-88.418991,180.742401L-88.505783,180.867996C-88.55352,180.937073,-88.594093,180.993607,-88.59594,180.993622C-88.59967,180.993668,-88.741692,180.896652,-88.741692,180.894058C-88.741692,180.892731,-88.562958,180.634018,-88.382385,180.373978C-88.362411,180.345215,-88.344566,180.321136,-88.342712,180.320465C-88.340332,180.319611,-88.229614,180.393921,-88.196304,180.418747C-88.195633,180.41925,-88.226578,180.465042,-88.265076,180.520508C-88.303574,180.575974,-88.335899,180.623642,-88.336906,180.62645C-88.338058,180.629654,-88.30468,180.655014,-88.246178,180.695328C-88.195274,180.730423,-88.152,180.759674,-88.150009,180.76033C-88.148026,180.761002,-88.11441,180.715302,-88.075317,180.658768C-88.036224,180.602249,-88.002808,180.556,-88.00106,180.556C-87.996506,180.556,-87.856689,180.652924,-87.856689,180.656067C-87.856689,180.66153,-88.251923,181.229736,-88.255615,181.229599C-88.257751,181.229523,-88.29071,181.207779,-88.328873,181.18129z"/>
    <path style="stroke:none;fill:#007BFF;fill-rule:evenodd" d="M-91.754158,181.531448C-91.888771,181.512161,-92.043076,181.366882,-92.082649,181.222183C-92.093285,181.183273,-92.092499,181.109177,-92.081032,181.069366C-92.049042,180.958313,-91.935387,180.846329,-91.824692,180.816788C-91.785378,180.806305,-91.704155,180.807419,-91.663956,180.818985C-91.603546,180.836395,-91.54142,180.875549,-91.484215,180.932281C-91.430611,180.985458,-91.394707,181.040161,-91.374954,181.098755C-91.364899,181.128601,-91.362389,181.143066,-91.360794,181.18042C-91.358604,181.231888,-91.362877,181.260315,-91.379135,181.302338C-91.403221,181.364624,-91.466469,181.439941,-91.530434,181.482498C-91.598885,181.528046,-91.669739,181.543549,-91.754158,181.531448zM-91.605019,181.363525C-91.545914,181.336853,-91.511971,181.268951,-91.52636,181.206177C-91.548233,181.110733,-91.662498,180.996597,-91.760284,180.972504C-91.805176,180.961456,-91.846542,180.972488,-91.884094,181.005539C-91.904282,181.023315,-91.923706,181.059692,-91.92746,181.086777C-91.935303,181.143326,-91.900101,181.216187,-91.832245,181.283859C-91.751648,181.364258,-91.670021,181.392868,-91.605019,181.363525z"/>
    <path style="stroke:none;fill:#007BFF;fill-rule:evenodd" d="M-90.370827,181.625046C-90.382538,181.620316,-90.390862,181.606598,-90.416695,181.549454C-90.474388,181.421844,-90.474808,181.421082,-90.488495,181.41835C-90.495407,181.416962,-90.549316,181.415833,-90.608307,181.415833L-90.715553,181.415833L-90.723869,181.430634C-90.735786,181.451828,-90.771561,181.484283,-90.794991,181.495132C-90.860039,181.525269,-90.93119,181.512695,-90.977165,181.462952C-90.988503,181.450684,-91.003014,181.430267,-91.009399,181.417587C-91.019745,181.397064,-91.021019,181.390701,-91.021019,181.35968C-91.021019,181.328476,-91.019714,181.322067,-91.008591,181.298569C-90.99292,181.265488,-90.965279,181.238113,-90.930862,181.221588C-90.907669,181.210464,-90.901016,181.209076,-90.869965,181.208862C-90.80793,181.208435,-90.764534,181.22995,-90.732475,181.277023L-90.715042,181.302612L-90.575615,181.304077C-90.436188,181.305527,-90.43618,181.305542,-90.416817,181.31517C-90.398369,181.324356,-90.3964,181.32692,-90.375305,181.369354C-90.363121,181.39386,-90.334541,181.455734,-90.31179,181.506851C-90.28904,181.557983,-90.267876,181.603714,-90.264763,181.60849C-90.253143,181.626328,-90.259285,181.628876,-90.313087,181.628616C-90.340317,181.628479,-90.366295,181.626862,-90.370827,181.625046z"/>
    <path style="stroke:none;fill:#007BFF;fill-rule:evenodd" d="M-87.689041,181.814713C-87.786903,181.790314,-87.870369,181.715668,-87.921272,181.60704C-87.961113,181.522034,-87.962357,181.427811,-87.924713,181.347366C-87.880302,181.252457,-87.770462,181.160889,-87.653992,181.121689C-87.640503,181.117157,-87.61174,181.110748,-87.590088,181.107452C-87.543861,181.100433,-87.500732,181.104416,-87.451973,181.120224C-87.34948,181.153458,-87.251862,181.266296,-87.221748,181.386353C-87.207726,181.442276,-87.215767,181.522842,-87.240837,181.577591C-87.277092,181.656799,-87.35939,181.734268,-87.458282,181.782288C-87.516975,181.810791,-87.550575,181.819305,-87.610748,181.820877C-87.648811,181.821884,-87.665543,181.820572,-87.689041,181.814713zM-87.607124,181.645813C-87.521301,181.624573,-87.416893,181.542801,-87.382721,181.470062C-87.368477,181.439743,-87.366684,181.395477,-87.378441,181.364151C-87.39109,181.330444,-87.414368,181.304169,-87.445808,181.288101C-87.470551,181.275452,-87.474403,181.274643,-87.507584,181.27504C-87.550888,181.275543,-87.590546,181.287354,-87.635773,181.313187C-87.705246,181.35289,-87.755898,181.400772,-87.779976,181.449539C-87.793938,181.477798,-87.794716,181.481354,-87.794716,181.516357C-87.794716,181.549286,-87.793526,181.555664,-87.783806,181.574631C-87.750412,181.639832,-87.686684,181.665497,-87.607124,181.645813z"/>
    <path style="stroke:none;fill:#007BFF;fill-rule:evenodd" d="M-91.179817,182.039474C-91.240829,182.01506,-91.283562,181.954742,-91.284126,181.892227C-91.284538,181.846878,-91.272766,181.820145,-91.236206,181.783401C-91.198219,181.745209,-91.182449,181.739227,-91.119781,181.739273C-91.077911,181.739304,-91.073738,181.740036,-91.050072,181.751389C-91.022453,181.764633,-90.989449,181.794998,-90.973816,181.821548L-90.964127,181.837997L-90.801819,181.837997L-90.639519,181.837997L-90.639519,181.87619C-90.639519,181.897202,-90.640625,181.92247,-90.641983,181.932358L-90.644447,181.950317L-90.804367,181.950317L-90.964287,181.950317L-90.981079,181.974396C-91.000191,182.001801,-91.03743,182.0336,-91.057686,182.039841C-91.065216,182.04216,-91.091415,182.044769,-91.115913,182.045639C-91.153854,182.046982,-91.163322,182.046066,-91.179817,182.039474z"/>
    <path style="stroke:none;fill:#007BFF;fill-rule:evenodd" d="M-90.43026,182.097061C-90.443474,182.091797,-90.44574,182.086975,-90.445808,182.064041L-90.445862,182.044144L-90.473946,182.030762C-90.509743,182.013718,-90.522903,182.002441,-90.536835,181.976837C-90.552689,181.947708,-90.555206,181.902817,-90.542641,181.873596C-90.531776,181.848343,-90.494835,181.812912,-90.473343,181.807114C-90.454979,181.80217,-90.451126,181.79776,-90.447922,181.777969C-90.443199,181.748764,-90.442154,181.746368,-90.43222,181.741837C-90.426376,181.739182,-90.403076,181.737305,-90.37587,181.737305L-90.329475,181.737305L-90.325516,181.747726C-90.32296,181.75444,-90.32196,181.818039,-90.322708,181.926041C-90.3237,182.07019,-90.324684,182.094437,-90.329674,182.09758C-90.337296,182.102402,-90.417938,182.10199,-90.43026,182.097061z"/>
    <path style="stroke:none;fill:#007BFF;fill-rule:evenodd" d="M-88.590645,182.127808L-88.590645,181.999313L-88.701027,181.812332C-88.761742,181.709473,-88.811409,181.623474,-88.811409,181.621216C-88.811409,181.618393,-88.782516,181.617432,-88.719673,181.618134L-88.62793,181.619171L-88.567894,181.728592C-88.534874,181.788773,-88.506706,181.838013,-88.505295,181.838013C-88.503883,181.838013,-88.476761,181.788773,-88.445015,181.728592L-88.387306,181.619171L-88.297256,181.618134C-88.247726,181.617569,-88.207207,181.617935,-88.207207,181.618958C-88.207207,181.621033,-88.414284,181.971008,-88.422684,181.983139C-88.426903,181.989243,-88.427971,182.017624,-88.427971,182.123535L-88.427971,182.256302L-88.509308,182.256302L-88.590645,182.256302L-88.590645,182.127808z"/>
    <path style="stroke:none;fill:#007BFF;fill-rule:evenodd" d="M-89.308197,182.253403C-89.309006,182.251801,-89.309547,182.226959,-89.309387,182.198212L-89.309105,182.14592L-89.263596,182.144821L-89.218086,182.143738L-89.218086,181.936768L-89.218086,181.729797L-89.263596,181.728714L-89.309105,181.727615L-89.309105,181.673401L-89.309105,181.619171L-89.13578,181.618164L-88.962463,181.617157L-88.962463,181.673355L-88.962463,181.729553L-89.007004,181.729553L-89.051544,181.729553L-89.051544,181.936768L-89.051544,182.143982L-89.007004,182.143982L-88.962463,182.143982L-88.962463,182.200134L-88.962463,182.256302L-89.13459,182.256302C-89.229256,182.256302,-89.307381,182.25499,-89.308197,182.253403z"/>
    <path style="stroke:none;fill:#007BFF;fill-rule:evenodd" d="M-89.905563,182.262238C-89.96151,182.247894,-89.990219,182.234238,-90.052368,182.192383C-90.115425,182.149918,-90.14962,182.130615,-90.192177,182.113449L-90.219284,182.102524L-90.218651,182.052567C-90.218292,182.025085,-90.217857,181.94191,-90.217682,181.867706L-90.217354,181.732803L-90.20089,181.726425C-90.161942,181.711304,-90.114967,181.68573,-90.064362,181.6521C-90.005035,181.612671,-89.953232,181.586243,-89.917183,181.577011C-89.823479,181.552994,-89.732635,181.562454,-89.646065,181.605209C-89.560043,181.64769,-89.498184,181.720734,-89.463531,181.820694C-89.453461,181.849747,-89.45282,181.85553,-89.452698,181.919342L-89.452568,181.987122L-89.466812,182.025299C-89.487122,182.079727,-89.50985,182.117279,-89.545082,182.154602C-89.597618,182.210281,-89.660454,182.245728,-89.739082,182.264069C-89.786667,182.275162,-89.858246,182.274368,-89.905563,182.262238zM-89.721596,181.735367L-89.721596,181.698578L-89.795181,181.698578L-89.868774,181.698578L-89.868774,181.735367L-89.868774,181.772156L-89.795181,181.772156L-89.721596,181.772156L-89.721596,181.735367zM-90.027565,181.888351L-90.027565,181.698578L-90.062424,181.698578L-90.097282,181.698578L-90.097282,181.888351L-90.097282,182.07814L-90.062424,182.07814L-90.027565,182.07814L-90.027565,181.888351zM-89.566666,181.888351L-89.566666,181.698578L-89.603462,181.698578L-89.640259,181.698578L-89.640259,181.888351L-89.640259,182.07814L-89.603462,182.07814L-89.566666,182.07814L-89.566666,181.888351zM-89.873528,182.154633L-89.872482,182.07814L-89.797035,182.07814L-89.721596,182.07814L-89.721596,181.963882L-89.721596,181.849625L-89.795181,181.849625L-89.868774,181.849625L-89.868774,181.886276L-89.868774,181.922928L-89.831009,181.924042L-89.793243,181.925156L-89.792145,181.964844L-89.791039,182.004547L-89.868637,182.004547L-89.946236,182.004547L-89.946236,182.116226C-89.946236,182.177643,-89.945007,182.229126,-89.943512,182.230621C-89.942017,182.232117,-89.925896,182.232834,-89.907684,182.232239L-89.87458,182.231125L-89.873528,182.154633z"/>
    <path style="stroke:none;fill:#007BFF;fill-rule:evenodd" d="M-92.15197,182.548569C-92.177536,182.545853,-92.224594,182.540802,-92.256546,182.537354C-92.288498,182.53392,-92.338173,182.52858,-92.366928,182.525513C-92.395683,182.522461,-92.434898,182.518082,-92.454071,182.515793C-92.473244,182.513504,-92.512894,182.509094,-92.542183,182.505966C-92.57148,182.502853,-92.620277,182.497635,-92.650635,182.494385C-92.680992,182.491135,-92.728966,182.486145,-92.757248,182.483307C-92.785538,182.480469,-92.809792,182.47702,-92.811157,182.475662C-92.812523,182.474289,-92.799805,182.436142,-92.782898,182.390884C-92.754135,182.313873,-92.751503,182.308502,-92.74189,182.307388C-92.736244,182.306732,-92.704903,182.310547,-92.672249,182.315887C-92.639587,182.321213,-92.58847,182.329208,-92.558647,182.333633C-92.528824,182.338074,-92.494835,182.343353,-92.483124,182.345383C-92.471405,182.347397,-92.437416,182.352676,-92.407593,182.357101C-92.377769,182.361511,-92.338562,182.367523,-92.320465,182.370438C-92.302368,182.373352,-92.287102,182.37529,-92.286552,182.374741C-92.285995,182.374191,-92.372719,182.313995,-92.479263,182.240982C-92.585815,182.167969,-92.673676,182.107132,-92.674507,182.105774C-92.675339,182.104416,-92.662621,182.067581,-92.64624,182.023911L-92.616463,181.944504L-92.597237,181.944794C-92.586662,181.944946,-92.555351,181.947952,-92.527664,181.951462C-92.499969,181.954971,-92.454651,181.960617,-92.426956,181.964005C-92.399269,181.967392,-92.36528,181.971695,-92.351433,181.973557C-92.328728,181.976624,-92.30175,181.979965,-92.19651,181.992737C-92.178406,181.994934,-92.159386,181.99675,-92.154243,181.996765C-92.148262,181.99678,-92.215065,181.952087,-92.340157,181.87236C-92.44754,181.803909,-92.536781,181.746689,-92.53846,181.745178C-92.542084,181.741913,-92.481216,181.576385,-92.476608,181.576981C-92.47123,181.577667,-91.883232,181.983047,-91.883003,181.986237C-91.882706,181.990311,-91.945244,182.160767,-91.948204,182.16394C-91.950806,182.166733,-91.989197,182.1633,-92.237175,182.138077C-92.266998,182.13504,-92.3097,182.130722,-92.332069,182.128479C-92.354439,182.126236,-92.376221,182.123383,-92.380486,182.122147C-92.38739,182.120148,-92.387596,182.120544,-92.382416,182.125809C-92.379227,182.129059,-92.299919,182.184326,-92.206192,182.248627C-92.112465,182.312927,-92.033577,182.367615,-92.030884,182.370163C-92.023773,182.376907,-92.089813,182.554764,-92.099144,182.554016C-92.102638,182.553726,-92.126411,182.551285,-92.15197,182.548569z"/>
    <path style="stroke:none;fill:#007BFF;fill-rule:evenodd" d="M-87.128403,182.564102C-87.143234,182.558975,-87.167259,182.546646,-87.181786,182.536728C-87.243195,182.494766,-87.274879,182.442429,-87.301308,182.33931C-87.310005,182.305374,-87.317406,182.277313,-87.317749,182.276932C-87.318092,182.276566,-87.334915,182.280426,-87.355141,182.285492C-87.475342,182.315628,-87.534744,182.329453,-87.537277,182.327881C-87.540825,182.325684,-87.582123,182.160416,-87.579628,182.158386C-87.578636,182.157593,-87.527283,182.144516,-87.465508,182.129364C-87.403732,182.114197,-87.299156,182.088531,-87.233116,182.072311C-87.167084,182.056107,-87.067268,182.031494,-87.011299,182.017624C-86.955338,182.003754,-86.90667,181.99295,-86.903137,181.993637C-86.89814,181.994598,-86.890068,182.02179,-86.866554,182.116867C-86.824165,182.288239,-86.820068,182.309433,-86.820084,182.35701C-86.820129,182.467148,-86.873154,182.536438,-86.980072,182.566071C-87.022186,182.577744,-87.091675,182.576828,-87.128403,182.564102zM-87.029533,182.389496C-86.989899,182.377716,-86.96804,182.346741,-86.967896,182.302109C-86.967819,182.279099,-86.980309,182.210999,-86.986679,182.199707C-86.988358,182.196732,-87.018852,182.202759,-87.084679,182.219101C-87.137245,182.232147,-87.181396,182.243958,-87.182785,182.245346C-87.186104,182.248672,-87.166954,182.318787,-87.156876,182.34024C-87.145279,182.364914,-87.122299,182.386688,-87.100632,182.393509C-87.080498,182.399857,-87.060677,182.398743,-87.029533,182.389496z"/>
    <path style="stroke:none;fill:#007BFF;fill-rule:evenodd" d="M-90.936707,182.606812C-90.969139,182.590576,-90.996002,182.563431,-91.010574,182.532135C-91.01944,182.513092,-91.020889,182.504822,-91.02095,182.473129C-91.021019,182.439178,-91.020012,182.434204,-91.008255,182.410309C-90.991882,182.377029,-90.965805,182.351044,-90.933876,182.336182C-90.910561,182.325317,-90.905411,182.324448,-90.864159,182.324265C-90.822647,182.324097,-90.81813,182.324844,-90.797768,182.335159C-90.769356,182.349548,-90.740501,182.375031,-90.72467,182.399689L-90.712036,182.419388L-90.596565,182.418213C-90.518204,182.417404,-90.479713,182.415649,-90.476784,182.412704C-90.474403,182.410324,-90.451157,182.361526,-90.42511,182.30426L-90.377762,182.200134L-90.329086,182.199066C-90.302315,182.198471,-90.275864,182.199707,-90.270309,182.201828C-90.260429,182.205582,-90.260323,182.206009,-90.265526,182.220337C-90.268456,182.228394,-90.285095,182.266373,-90.302498,182.304718C-90.319901,182.343063,-90.345772,182.400543,-90.359985,182.432449C-90.388527,182.496521,-90.406647,182.520279,-90.43071,182.525162C-90.437981,182.526642,-90.50544,182.528824,-90.580612,182.529999L-90.7173,182.532166L-90.730164,182.552261C-90.745949,182.576935,-90.770706,182.598938,-90.796379,182.611115C-90.813423,182.619186,-90.821381,182.6203,-90.862671,182.620331C-90.908592,182.620377,-90.910179,182.620087,-90.936707,182.606812z"/>
    <path style="stroke:none;fill:#007BFF;fill-rule:evenodd" d="M-89.823586,182.830811C-89.825005,182.829391,-89.826164,182.809341,-89.826164,182.78627L-89.826164,182.744308L-88.327271,182.744308L-86.828384,182.744324L-86.828384,182.788864L-86.828384,182.833405L-88.324692,182.833389C-89.147659,182.833389,-89.822166,182.83223,-89.823586,182.830811z"/>
    <path style="stroke:none;fill:#007BFF;fill-rule:evenodd" d="M-90.825432,182.968948L-90.825432,182.926346L-88.826904,182.926346L-86.828384,182.926346L-86.828384,182.968964L-86.828384,183.011566L-88.826904,183.011551L-90.825432,183.011551L-90.825432,182.968948z"/>
    <path style="stroke:none;fill:#007BFF;fill-rule:evenodd" d="M-92.820084,183.14711L-92.820084,183.104507L-89.824234,183.104507L-86.828384,183.104523L-86.828384,183.147125L-86.828384,183.189728L-89.824234,183.189713L-92.820084,183.189713L-92.820084,183.14711z"/>
</svg>

      </div>
      <div class="hero-titles">
        <div class="hero-title">MICRO:BIT REMOTE STUDIO</div>
        <div class="hero-subtitle">Build fun remotes â€¢ Connect â€¢ Play â€¢ Learn</div>
        <div class="tabs hero-tabs">
          <button class="tab active" data-tab="builder">âœï¸ Build</button>
          <button class="tab" data-tab="runtime">â–¶ï¸ Play</button>
        </div>
      </div>
    </div>

    <div class="hero-center">
      <div class="bismillah" lang="ar" dir="rtl">Ø¨ÙØ³Ù’Ù…Ù Ù±Ù„Ù„ÙŽÙ‘Ù°Ù‡Ù Ù±Ù„Ø±ÙŽÙ‘Ø­Ù’Ù…ÙŽÙ°Ù†Ù Ù±Ù„Ø±ÙŽÙ‘Ø­ÙÙŠÙ…Ù</div>
    </div>

    <div class="hero-right">
      <button id="langBtn" class="hero-pill hero-pill-lang" title="Language">
        <span class="pill-dot"></span>
        <span class="pill-text">ðŸŒ</span>
      </button>

      <button id="soundBtn" class="hero-pill hero-pill-sound" title="Sound">
        <span class="pill-dot"></span>
        <span class="pill-text">Sound On</span>
      </button>

      <button id="bleBtn" class="hero-pill hero-pill-ble" title="Connection">
        <span class="pill-dot"></span>
        <span class="pill-text">Connect</span>
      </button>
    </div>
  </div>
</header>


  <div id="templateModal" class="template-modal">
    <div class="template-content">
      <h2>ðŸŽ¨ Choose a Template!</h2>
      <p>Pick one to start building your remote</p>
      <div class="templates-grid">
        <div class="template-card" data-tpl="gamepad"><div class="template-icon">ðŸŽ®</div><div class="template-name">Game Pad</div></div>
        <div class="template-card" data-tpl="robot"><div class="template-icon">ðŸ¤–</div><div class="template-name">Robot</div></div>
        <div class="template-card" data-tpl="mixer"><div class="template-icon">ðŸŽµ</div><div class="template-name">DJ Mixer</div></div>
        <div class="template-card" data-tpl="racing"><div class="template-icon">ðŸŽï¸</div><div class="template-name">Race Car</div></div>
        <div class="template-card" data-tpl="lights"><div class="template-icon">ðŸ’¡</div><div class="template-name">Lights</div></div>
        <div class="template-card" data-tpl="blank"><div class="template-icon">âœ¨</div><div class="template-name">Start Fresh</div></div>
      </div>
    </div>
  </div>

  <main>
    <div class="view builder-view active">
      <div class="builder-header">
        <input type="text" id="titleInput" class="title-input" placeholder="ðŸ·ï¸ Name your remote..." maxlength="25">
        <div class="action-card">
          <button class="header-btn btn-demo" id="demoBtn">ðŸŽ® Try All Widgets!</button>
<button class="header-btn btn-code" id="exportJsonBtn">ðŸ“¦ Export</button>
<button class="header-btn btn-code" id="importJsonBtn">ðŸ“‚ Import</button>
        <button class="header-btn btn-template" id="templateBtn">ðŸŽ¨ Templates</button>
        <button class="header-btn btn-code" id="codeBtn">ðŸ“„ Code</button>
        <button class="header-btn btn-delete" id="deleteBtn">ðŸ—‘ï¸</button>
        </div>
      </div>
      <div class="canvas-wrap">
        <div class="canvas-hint">ðŸ‘† Tap a widget below, then <span>tap here</span> to place it!</div>
        <div id="canvas" class="canvas"><div id="widgetsLayer"></div></div>
      </div>

      <div id="propsPanel" class="props-panel">
        <div class="props-title">ðŸ› ï¸ Widget Properties</div>
        <div id="propsEmpty" class="props-empty">Select a widget to edit it.</div>
        <div id="propsForm" class="props-form" style="display:none;"></div>
      </div>

      <div class="palette">
        <div class="palette-item" data-type="button"><div class="palette-icon">ðŸ‘†</div><div class="palette-name">Button</div></div>
        <div class="palette-item" data-type="slider"><div class="palette-icon">ðŸŽšï¸</div><div class="palette-name">Slider</div></div>
        <div class="palette-item" data-type="toggle"><div class="palette-icon">ðŸ”˜</div><div class="palette-name">Switch</div></div>
        <div class="palette-item" data-type="joystick"><div class="palette-icon">ðŸ•¹ï¸</div><div class="palette-name">Joystick</div></div>
        <div class="palette-item" data-type="led"><div class="palette-icon">ðŸ’¡</div><div class="palette-name">Light</div></div>
        <div class="palette-item" data-type="label"><div class="palette-icon">ðŸ·ï¸</div><div class="palette-name">Label</div></div>
        <div class="palette-item" data-type="gauge"><div class="palette-icon">ðŸ§­</div><div class="palette-name">Gauge</div></div>
        <div class="palette-item" data-type="graph"><div class="palette-icon">ðŸ“ˆ</div><div class="palette-name">Graph</div></div>
      </div>
    </div>

    <div class="view runtime-view">
      <div id="connectPrompt" class="connect-box">
        <div class="connect-icon">ðŸ“¡</div>
        <div class="connect-text">Connect your micro:bit!</div>
        <button id="connectBtn" class="connect-btn">ðŸ”— Connect</button>
      </div>
      <div id="runtimeContent"><div id="runtimeTitle"></div><div id="runtimeGrid"></div></div>
    </div>
  </main>
</div>

<div id="toast" class="toast"></div>

<div id="loadingOverlay" class="loading-overlay" aria-hidden="true">
  <div class="loading-card">
    <div class="loading-title">ðŸ§© Loading your remote...</div>
    <div class="loading-sub" id="loadingSub">Getting layout from micro:bit</div>
    <div class="loading-bar">
      <div class="loading-bar-fill" id="loadingBarFill"></div>
    </div>
    <div class="loading-pct" id="loadingPct">0%</div>
  </div>
</div>

<div id="modalBg" class="modal-bg">
  <div class="modal">
    <div id="modalTitle" class="modal-title"></div>
    <pre id="modalCode" class="modal-code"></pre>
    <div class="modal-buttons">
      <button class="modal-btn primary" id="copyBtn">ðŸ“‹ Copy</button>
      <button class="modal-btn primary" id="downloadBtn">ðŸ’¾ Save</button>
      <button class="modal-btn secondary" id="modalClose">âœ–ï¸ Close</button>
    </div>
  </div>
</div>
<input type="file" id="fileInput" accept=".json" hidden>

<script>
window.__ovl = window.__ovl || { t:null };

const UART_SERVICE = '6e400001-b5a3-f393-e0a9-e50e24dcca9e';
const UART_TX_CHAR = '6e400002-b5a3-f393-e0a9-e50e24dcca9e';
const UART_RX_CHAR = '6e400003-b5a3-f393-e0a9-e50e24dcca9e';

const encoder = new TextEncoder();
const esc = s => { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; };
const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);

// ---- Resizable canvas helper (builder) ----
function findCanvasDropzone(){
  return document.querySelector('.canvas-dropzone, .dropzone, .board-drop, .canvas-wrap, .canvas-container, .canvas-frame, .builder-canvas, .board, .canvas');
}

function makeCanvasResizable(){
  const dz = findCanvasDropzone();
  if (!dz) return;

  // Avoid double wrapping
  if (dz.closest('.resizable-wrap')) return;

  const wrap = document.createElement('div');
  wrap.className = 'resizable-wrap';

  // Restore saved size
  try{
    const saved = JSON.parse(localStorage.getItem('kid_canvas_size') || 'null');
    if (saved && saved.w && saved.h){
      wrap.style.width = Math.min(saved.w, window.innerWidth - 80) + 'px';
      wrap.style.height = Math.min(saved.h, window.innerHeight - 220) + 'px';
    }
  }catch(e){}

  // Insert wrapper in DOM
  const parent = dz.parentElement;
  parent.insertBefore(wrap, dz);
  wrap.appendChild(dz);

  // Ensure the dropzone stretches inside wrapper
  dz.style.width = '100%';
  dz.style.height = '100%';
  dz.style.maxWidth = 'none';
  dz.style.overflow = 'hidden';

  // Add resizer handle + size badge
  const handle = document.createElement('div');
  handle.className = 'canvas-resizer';
  const badge = document.createElement('div');
  badge.className = 'canvas-size-badge';
  badge.textContent = '';
  wrap.appendChild(badge);
  wrap.appendChild(handle);

  function updateBadge(){
    const r = wrap.getBoundingClientRect();
    badge.textContent = Math.round(r.width) + 'Ã—' + Math.round(r.height);
  }
  updateBadge();

  let dragging = false;
  let startX=0, startY=0, startW=0, startH=0;

  const onMove = (e) => {
    if (!dragging) return;
    const clientX = (e.touches && e.touches[0]) ? e.touches[0].clientX : e.clientX;
    const clientY = (e.touches && e.touches[0]) ? e.touches[0].clientY : e.clientY;
    const dx = clientX - startX;
    const dy = clientY - startY;

    const minW = 320, minH = 320;
    const maxW = Math.max(360, window.innerWidth - 60);
    const maxH = Math.max(360, window.innerHeight - 180);

    const newW = Math.max(minW, Math.min(maxW, startW + dx));
    const newH = Math.max(minH, Math.min(maxH, startH + dy));

    wrap.style.width = newW + 'px';
    wrap.style.height = newH + 'px';
    updateBadge();
  };

  const onUp = () => {
    if (!dragging) return;
    dragging = false;
    document.body.style.userSelect = '';
    document.body.style.cursor = '';
    try{
      const r = wrap.getBoundingClientRect();
      localStorage.setItem('kid_canvas_size', JSON.stringify({w: Math.round(r.width), h: Math.round(r.height)}));
    }catch(e){}
    window.removeEventListener('mousemove', onMove);
    window.removeEventListener('mouseup', onUp);
    window.removeEventListener('touchmove', onMove);
    window.removeEventListener('touchend', onUp);
  };

  const onDown = (e) => {
    e.preventDefault();
    dragging = true;
    const r = wrap.getBoundingClientRect();
    startW = r.width; startH = r.height;
    startX = (e.touches && e.touches[0]) ? e.touches[0].clientX : e.clientX;
    startY = (e.touches && e.touches[0]) ? e.touches[0].clientY : e.clientY;
    document.body.style.userSelect = 'none';
    document.body.style.cursor = 'nwse-resize';
    window.addEventListener('mousemove', onMove);
    window.addEventListener('mouseup', onUp);
    window.addEventListener('touchmove', onMove, {passive:false});
    window.addEventListener('touchend', onUp);
  };

  handle.addEventListener('mousedown', onDown);
  handle.addEventListener('touchstart', onDown, {passive:false});

  // Update badge if window resized
  window.addEventListener('resize', ()=>updateBadge());
}


// ===============================
// Kid-friendly i18n + JSON templates
// ===============================
const I18N = {
  en: {
    build: "âœï¸ Build", play: "â–¶ï¸ Play",
    chooseTpl: "ðŸŽ¨ Choose a Template!",
    pickTpl: "Pick one to start building your remote",
    templates: { gamepad:"Game Pad", robot:"Robot", mixer:"DJ Mixer", racing:"Race Car", lights:"Lights", blank:"Start Fresh" },
    buttons: { demo:"ðŸŽ® Try All Widgets!", export:"ðŸ“¦ Export", import:"ðŸ“‚ Import", code:"ðŸ“„ Code" },
    hint: "ðŸ‘† Tap a widget below, then tap the board to place it!",
    propsTitle: "ðŸ› ï¸ Widget Properties",
    propsEmpty: "Select a widget to edit it.",
    connect: "Connect", connected: "Connected",
    runtimeConnectText: "Connect your micro:bit!",
    runtimeConnectBtn: "ðŸ”— Connect",
    toastExport: "ðŸ“¦ Exported JSON!",
    toastImport: "ðŸ“‚ Imported!",
    toastImportFail: "âŒ Import failed"
  },
  fr: {
    build: "âœï¸ Construire", play: "â–¶ï¸ Jouer",
    chooseTpl: "ðŸŽ¨ Choisis un modÃ¨le !",
    pickTpl: "Prends-en un pour commencer",
    templates: { gamepad:"Manette", robot:"Robot", mixer:"DJ Mixer", racing:"Course", lights:"LumiÃ¨res", blank:"Nouveau" },
    buttons: { demo:"ðŸŽ® DÃ©mo widgets !", export:"ðŸ“¦ Export", import:"ðŸ“‚ Import", code:"ðŸ“„ Code" },
    hint: "ðŸ‘† Choisis un widget, puis tape sur le tableau pour le placer !",
    propsTitle: "ðŸ› ï¸ PropriÃ©tÃ©s",
    propsEmpty: "SÃ©lectionne un widget pour lâ€™Ã©diter.",
    connect: "Connecter", connected: "ConnectÃ©",
    runtimeConnectText: "Connecte ton micro:bit !",
    runtimeConnectBtn: "ðŸ”— Connecter",
    toastExport: "ðŸ“¦ JSON exportÃ© !",
    toastImport: "ðŸ“‚ ImportÃ© !",
    toastImportFail: "âŒ Import impossible"
  },
  ar: {
    build: "âœï¸ Ø¨Ù†Ø§Ø¡", play: "â–¶ï¸ ØªØ´ØºÙŠÙ„",
    chooseTpl: "ðŸŽ¨ Ø§Ø®ØªØ± Ù‚Ø§Ù„Ø¨Ù‹Ø§!",
    pickTpl: "Ø§Ø®ØªØ± ÙˆØ§Ø­Ø¯Ù‹Ø§ Ù„Ù„Ø¨Ø¯Ø¡",
    templates: { gamepad:"Ø°Ø±Ø§Ø¹ ØªØ­ÙƒÙ…", robot:"Ø±ÙˆØ¨ÙˆØª", mixer:"Ù…ÙˆØ³ÙŠÙ‚Ù‰", racing:"Ø³Ø¨Ø§Ù‚", lights:"Ø£Ø¶ÙˆØ§Ø¡", blank:"Ø§Ø¨Ø¯Ø£" },
    buttons: { demo:"ðŸŽ® Ø¹Ø±Ø¶ ÙƒÙ„ Ø§Ù„Ø£Ø¯ÙˆØ§Øª!", export:"ðŸ“¦ ØªØµØ¯ÙŠØ±", import:"ðŸ“‚ Ø§Ø³ØªÙŠØ±Ø§Ø¯", code:"ðŸ“„ Ø§Ù„ÙƒÙˆØ¯" },
    hint: "ðŸ‘† Ø§Ø®ØªØ± Ø£Ø¯Ø§Ø©ØŒ Ø«Ù… Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ù„ÙˆØ­Ø© Ù„ÙˆØ¶Ø¹Ù‡Ø§!",
    propsTitle: "ðŸ› ï¸ Ø®ØµØ§Ø¦Øµ Ø§Ù„Ø£Ø¯Ø§Ø©",
    propsEmpty: "Ø§Ø®ØªØ± Ø£Ø¯Ø§Ø© Ù„ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§.",
    connect: "Ø§ØªØµØ§Ù„", connected: "Ù…ØªØµÙ„",
    runtimeConnectText: "Ø§ØªØµÙ„ Ø¨Ø§Ù„Ù€ micro:bit!",
    runtimeConnectBtn: "ðŸ”— Ø§ØªØµØ§Ù„",
    toastExport: "ðŸ“¦ ØªÙ… Ø§Ù„ØªØµØ¯ÙŠØ±!",
    toastImport: "ðŸ“‚ ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯!",
    toastImportFail: "âŒ ÙØ´Ù„ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯"
  }
};

const LANGS = ["en","fr","ar"];
const LANG_ICON = { en:"ðŸ‡¬ðŸ‡§", fr:"ðŸ‡«ðŸ‡·", ar:"ðŸ‡©ðŸ‡¿" };
const LANG_NAME = { en:"English", fr:"FranÃ§ais", ar:"Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©" };

function saveLang() { try { localStorage.setItem("kid_lang", state.lang); } catch(e){} }
function loadLang() { try { return localStorage.getItem("kid_lang"); } catch(e){ return null; } }
function detectBrowserLang(){
  const n = String(navigator.language || "en").toLowerCase();
  if (n.startsWith("fr")) return "fr";
  if (n.startsWith("ar")) return "ar";
  return "en";
}

function setLang(lang){
  state.lang = LANGS.includes(lang) ? lang : "en";
  saveLang();
  const t = I18N[state.lang] || I18N.en;

  document.documentElement.lang = state.lang;
  const rtl = (state.lang === "ar");
  document.documentElement.dir = rtl ? "rtl" : "ltr";
  document.body.classList.toggle("rtl", rtl);

  // Tabs
  const tabs = $$(".tab");
  if (tabs[0]) tabs[0].textContent = t.build;
  if (tabs[1]) tabs[1].textContent = t.play;

  // Top buttons
  const langBtn = $("#langBtn");
  if (langBtn){
    const s = langBtn.querySelector("span:last-child");
    if (s) s.textContent = LANG_ICON[state.lang] || "ðŸŒ";
    langBtn.title = "Language: " + (LANG_NAME[state.lang] || state.lang);
  }

  const bleBtn = $("#bleBtn");
  if (bleBtn){
    const s = bleBtn.querySelector("span:last-child");
    if (s) s.textContent = (state.ble && state.ble.connected) ? t.connected : t.connect;
  }

  // Builder header buttons
  const demoBtn = $("#demoBtn"); if (demoBtn) demoBtn.textContent = t.buttons.demo;
  const exportBtn = $("#exportJsonBtn"); if (exportBtn) exportBtn.textContent = t.buttons.export;
  const importBtn = $("#importJsonBtn"); if (importBtn) importBtn.textContent = t.buttons.import;
  const codeBtn = $("#codeBtn"); if (codeBtn) codeBtn.textContent = t.buttons.code;

  // Hint
  const hint = document.querySelector(".canvas-hint");
  if (hint) hint.textContent = t.hint;

  // Props panel
  const pt = document.querySelector(".props-title"); if (pt) pt.textContent = t.propsTitle;
  const pe = $("#propsEmpty"); if (pe) pe.textContent = t.propsEmpty;

  // Template modal
  const tm = $("#templateModal");
  if (tm){
    const h2 = tm.querySelector("h2"); if (h2) h2.textContent = t.chooseTpl;
    const p = tm.querySelector("p"); if (p) p.textContent = t.pickTpl;
    tm.querySelectorAll(".template-card").forEach(card=>{
      const key = card.dataset.tpl;
      const nameEl = card.querySelector(".template-name");
      if (nameEl && t.templates[key]) nameEl.textContent = t.templates[key];
    });
  }

  // Runtime connect screen
  const ct = document.querySelector(".connect-text"); if (ct) ct.textContent = t.runtimeConnectText;
  const cb = $("#connectBtn"); if (cb) cb.textContent = t.runtimeConnectBtn;
}

function cycleLang(){
  const i = LANGS.indexOf(state.lang || "en");
  const next = LANGS[(i + 1) % LANGS.length];
  setLang(next);
  if (typeof toast === "function") toast((LANG_ICON[next]||"ðŸŒ") + " " + (LANG_NAME[next]||next), "success");
}

// ---- Export / Import JSON layout ----
function exportLayoutJson(){
  const t = I18N[state.lang] || I18N.en;
  if (!state.widgets || state.widgets.length === 0){
    if (typeof toast === "function") toast("ðŸ‘† Add some widgets first!", "error");
    return;
  }
  const title = ($("#titleInput") && $("#titleInput").value) ? $("#titleInput").value : "My Remote";
  const cfg = { schemaVersion: 1, title: title, widgets: state.widgets };

  const blob = new Blob([JSON.stringify(cfg, null, 2)], { type: "application/json" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  const safe = String(title).toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"");
  a.download = (safe || "my-remote") + ".json";
  a.click();

  if (typeof toast === "function") toast(t.toastExport, "success");
}

function importLayoutJsonFile(file){
  const t = I18N[state.lang] || I18N.en;
  const reader = new FileReader();
  reader.onload = () => {
    try {
      const cfg = JSON.parse(String(reader.result || "{}"));
      if (!cfg || !Array.isArray(cfg.widgets)) throw new Error("Bad format");
      state.widgets = cfg.widgets.map(w => ({...w}));
      // Recompute nextId safely
      let maxNum = 0;
      state.widgets.forEach(w=>{
        const m = String(w.id||"").match(/(\d+)$/);
        if (m) maxNum = Math.max(maxNum, parseInt(m[1],10));
      });
      state.nextId = Math.max(10, maxNum + 1);
      if ($("#titleInput")) $("#titleInput").value = cfg.title || "My Remote";
      if (typeof applyWidgetDefaults === "function") state.widgets.forEach(applyWidgetDefaults);
      state.selected = null;
      if (typeof renderWidgets === "function") renderWidgets();
      makeCanvasResizable();
if (typeof renderPropsPanel === "function") renderPropsPanel();
      if (typeof toast === "function") toast(t.toastImport, "success");
    } catch(e){
      console.error(e);
      if (typeof toast === "function") toast(t.toastImportFail, "error");
    }
  };
  reader.readAsText(file);
}


const ICONS = { button:'ðŸ‘†', slider:'ðŸŽšï¸', toggle:'ðŸ”˜', joystick:'ðŸ•¹ï¸', led:'ðŸ’¡', label:'ðŸ·ï¸', graph:'ðŸ“ˆ', gauge:'ðŸ§­' };
const SIZES = { button:[90,90], slider:[90,160], toggle:[90,90], joystick:[120,120], led:[90,90], label:[120,60], graph:[240,140], gauge:[150,150] };

const templates = {
  gamepad: [
    { t:'joystick', x:20, y:30, w:120, h:120, label:'Move' },
    { t:'button', x:180, y:40, w:90, h:90, label:'Jump' },
    { t:'button', x:290, y:40, w:90, h:90, label:'Fire' },
    { t:'toggle', x:180, y:160, w:90, h:90, label:'Turbo' }
  ],
  robot: [
    { t:'slider', x:20, y:20, w:90, h:180, label:'Arm 1' },
    { t:'slider', x:130, y:20, w:90, h:180, label:'Arm 2' },
    { t:'slider', x:240, y:20, w:90, h:180, label:'Arm 3' },
    { t:'toggle', x:350, y:80, w:90, h:90, label:'Grip' }
  ],
  mixer: [
    { t:'slider', x:20, y:20, w:80, h:200, label:'Bass' },
    { t:'slider', x:120, y:20, w:80, h:200, label:'Mid' },
    { t:'slider', x:220, y:20, w:80, h:200, label:'High' },
    { t:'toggle', x:320, y:80, w:90, h:90, label:'FX' },
    { t:'led', x:320, y:20, w:90, h:50, label:'Beat' }
  ],
  racing: [
    { t:'joystick', x:150, y:20, w:130, h:130, label:'Steer' },
    { t:'slider', x:20, y:170, w:80, h:140, label:'Gas' },
    { t:'slider', x:330, y:170, w:80, h:140, label:'Brake' },
    { t:'button', x:150, y:180, w:130, h:80, label:'Nitro!' }
  ],
  lights: [
    { t:'toggle', x:30, y:30, w:100, h:100, label:'Red' },
    { t:'toggle', x:160, y:30, w:100, h:100, label:'Green' },
    { t:'toggle', x:290, y:30, w:100, h:100, label:'Blue' },
    { t:'led', x:90, y:160, w:100, h:100, label:'Status' },
    { t:'led', x:230, y:160, w:100, h:100, label:'Alert' }
  ],
  blank: []
};

const state = {
  widgets: [], selected: null, nextId: 1, selectedType: null,
  ble: { device:null, server:null, service:null, notifyChar:null, writeChar:null, connected:false },
  config: null, values: {}, rxBuffer: '',
  justDragged: false, _dragT: null
};
state._allowLoadingOverlay = false;


// ---- Kid-friendly sound engine (WebAudio) ----
state.soundOn = true;
state._audio = { ctx: null, unlocked: false };
state._gaugeLast = state._gaugeLast || {};

function ensureAudio() {
  if (!state.soundOn) return null;
  if (state._audio.ctx) return state._audio.ctx;
  try {
    const Ctx = window.AudioContext || window.webkitAudioContext;
    state._audio.ctx = new Ctx();
    return state._audio.ctx;
  } catch (e) { return null; }
}

function unlockAudioOnce() {
  const ctx = ensureAudio();
  if (!ctx) return;
  if (ctx.state === 'suspended') ctx.resume().catch(()=>{});
  state._audio.unlocked = true;
}

document.addEventListener('pointerdown', () => unlockAudioOnce(), { once: true });

function beep(freq=880, dur=0.06, vol=0.05, type='sine') {
  if (!state.soundOn) return;
  const ctx = ensureAudio();
  if (!ctx) return;
  if (ctx.state === 'suspended') ctx.resume().catch(()=>{});
  const o = ctx.createOscillator();
  const g = ctx.createGain();
  o.type = type;
  o.frequency.value = freq;
  g.gain.value = vol;
  o.connect(g); g.connect(ctx.destination);
  const t = ctx.currentTime;
  g.gain.setValueAtTime(0.0001, t);
  g.gain.exponentialRampToValueAtTime(vol, t + 0.01);
  g.gain.exponentialRampToValueAtTime(0.0001, t + dur);
  o.start(t);
  o.stop(t + dur + 0.02);
}
// Sound patterns
function beepClick(){ beep(880, 0.05, 0.05, 'sine'); }
function beepToggle(on){ beep(on?1046:659, 0.06, 0.05, 'square'); }
function beepWarn(){ beep(523, 0.09, 0.06, 'triangle'); setTimeout(()=>beep(659,0.09,0.05,'triangle'), 110); }
function beepDanger(){ beep(330, 0.10, 0.07, 'sawtooth'); setTimeout(()=>beep(330,0.10,0.07,'sawtooth'), 130); }

// Sound UI
function updateSoundUI(){
  const b = $('#soundBtn');
  if (!b) return;
  b.classList.toggle('connected', state.soundOn);
  b.querySelector('span:last-child').textContent = state.soundOn ? 'Sound On' : 'Sound Off';
  b.style.opacity = state.soundOn ? '1' : '0.7';
}



// Ensure older configs/templates still look good when new properties are added
function applyWidgetDefaults(w){
  if (!w || !w.t) return w;

  // Default models (3 per widget type)
  if (!w.model){
    if (w.t === 'button') w.model = 'neo';
    if (w.t === 'slider') w.model = 'track';
    if (w.t === 'toggle') w.model = 'square';
    if (w.t === 'led') w.model = 'dot';
    if (w.t === 'joystick') w.model = 'classic';
    if (w.t === 'label') w.model = 'plain';
    if (w.t === 'gauge') w.model = 'classic';
    if (w.t === 'graph') w.model = 'grid';
  }

  // Existing per-type defaults
  if (w.t === 'led'){
    if (!w.colorOn) w.colorOn = '#ff5252';
    if (!w.colorOff) w.colorOff = '#2a2a3a';
  }
  if (w.t === 'slider'){
    if (w.min == null) w.min = 0;
    if (w.max == null) w.max = 100;
    if (w.step == null) w.step = 1;
  }

  // Gauge defaults
  if (w.t === 'gauge'){
    if (w.min == null) w.min = 0;
    if (w.max == null) w.max = 100;
    if (w.decimals == null) w.decimals = 1;
    if (w.units == null) w.units = '';
    if (w.warn == null) w.warn = null;   // optional threshold
    if (w.danger == null) w.danger = null;
  }

  // Graph defaults (comma-separated multi-series values: "23.4,2.1")
  if (w.t === 'graph'){
    if (w.series == null) w.series = 1;      // 1..10
    if (w.windowSec == null) w.windowSec = 30; // visible time window
    if (w.autoScale == null) w.autoScale = true;
    if (w.min == null) w.min = 0;
    if (w.max == null) w.max = 100;
    if (w.showLegend == null) w.showLegend = true;
  }

  return w;
}

function modelOptionsForType(t){
  switch(t){
    case 'button': return [
      { v:'neo',   name:'Neo (gradient)' },
      { v:'flat',  name:'Flat' },
      { v:'glass', name:'Glass' }
    ];
    case 'slider': return [
      { v:'track', name:'Track' },
      { v:'neon',  name:'Neon' },
      { v:'min',   name:'Minimal' }
    ];
    case 'toggle': return [
      { v:'square', name:'Square' },
      { v:'pill',   name:'Pill' },
      { v:'icon',   name:'Icon' }
    ];
    case 'led': return [
      { v:'dot',  name:'Dot' },
      { v:'bar',  name:'Bar' },
      { v:'ring', name:'Ring' }
    ];
    case 'joystick': return [
      { v:'classic', name:'Classic' },
      { v:'neon',    name:'Neon' },
      { v:'min',     name:'Minimal' }
    ];
    case 'label': return [
      { v:'plain', name:'Plain' },
      { v:'card',  name:'Card' },
      { v:'glow',  name:'Glow' }
    ];
    case 'gauge': return [
      { v:'classic', name:'Classic' },
      { v:'neon',    name:'Neon' },
      { v:'min',     name:'Minimal' }
    ];
    case 'graph': return [
      { v:'grid',    name:'Grid' },
      { v:'dark',    name:'Dark' },
      { v:'min',     name:'Minimal' }
    ];
    default: return null;
  }
}

// BLE send with verbose debug logging
async function send(msg) {
  console.log('[BLE] Attempting to send:', msg);
  
  if (!state.ble.writeChar) {
    console.log('[BLE] ERROR: No writeChar available');
    return;
  }
  
  // Check if still connected
  const gattConnected = state.ble.device?.gatt?.connected;
  console.log('[BLE] GATT connected:', gattConnected);
  
  if (!gattConnected) {
    console.log('[BLE] ERROR: GATT disconnected, triggering onDisconnect');
    onDisconnect();
    return;
  }
  
  try {
    console.log('[BLE] Writing value...');
    await state.ble.writeChar.writeValue(encoder.encode(msg + '\n'));
    console.log('[BLE] Write SUCCESS');
  } catch (err) { 
    console.error('[BLE] Write FAILED:', err.name, err.message);
    // If write fails with certain errors, assume disconnected
    if (err.message?.includes('GATT') || err.message?.includes('disconnected')) {
      console.log('[BLE] Triggering disconnect due to GATT error');
      onDisconnect();
    }
  }
}

// One-click Demo - creates full showcase with all widgets
function showDemo() {
  // Create a demo with ALL widget types
  state.widgets = [
    { id: 'btn_jump', t: 'button', x: 20, y: 20, w: 100, h: 100, label: 'Jump!', model:'neo' },
    { id: 'btn_fire', t: 'button', x: 140, y: 20, w: 100, h: 100, label: 'Fire!', model:'glass' },
    { id: 'slider_speed', t: 'slider', x: 260, y: 20, w: 90, h: 180, label: 'Speed', model:'track', min:0, max:100, step:1 },
    { id: 'slider_power', t: 'slider', x: 370, y: 20, w: 90, h: 180, label: 'Power', model:'neon', min:0, max:100, step:1 },
    { id: 'toggle_turbo', t: 'toggle', x: 20, y: 140, w: 100, h: 100, label: 'Turbo', model:'pill' },
    { id: 'toggle_shield', t: 'toggle', x: 140, y: 140, w: 100, h: 100, label: 'Shield', model:'icon' },
    { id: 'joy_move', t: 'joystick', x: 20, y: 260, w: 140, h: 140, label: 'Move', model:'ring' },
    { id: 'led_status', t: 'led', x: 180, y: 260, w: 100, h: 100, label: 'Status', model:'dot', colorOn:'#00e676', colorOff:'#1b2a3a' },
    { id: 'led_alert', t: 'led', x: 300, y: 260, w: 100, h: 100, label: 'Alert', model:'ring', colorOn:'#ff5252', colorOff:'#1b2a3a' },
    { id: 'label_score', t: 'label', x: 180, y: 380, w: 220, h: 50, label: 'Score: 0', model:'chip' },

    { id: 'gauge_temp', t: 'gauge', x: 20, y: 430, w: 150, h: 170, label: 'Temp', min: 0, max: 50, units: 'Â°C', decimals: 1, model:'classic' },
    { id: 'gauge_level', t: 'gauge', x: 190, y: 430, w: 150, h: 170, label: 'Level', min: 0, max: 100, units: '%', decimals: 0, model:'neon' },
    { id: 'graph_env', t: 'graph', x: 20, y: 610, w: 370, h: 170, label: 'Online Graph', series: 2, windowSec: 30, autoScale: true, model:'grid' }
  ];
  state.widgets = state.widgets.map(applyWidgetDefaults);
  state.nextId = 20;
  state.selected = null;
  $('#titleInput').value = 'Super Demo Remote';
  renderWidgets();
  renderPropsPanel();
  
  // Show the code modal with demo code
  const cfg = { title: 'Super Demo Remote', widgets: state.widgets };
  // Load demo into runtime immediately (no micro:bit required)
  state.config = cfg;
  state.values = state.values || {};
  renderRuntime();
  startDemoSim();
  $('#modalTitle').textContent = 'Demo Ready! Copy this code to MakeCode:';
  $('#modalCode').textContent = generateDemoCode(cfg);
  $('#modalBg').classList.add('show');
  
  toast('Demo loaded with ALL widgets!', 'success');
}

function generateDemoCode(cfg) {
  // Unicode-safe base64 encoding (handles emojis!)
  const b64 = btoa(unescape(encodeURIComponent(JSON.stringify(cfg))));
  
  // Group widgets by type
  const buttons = cfg.widgets.filter(w => w.t === 'button');
  const sliders = cfg.widgets.filter(w => w.t === 'slider');
  const toggles = cfg.widgets.filter(w => w.t === 'toggle');
  const joysticks = cfg.widgets.filter(w => w.t === 'joystick');
  const leds = cfg.widgets.filter(w => w.t === 'led');
  const labels = cfg.widgets.filter(w => w.t === 'label');
  const gauges = cfg.widgets.filter(w => w.t === 'gauge');
  const graphs = cfg.widgets.filter(w => w.t === 'graph');
  
  // Generate handler code for each widget
  let buttonCode = buttons.map(w => `    // Button: ${w.label || w.id}
    if (id == "${w.id}" && val == "1") {
        basic.showIcon(IconNames.Heart)
        // Add your code here!
    }`).join('\n');
  
  let sliderCode = sliders.map(w => `    // Slider: ${w.label || w.id} (val = 0-100)
    if (id == "${w.id}") {
        let value = parseInt(val)
        led.plotBarGraph(value, 100)
        // Use value for motors, sounds, etc!
    }`).join('\n');
  
  let toggleCode = toggles.map(w => `    // Toggle: ${w.label || w.id} (val = "1" or "0")
    if (id == "${w.id}") {
        if (val == "1") {
            basic.showIcon(IconNames.Yes)
        } else {
            basic.showIcon(IconNames.No)
        }
    }`).join('\n');
  
  let joystickCode = joysticks.map(w => `    // Joystick: ${w.label || w.id} (val = "angle distance")
    if (id == "${w.id}") {
        let parts = val.split(" ")
        let angle = parseInt(parts[0])  // -180 to 180
        let dist = parseInt(parts[1])   // 0 to ~50
        // Use for steering, movement, etc!
        if (dist > 10) {
            basic.showArrow(angle > 0 ? ArrowNames.East : ArrowNames.West)
        } else {
            basic.showLeds(\`
                . . . . .
                . . # . .
                . # # # .
                . . # . .
                . . . . .
            \`)
        }
    }`).join('\n');

  let ledList = leds.map(w => `//   sendValue("${w.id}", "1")  // Turn ON ${w.label || 'LED'}
//   sendValue("${w.id}", "0")  // Turn OFF`).join('\n');

  let labelList = labels.map(w => `//   sendValue("${w.id}", "Hello!")  // Update ${w.label || 'label'}`).join('\n');

  return `// ${cfg.title} - micro:bit Remote
// Copy this to MakeCode: https://makecode.microbit.org
// Then flash it to your micro:bit!

bluetooth.startUartService()
let cfgSent = false
let blinkState = false
const CFG = "${b64}"

// This sends the remote layout to the app
bluetooth.onUartDataReceived(serial.delimiters(Delimiters.NewLine), function() {
    let cmd = bluetooth.uartReadUntil(serial.delimiters(Delimiters.NewLine))
    
    if (cmd == "GETCFG") {
        bluetooth.uartWriteLine("CFGBEGIN")
        for (let i = 0; i < CFG.length; i += 18) {
            bluetooth.uartWriteLine("CFG " + CFG.substr(i, 18))
        }
        bluetooth.uartWriteLine("CFGEND")
        cfgSent = true
        basic.showIcon(IconNames.Yes)
    } 
    else if (cmd.indexOf("SET ") == 0) {
        let parts = cmd.substr(4).split(" ")
        let id = parts[0]
        let val = parts.slice(1).join(" ")
        handleWidget(id, val)
    }
})

// HANDLE YOUR WIDGETS HERE!
function handleWidget(id: string, val: string) {
    serial.writeLine(id + " = " + val)
    
${buttonCode || '    // No buttons in this remote'}

${sliderCode || '    // No sliders in this remote'}

${toggleCode || '    // No toggles in this remote'}

${joystickCode || '    // No joysticks in this remote'}
}

// Send values TO the app (for LEDs and Labels)
function sendValue(id: string, val: string) {
    if (cfgSent) bluetooth.uartWriteLine("UPD " + id + " " + val)
}

// Show we are ready!
basic.showIcon(IconNames.Heart)

// BLINK THE APP LEDs! This runs forever in background
basic.forever(function() {
    if (cfgSent) {
        blinkState = !blinkState
        ${leds.length > 0 ? leds.map(l => `sendValue("${l.id}", blinkState ? "1" : "0")`).join('\n        ') : '// No LEDs to blink'}
        ${labels.length > 0 ? `sendValue("${labels[0].id}", blinkState ? "ON!" : "OFF")` : ''}
        // Demo updates for Gauges (single value) and Graphs (comma-separated)
        let t = input.runningTime()
        ${gauges.length > 0 ? gauges.map((g,i)=>`sendValue("${g.id}", "" + (Math.round((Math.sin((t/1000)+${i}) + 1) * 25)))`).join("\n        ") : "// No gauges to update"}
        ${graphs.length > 0 ? graphs.map((g,i)=>`sendValue("${g.id}", "" + (Math.round((Math.sin((t/900)+${i}) + 1) * 50)) + "," + (Math.round((Math.cos((t/1100)+${i}) + 1) * 50)))`).join("\n        ") : "// No graphs to update"}
    }
    basic.pause(200)
})

// BONUS: Use micro:bit buttons too!
input.onButtonPressed(Button.A, function() {
    basic.showString("A")
    ${leds.length > 0 ? `sendValue("${leds[0].id}", "1")` : '// Add an LED to control it here!'}
})
input.onButtonPressed(Button.B, function() {
    basic.showString("B")
    ${leds.length > 0 ? `sendValue("${leds[0].id}", "0")` : '// Add an LED to control it here!'}
})`;
}

function init() {
  state._allowLoadingOverlay = false;
  if (typeof hideLoading === 'function') hideLoading();
  // Tabs
  $$('.tab').forEach(t => t.onclick = () => switchTab(t.dataset.tab));
  
  // Templates
  $$('.template-card').forEach(c => c.onclick = () => selectTemplate(c.dataset.tpl));
  
  // Palette - tap to select
  $$('.palette-item').forEach(p => {
    p.onclick = () => {
      $$('.palette-item').forEach(x => x.classList.remove('selected'));
      p.classList.add('selected');
      state.selectedType = p.dataset.type;
      toast(`âœ… ${ICONS[state.selectedType]} selected! Tap canvas to place`, 'success');
    };
  });
  
  // Canvas - tap to place
  $('#canvas').onclick = e => {
    if (e.target.closest('.widget')) return;
    if (state.selectedType) {
      const rect = $('#canvas').getBoundingClientRect();
      const [w, h] = SIZES[state.selectedType];
      const x = Math.max(0, Math.min(e.clientX - rect.left - w/2, rect.width - w));
      const y = Math.max(0, Math.min(e.clientY - rect.top - h/2, rect.height - h));
      const base = applyWidgetDefaults({ id: `${state.selectedType}${state.nextId++}`, t: state.selectedType, x, y, w, h, label: '' });
      state.widgets.push(base);
      renderWidgets();
      toast(`âœ¨ ${ICONS[state.selectedType]} added!`, 'success');
    } else {
      state.selected = null;
      renderWidgets();
      renderPropsPanel();
    }
  };
  
  // Buttons
  $('#soundBtn').onclick = () => { state.soundOn = !state.soundOn; updateSoundUI(); if (state.soundOn) beepClick(); };
  updateSoundUI();
  $('#bleBtn').onclick = connectBle;
  $('#connectBtn').onclick = connectBle;
  $('#demoBtn').onclick = showDemo;
    // Templates
  $('#templateBtn').onclick = () => $('#templateModal').classList.remove('hidden');
  // Language on first load
  var savedLang = loadLang();
  setLang(savedLang || state.lang || detectBrowserLang());
  $('#templateModal').classList.remove('hidden');
  var _ov=$('#loadingOverlay');
  if (_ov) _ov.onclick = () => { state._allowLoadingOverlay=false; hideLoading(); };
  if (typeof hideLoadOverlay==='function') hideLoadOverlay();
  $('#codeBtn').onclick = showCode;
  $('#deleteBtn').onclick = deleteSelected;

  // JSON Export / Import + Language
  const jsonIn = $('#jsonFileInput');
  if (jsonIn){
    jsonIn.onchange = e => {
      const f = e.target.files && e.target.files[0];
      if (f) importLayoutJsonFile(f);
      e.target.value = '';
    };
  }
  const exp = $('#exportJsonBtn'); if (exp) exp.addEventListener('click', exportLayoutJson);
  const imp = $('#importJsonBtn'); if (imp) imp.addEventListener('click', () => $('#jsonFileInput').click());
  const lb = $('#langBtn'); if (lb) lb.addEventListener('click', cycleLang);
  $('#modalClose').onclick = () => $('#modalBg').classList.remove('show');
  $('#modalBg').onclick = e => { if (e.target === $('#modalBg')) $('#modalBg').classList.remove('show'); };
  $('#copyBtn').onclick = () => { navigator.clipboard.writeText($('#modalCode').textContent); toast('ðŸ“‹ Copied!', 'success'); };
  $('#downloadBtn').onclick = downloadCode;
  
    // Language on first load
  var savedLang = loadLang();
  setLang(savedLang || state.lang || detectBrowserLang());
  $('#templateModal').classList.remove('hidden');
  var _ov=$('#loadingOverlay');
  if (_ov) _ov.onclick = () => { state._allowLoadingOverlay=false; hideLoading(); };
  if (typeof hideLoadOverlay==='function') hideLoadOverlay();
}

function selectTemplate(name) {
  const t = templates[name];
  if (!t) return;

  // Kids-friendly loading overlay while building a template
  if (typeof showLoadOverlay === 'function') {
    const titles = {
      gamepad: 'ðŸŽ® Building Game Pad...',
      robot: 'ðŸ¤– Building Robot Remote...',
      mixer: 'ðŸŽµ Building DJ Mixer...',
      racing: 'ðŸŽï¸ Building Race Car...',
      lights: 'ðŸ’¡ Building Lights Panel...',
      blank: 'âœ¨ Preparing Blank Canvas...'
    };
    showBuildOverlay(titles[name] || 'âœ¨ Building...');
  }

  // Small delay so the overlay is visible and feels animated
  setTimeout(() => {
    state.widgets = t.map((w, i) => ({ id: `${w.t}${state.nextId + i}`, ...w }));
    state.nextId += t.length || 1;

    // Apply defaults for new widget types / models
    if (typeof applyWidgetDefaults === 'function') {
      state.widgets.forEach(applyWidgetDefaults);
    }

    state.selected = null;
    $('#templateModal').classList.add('hidden');
    renderWidgets();
    renderPropsPanel();

    if (typeof showLoadOverlay === 'function') showBuildOverlay(titles[name] || 'âœ¨ Building...');
    if (typeof hideLoadOverlay === 'function') hideLoadOverlay();

    if (name === 'blank') toast('âœ¨ Canvas ready! Pick a widget below', 'success');
    else toast('âœ… Template loaded!', 'success');
  }, 250);
}

function switchTab(tab) {
  $$('.tab').forEach(t => t.classList.toggle('active', t.dataset.tab === tab));
  $$('.view').forEach(v => v.classList.remove('active'));
  $(`.${tab === 'builder' ? 'builder-view' : 'runtime-view'}`).classList.add('active');
  if (tab === 'runtime') startDemoSim(); else stopDemoSim();
}

function renderWidgets() {
  const layer = $('#widgetsLayer');
  layer.innerHTML = '';
  state.widgets.forEach(w => {
    const el = document.createElement('div');
    el.className = 'widget' + (state.selected === w.id ? ' selected' : '');
    el.dataset.id = w.id;
    el.style.cssText = `left:${w.x}px;top:${w.y}px;width:${w.w}px;height:${w.h}px`;
    el.innerHTML = `<div class="widget-icon">${ICONS[w.t]}</div><div class="widget-label">${esc(w.label) || w.t}</div><div class="resize-handle"></div>`;
    layer.appendChild(el);
    
    interact(el).draggable({
      inertia: true,
      modifiers: [interact.modifiers.restrictRect({ restriction: 'parent' })],
      listeners: {
        start() { state.selected = w.id; updateSelectionUI(); },
        move(e) {
          state.justDragged = true;
          clearTimeout(state._dragT);
          state._dragT = setTimeout(() => state.justDragged = false, 50);
          w.x += e.dx; w.y += e.dy;
          e.target.style.left = w.x + 'px';
          e.target.style.top = w.y + 'px';
        }
      }
    }).resizable({
      edges: { right: true, bottom: true },
      modifiers: [interact.modifiers.restrictSize({ min: { width: 60, height: 60 } })],
      listeners: {
        move(e) {
          w.w = e.rect.width; w.h = e.rect.height;
          e.target.style.width = w.w + 'px';
          e.target.style.height = w.h + 'px';
        }
      }
    });
    
    el.onclick = e => { e.stopPropagation(); state.selected = w.id; updateSelectionUI(); };
  });
}


function updateSelectionUI() {
  $$('.widget').forEach(el => el.classList.toggle('selected', el.dataset.id === state.selected));
  renderPropsPanel();
}

function getSelectedWidget(){
  return state.widgets.find(w => w.id === state.selected);
}

function renderPropsPanel(){
  const form = $('#propsForm');
  const empty = $('#propsEmpty');
  const w = getSelectedWidget();

  if (!form || !empty) return;

  if (!w){
    empty.style.display = 'block';
    form.style.display = 'none';
    form.innerHTML = '';
    return;
  }

  empty.style.display = 'none';
  form.style.display = 'block';

  // Common fields
  let html = `
    <label>Widget ID</label>
    <input id="prop_id" value="${esc(w.id)}" />

    <label>Label</label>
    <input id="prop_label" value="${esc(w.label || '')}" />
  `;

  // Model selector (3 presets per widget type)
  const opts = modelOptionsForType(w.t);
  if (opts){
    html += `
      <label>Model</label>
      <select id="prop_model">
        ${opts.map(o => `<option value="${o.v}" ${w.model === o.v ? 'selected' : ''}>${o.name}</option>`).join('')}
      </select>
      <button class="props-apply" id="prop_applyAll">Apply this model to ALL ${w.t}s</button>
    `;
  }

  // Type-specific fields
  if (w.t === 'led'){
    html += `
      <label>LED On Color</label>
      <input id="prop_colorOn" type="color" value="${w.colorOn || '#ff5252'}" />

      <label>LED Off Color</label>
      <input id="prop_colorOff" type="color" value="${w.colorOff || '#2a2a3a'}" />
    `;
  }

  if (w.t === 'slider'){
    html += `
      <label>Min</label>
      <input id="prop_min" type="number" value="${w.min ?? 0}" />

      <label>Max</label>
      <input id="prop_max" type="number" value="${w.max ?? 100}" />

      <label>Step</label>
      <input id="prop_step" type="number" value="${w.step ?? 1}" />
    `;
  }

  
  if (w.t === 'gauge'){
    html += `
      <label>Min</label>
      <input id="prop_gmin" type="number" value="${w.min ?? 0}" />

      <label>Max</label>
      <input id="prop_gmax" type="number" value="${w.max ?? 100}" />

      <label>Decimals</label>
      <input id="prop_gdec" type="number" value="${w.decimals ?? 0}" />

      <label>Units (optional)</label>
      <input id="prop_gunits" value="${esc(w.units || '')}" />

      <label>Warn (optional)</label>
      <input id="prop_gwarn" type="number" value="${w.warn ?? ''}" />

      <label>Danger (optional)</label>
      <input id="prop_gdanger" type="number" value="${w.danger ?? ''}" />
    `;
  }

  if (w.t === 'graph'){
    html += `
      <label>Series (1-10)</label>
      <input id="prop_series" type="number" min="1" max="10" value="${w.series ?? 1}" />

      <label>Window (seconds)</label>
      <input id="prop_window" type="number" min="5" max="120" value="${w.windowSec ?? 30}" />

      <label>Auto scale</label>
      <select id="prop_autoscale">
        <option value="1" ${w.autoScale !== false ? 'selected' : ''}>Yes</option>
        <option value="0" ${w.autoScale === false ? 'selected' : ''}>No</option>
      </select>

      <label>Fixed Min (when auto off)</label>
      <input id="prop_ymin" type="number" value="${w.yMin ?? 0}" />

      <label>Fixed Max (when auto off)</label>
      <input id="prop_ymax" type="number" value="${w.yMax ?? 100}" />

      <label>Series Names (comma separated)</label>
      <input id="prop_names" value="${esc((w.seriesNames || '').toString())}" placeholder="Temp,Level,Power" />

      <label>Y Axis Label (optional)</label>
      <input id="prop_ylabel" value="${esc(w.yLabel || '')}" placeholder="Â°C / % / rpm" />
    `;
  }

form.innerHTML = html;

  // Wire events
  $('#prop_label').oninput = e => {
    w.label = e.target.value;
    const el = $(`.widget[data-id="${w.id}"] .widget-label`);
    if (el) el.textContent = w.label || w.t;
  };

  $('#prop_id').onchange = e => {
    const newId = e.target.value.trim();
    if (!newId || state.widgets.some(x => x.id === newId && x !== w)){
      toast('âŒ ID must be unique', 'error');
      e.target.value = w.id;
      return;
    }
    const oldId = w.id;
    w.id = newId;

    const root = $(`.widget[data-id="${oldId}"]`);
    if (root) root.dataset.id = newId;

    if (state.values[oldId] != null){
      state.values[newId] = state.values[oldId];
      delete state.values[oldId];
    }

    state.selected = newId;
    updateSelectionUI();
    toast('âœ… ID updated', 'success');
  };

  // Model wiring (and quick apply to all widgets of same type)
  const modelSel = $('#prop_model');
  if (modelSel){
    modelSel.onchange = e => { w.model = e.target.value; toast('âœ… Model updated', 'success'); };
  }
  const applyBtn = $('#prop_applyAll');
  if (applyBtn){
    applyBtn.onclick = () => {
      const val = w.model;
      state.widgets.forEach(x => { if (x.t === w.t) x.model = val; });
      if (state.config?.widgets) state.config.widgets.forEach(x => { if (x.t === w.t) x.model = val; });
      renderWidgets();
      if (state.config) renderRuntime();
      toast(`âœ¨ Applied model to all ${w.t}s`, 'success');
    };
  }


  if (w.t === 'led'){
    $('#prop_colorOn').oninput = e => { w.colorOn = e.target.value; };
    $('#prop_colorOff').oninput = e => { w.colorOff = e.target.value; };
  }

  if (w.t === 'slider'){
    $('#prop_min').oninput = e => { w.min = parseFloat(e.target.value); };
    $('#prop_max').oninput = e => { w.max = parseFloat(e.target.value); };
    $('#prop_step').oninput = e => { w.step = parseFloat(e.target.value); };
  }

  if (w.t === 'gauge'){
    $('#prop_gmin').oninput = e => { w.min = parseFloat(e.target.value); if (state.config) renderRuntime(); };
    $('#prop_gmax').oninput = e => { w.max = parseFloat(e.target.value); if (state.config) renderRuntime(); };
    $('#prop_gdec').oninput = e => { w.decimals = parseInt(e.target.value, 10); if (state.config) renderRuntime(); };
    $('#prop_gunits').oninput = e => { w.units = e.target.value; if (state.config) renderRuntime(); };
    $('#prop_gwarn').oninput = e => { w.warn = e.target.value === '' ? null : parseFloat(e.target.value); };
    $('#prop_gdanger').oninput = e => { w.danger = e.target.value === '' ? null : parseFloat(e.target.value); };
  }

  if (w.t === 'graph'){
    $('#prop_series').oninput = e => { w.series = Math.max(1, Math.min(10, parseInt(e.target.value, 10) || 1)); if (state.config) renderRuntime(); };
    $('#prop_window').oninput = e => { w.windowSec = Math.max(5, parseInt(e.target.value, 10) || 30); };
    $('#prop_autoscale').onchange = e => { w.autoScale = (e.target.value === '1'); };
    $('#prop_ymin').oninput = e => { w.yMin = parseFloat(e.target.value); };
    $('#prop_ymax').oninput = e => { w.yMax = parseFloat(e.target.value); };
    $('#prop_names').oninput = e => { w.seriesNames = e.target.value; if (state.config) renderRuntime(); };
    $('#prop_ylabel').oninput = e => { w.yLabel = e.target.value; };
  }

}


function deleteSelected() {
  if (!state.selected) { toast('ðŸ‘† Select a widget first!', 'error'); return; }
  state.widgets = state.widgets.filter(w => w.id !== state.selected);
  state.selected = null;
  renderWidgets();
  renderPropsPanel();
  toast('ðŸ—‘ï¸ Deleted!', 'success');
}

function showCode() {
  if (state.widgets.length === 0) {
    toast('ðŸ‘† Add some widgets first!', 'error');
    return;
  }
  const cfg = { title: $('#titleInput').value || 'My Remote', widgets: state.widgets };
  $('#modalTitle').textContent = 'ðŸ“„ Your micro:bit Code';
  $('#modalCode').textContent = generateDemoCode(cfg);
  $('#modalBg').classList.add('show');
}

function downloadCode() {
  const blob = new Blob([$('#modalCode').textContent], { type: 'text/plain' });
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
  a.download = 'microbit-remote.ts'; a.click();
  toast('ðŸ’¾ Downloaded!', 'success');
}

function toast(msg, type = '') {
  const t = $('#toast'); t.textContent = msg;
  t.className = `toast ${type} show`;
  setTimeout(() => t.classList.remove('show'), 2500);
}



function showBuildOverlay(sub='âœ¨ Building...'){
  const ov = $('#loadingOverlay');
  if (!ov) return;
  ov.classList.add('show');
  ov.setAttribute('aria-hidden','false');
  const subEl = $('#loadingSub'); if (subEl) subEl.textContent = sub;
  const pctEl = $('#loadingPct'); if (pctEl) pctEl.textContent = '';
  const bar = $('#loadingBarFill'); if (bar) bar.style.width = '100%';
}

// Loading overlay helpers
let _loadingIndeterminate = null;
function showLoading(title = 'ðŸ§© Loading your remote...', sub = 'Getting layout from micro:bit'){
  if (!state._allowLoadingOverlay) return;
  const ov = $('#loadingOverlay');
  if (!ov) return;
  ov.classList.add('show');
  ov.setAttribute('aria-hidden','false');
  const subEl = $('#loadingSub'); if (subEl) subEl.textContent = sub;
  const pctEl = $('#loadingPct'); if (pctEl) pctEl.textContent = '0%';
  const bar = $('#loadingBarFill'); if (bar) bar.style.width = '8%';

  clearInterval(_loadingIndeterminate);
  // fun, kid-friendly "wiggle" while chunks arrive
  let p = 8; let dir = 1;
  _loadingIndeterminate = setInterval(() => {
    p += dir * 3;
    if (p > 22) { p = 22; dir = -1; }
    if (p < 8)  { p = 8;  dir = 1; }
    if (bar) bar.style.width = p + '%';
  }, 220);
}

function setLoadingProgress(pct, sub){
  const bar = $('#loadingBarFill');
  const pctEl = $('#loadingPct');
  const subEl = $('#loadingSub');
  if (subEl && sub) subEl.textContent = sub;
  const clamped = Math.max(0, Math.min(100, pct));
  if (bar) bar.style.width = clamped + '%';
  if (pctEl) pctEl.textContent = Math.round(clamped) + '%';
}

function hideLoading(){
  const ov = $('#loadingOverlay');
  if (!ov) return;
  clearInterval(_loadingIndeterminate);
  _loadingIndeterminate = null;
  ov.classList.remove('show');
  ov.setAttribute('aria-hidden','true');
}

// BLE Connection
async function connectBle() {
  console.log('[BLE] Starting connection...');
  state._allowLoadingOverlay = true;
  try {
    console.log('[BLE] Requesting device...');
    const device = await navigator.bluetooth.requestDevice({
      filters: [{ namePrefix: 'BBC micro:bit' }],
      optionalServices: [UART_SERVICE]
    });
    console.log('[BLE] Device selected:', device.name);
    
    device.addEventListener('gattserverdisconnected', () => {
      console.log('[BLE] GATT server disconnected event');
      onDisconnect();
    });
    
    console.log('[BLE] Connecting to GATT server...');
    const server = await device.gatt.connect();
    console.log('[BLE] GATT connected');
    
    console.log('[BLE] Getting UART service...');
    const service = await server.getPrimaryService(UART_SERVICE);
    console.log('[BLE] UART service found');
    
    console.log('[BLE] Getting TX characteristic...');
    const notifyChar = await service.getCharacteristic(UART_TX_CHAR);
    console.log('[BLE] TX characteristic found');
    
    console.log('[BLE] Getting RX characteristic...');
    const writeChar = await service.getCharacteristic(UART_RX_CHAR);
    console.log('[BLE] RX characteristic found');
    
    console.log('[BLE] Starting notifications...');
    await notifyChar.startNotifications();
    notifyChar.addEventListener('characteristicvaluechanged', onNotify);
    console.log('[BLE] Notifications started');
    
    state.ble = { device, server, service, notifyChar, writeChar, connected: true };
    state.rxBuffer = '';
    updateBleUI();
    toast('Connected!', 'success');
    
    console.log('[BLE] Waiting 500ms then sending GETCFG...');
    showLoading('ðŸ§© Loading your remote...', 'Requesting layout (GETCFG)â€¦');
    setTimeout(() => { 
      console.log('[BLE] Sending GETCFG now');
      state.rxBuffer = ''; 
      send('GETCFG'); 
    }, 500);
  } catch (err) {
    console.error('[BLE] Connection error:', err);
    toast('Connection failed', 'error');
  }
}

function onDisconnect() {
  console.log('[BLE] Disconnected!');
  state._allowLoadingOverlay = false;
  if (typeof hideLoading==='function') hideLoading();
  state.ble = { device:null, server:null, service:null, notifyChar:null, writeChar:null, connected:false };
  updateBleUI();
  hideLoading();
  beepDanger();
  toast('Disconnected', 'error');
}

function updateBleUI() {
  const btn = $('#bleBtn');
  if (state.ble.connected) {
    btn.classList.add('connected');
    btn.querySelector('span:last-child').textContent = (I18N[state.lang]||I18N.en).connected;
    $('#connectPrompt').style.display = 'none';
    $('#runtimeContent').style.display = 'flex';
  } else {
    btn.classList.remove('connected');
    btn.querySelector('span:last-child').textContent = (I18N[state.lang]||I18N.en).connect;
    $('#connectPrompt').style.display = 'block';
    $('#runtimeContent').style.display = 'none';
  }
}

let configBuffer = '';
    configChunks = 0;
    showLoading('ðŸ§© Loading your remote...', 'Receiving layoutâ€¦');
    setLoadingProgress(12, 'Receiving layoutâ€¦');
var configChunks = 0;
function onNotify(event) {
  const value = event.target.value;
  let str = '';
  for (let i = 0; i < value.byteLength; i++) {
    const byte = value.getUint8(i);
    if (byte !== 13) str += String.fromCharCode(byte);
  }
  console.log('[BLE RX] Received:', str.replace(/\n/g, '\\n'));
  state.rxBuffer += str;
  let nl;
  while ((nl = state.rxBuffer.indexOf('\n')) !== -1) {
    const line = state.rxBuffer.slice(0, nl).trim();
    state.rxBuffer = state.rxBuffer.slice(nl + 1);
    if (line) processLine(line);
  }
}

function processLine(line) {
  console.log('[BLE] Processing line:', line);
  if (line.startsWith('CFGBEGIN')) {
    console.log('[BLE] Config begin');
    configBuffer = '';
  }
  else if (line.startsWith('CFG ')) {
    configBuffer += line.substring(4);
    configChunks++;
    setLoadingProgress(Math.min(90, 12 + configChunks * 4), `Receiving layoutâ€¦ (${configChunks} chunks)`);
    console.log('[BLE] Config chunk, total length:', configBuffer.length);
  }
  else if (line === 'CFGEND') {
    console.log('[BLE] Config end, decoding...');
    setLoadingProgress(96, 'Decoding layoutâ€¦');
    try { 
      // Unicode-safe base64 decoding (handles emojis!)
      state.config = JSON.parse(decodeURIComponent(escape(atob(configBuffer))));
      if (state.config?.widgets) state.config.widgets.forEach(applyWidgetDefaults); 
      console.log('[BLE] Config decoded:', state.config);
      renderRuntime();
      setLoadingProgress(100, 'Ready!');
      setTimeout(hideLoading, 250);
      state._allowLoadingOverlay = false;
      hideLoading();
      toast('Remote loaded!', 'success'); 
    }
    catch(e) { console.error('[BLE] Config parse error:', e); hideLoading();
      toast('Config error', 'error'); }
  } else if (line.startsWith('UPD ')) {
    const parts = line.substring(4).split(' ');
    const id = parts[0];
    const val = parts.slice(1).join(' ');
    console.log('[BLE] Update widget:', id, '=', val);
    state.values[id] = val;
    updateRuntimeWidget(id, val);
  }
}

function renderRuntime() {
  if (!state.config) return;
  const cfg = state.config;
  $('#runtimeTitle').textContent = cfg.title || 'My Remote';
  const grid = $('#runtimeGrid');
  let maxX = 0, maxY = 0;
  cfg.widgets.forEach(w => { maxX = Math.max(maxX, w.x + w.w); maxY = Math.max(maxY, w.y + w.h); });
  grid.style.width = `${Math.max(400, maxX + 20)}px`;
  grid.style.height = `${Math.max(320, maxY + 20)}px`;
  grid.innerHTML = '';
  cfg.widgets.forEach(w => {
    const el = document.createElement('div');
    el.className = 'rt-widget'; el.dataset.id = w.id;
    el.style.cssText = `left:${w.x}px;top:${w.y}px;width:${w.w}px;height:${w.h}px`;
    el.innerHTML = createRuntimeWidget(w);
    grid.appendChild(el);
    bindRuntimeWidget(el, w);
  });

  // Initial draw for graphs & gauges
  cfg.widgets.forEach(w => {
    applyWidgetDefaults(w);
    if (w.t === 'graph') drawGraphWidget(w);
    if (w.t === 'gauge') updateGaugeWidget(w, state.values[w.id] || '0');
  });
}


function createRuntimeWidget(w) {
  const val = esc(state.values[w.id] || '0');
  const label = esc(w.label || w.t);
  const rawVal = state.values[w.id] || '0';
  const model = (w.model || '').trim();

  switch (w.t) {
    case 'button': {
      const m = model || 'neo';
      return `<button class="rt-button model-${m}"><span class="icon">ðŸ‘†</span><span>${label}</span></button>`;
    }

    case 'slider': {
      const m = model || 'track';
      const min = (w.min ?? 0);
      const max = (w.max ?? 100);
      const step = (w.step ?? 1);
      const clamped = Math.max(min, Math.min(max, parseFloat(rawVal) || min));
      return `<div class="rt-slider-wrap">
        <div class="rt-slider-info"><span>${label}</span><span class="rt-slider-val">${esc(String(clamped))}</span></div>
        <input type="range" class="rt-slider model-${m}" min="${min}" max="${max}" step="${step}" value="${clamped}">
      </div>`;
    }

    case 'toggle': {
      const m = model || 'square';
      const on = rawVal === '1';
      const glyph = m === 'icon' ? (on ? 'â»' : 'â­˜') : (on ? 'âœ“' : 'â—‹');
      return `<div class="rt-toggle-wrap">
        <button class="rt-toggle model-${m}${on ? ' on' : ''}">${glyph}</button>
        <span>${label}</span>
      </div>`;
    }

    case 'led': {
      const m = model || 'dot';
      const on = rawVal === '1';
      const onColor = w.colorOn || '#ff5252';
      const offColor = w.colorOff || '#2a2a3a';
      const style = (m === 'ring')
        ? `border-color:${on ? onColor : 'rgba(255,255,255,0.18)'};`
        : `background:${on ? onColor : offColor};`;
      const shadow = (m === 'ring')
        ? (on ? `box-shadow:0 0 40px ${onColor};` : 'box-shadow:none;')
        : (on ? `box-shadow:0 0 40px ${onColor};` : 'box-shadow:none;');

      return `<div class="rt-led-wrap">
        <div class="rt-led model-${m}${on ? ' on' : ''}" style="${style}${shadow}"></div>
        <span>${label}</span>
      </div>`;
    }

    case 'joystick': {
      const m = model || 'classic';
      const stickM = m === 'min' ? 'min' : 'classic';
      return `<div class="rt-joystick-wrap">
        <div class="rt-joystick-base model-${m}"><div class="rt-joystick-stick model-${stickM}"></div></div>
        <span>${label}</span>
      </div>`;
    }

    case 'label': {
      const m = model || 'plain';
      return `<div class="rt-label-text model-${m}">${val || label}</div>`;
    }

    case 'gauge': {
      const m = model || 'classic';
      const units = esc(w.units || '');
      const decimals = (w.decimals ?? 0);
      // 11 tick marks across the arc
      const ticks = Array.from({length: 11}, (_, i) => {
        const a = (-180 + (180 * (i/10))) * Math.PI/180; // -180..0
        const cx = 60, cy = 70;
        const r1 = 42, r2 = 50;
        const x1 = cx + Math.cos(a) * r1;
        const y1 = cy + Math.sin(a) * r1;
        const x2 = cx + Math.cos(a) * r2;
        const y2 = cy + Math.sin(a) * r2;
        return `<line x1="${x1.toFixed(1)}" y1="${y1.toFixed(1)}" x2="${x2.toFixed(1)}" y2="${y2.toFixed(1)}" />`;
      }).join('');
      return `<div class="rt-gauge-wrap model-${m}">
        <div class="rt-gauge-svg">
          <svg viewBox="0 0 120 80" width="100%" height="100%">
            <g class="rt-gauge-ticks">${ticks}</g>
            <path class="rt-gauge-bg" d="M10,70 A50,50 0 0 1 110,70" />
            <path class="rt-gauge-fg" data-role="gaugeArc" d="M10,70 A50,50 0 0 1 110,70" />
          </svg>
        </div>
        <div class="rt-gauge-center">
          <div class="rt-gauge-emoji" data-role="gaugeEmoji">ðŸ˜ƒ</div>
          <div class="rt-gauge-value" data-role="gaugeValue">${esc((parseFloat(rawVal)||0).toFixed(decimals))}</div>
          <div class="rt-gauge-label">${label}${units ? ' ' + units : ''}</div>
        </div>
      </div>`;
    }
    
    case 'graph': {
      const m = model || 'grid';
      const win = parseInt(w.windowSec ?? 30, 10) || 30;
      const auto = (w.autoScale !== false);
      const series = Math.max(1, Math.min(10, parseInt(w.series ?? 1, 10) || 1));
      return `<div class="rt-graph-wrap model-${m}">
        <div class="rt-graph-head">
          <span>${label}</span>
          <span data-role="graphLast"></span>
        </div>
        <div class="rt-graph-sub" data-role="graphLegend"></div>
        <canvas class="rt-graph-canvas" data-role="graphCanvas"></canvas>
        <div class="rt-graph-sub">Win:${win}s&nbsp;&nbsp;${auto ? 'Auto' : 'Fixed'}&nbsp;&nbsp;Series:${series}</div>
      </div>`;
    }

    default:
      return `<div>${w.t}</div>`;
  }
}


function bindRuntimeWidget(el, w) {
  switch (w.t) {
    case 'button':
      const btn = el.querySelector('.rt-button');
      const press = e => { 
        e.preventDefault(); 
        console.log('[BUTTON] Pressed:', w.id);
        beepClick();
        send(`SET ${w.id} 1`); 
        btn.style.transform = 'scale(0.9)'; 
      };
      const release = () => { 
        console.log('[BUTTON] Released:', w.id);
        send(`SET ${w.id} 0`); 
        btn.style.transform = ''; 
      };
      btn.onmousedown = btn.ontouchstart = press;
      btn.onmouseup = btn.onmouseleave = btn.ontouchend = release;
      break;
    case 'slider':
      let sliderTimer = null;
      el.querySelector('.rt-slider').oninput = e => {
        el.querySelector('.rt-slider-val').textContent = e.target.value;
        // Debounce: only send after 50ms of no changes
        clearTimeout(sliderTimer);
        sliderTimer = setTimeout(() => {
          console.log('[SLIDER] Sending value:', e.target.value);
          send(`SET ${w.id} ${e.target.value}`);
        }, 50);
      };
      break;
    case 'toggle':
      el.querySelector('.rt-toggle').onclick = function() {
        const on = this.classList.toggle('on');
        this.textContent = on ? 'âœ“' : 'â—‹';
        beepToggle(on);
        send(`SET ${w.id} ${on ? '1' : '0'}`);
      };
      break;
    case 'joystick':
      const stick = el.querySelector('.rt-joystick-stick');
      const base = el.querySelector('.rt-joystick-base');
      let isDown = false;
      let joyTimer = null;
      let lastJoyMsg = '';
      const handleMove = e => {
        if (!isDown) return;
        const rect = base.getBoundingClientRect();
        const centerX = rect.left + rect.width / 2;
        const centerY = rect.top + rect.height / 2;
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        const dx = clientX - centerX;
        const dy = clientY - centerY;
        const angle = Math.atan2(dy, dx) * 180 / Math.PI;
        const distance = Math.min(40, Math.hypot(dx, dy));
        stick.style.transform = `translate(${Math.cos(angle * Math.PI / 180) * distance}px, ${Math.sin(angle * Math.PI / 180) * distance}px)`;
        // Debounce joystick messages
        const msg = `SET ${w.id} ${Math.round(angle)} ${Math.round(distance)}`;
        if (msg !== lastJoyMsg) {
          lastJoyMsg = msg;
          clearTimeout(joyTimer);
          joyTimer = setTimeout(() => {
            console.log('[JOYSTICK] Sending:', msg);
            send(msg);
          }, 50);
        }
      };
      base.onmousedown = () => { console.log('[JOYSTICK] Down'); isDown = true; };
      base.ontouchstart = e => { e.preventDefault(); console.log('[JOYSTICK] Touch start'); isDown = true; };
      document.addEventListener('mousemove', handleMove);
      document.addEventListener('touchmove', handleMove, { passive: false });
      document.addEventListener('mouseup', () => { console.log('[JOYSTICK] Up'); isDown = false; stick.style.transform = ''; clearTimeout(joyTimer); });
      document.addEventListener('touchend', () => { console.log('[JOYSTICK] Touch end'); isDown = false; stick.style.transform = ''; clearTimeout(joyTimer); });
      break;
  }
}


// --- Graph & Gauge helpers ---
state.history = state.history || {}; // { [id]: { points: Array<{t:number, v:number[]}>, colors:string[] } }

function parseCsvNumbers(s){
  return String(s ?? '').split(',').map(x => parseFloat(x.trim())).filter(x => isFinite(x));
}

function ensureGraphState(id, series){
  if (!state.history[id]) state.history[id] = { points: [], colors: [] };
  const hs = state.history[id];
  if (!hs.colors || hs.colors.length !== series){
    // generate distinct-ish hues using HSL (no hard-coded palette)
    hs.colors = Array.from({length: series}).map((_,i)=>`hsl(${(i*360/series)|0} 85% 60%)`);
  }
  return hs;
}

function pushGraphPoint(w, csvVal){
  const nums = parseCsvNumbers(csvVal);
  const series = Math.max(1, Math.min(10, parseInt(w.series ?? 1, 10)));
  const hs = ensureGraphState(w.id, series);
  const now = performance.now();
  const arr = Array.from({length: series}).map((_,i)=> (nums[i] != null ? nums[i] : NaN));
  hs.points.push({ t: now, v: arr });

  // trim window
  const winMs = Math.max(5, Math.min(300, parseFloat(w.windowSec ?? 30))) * 1000;
  const cutoff = now - winMs;
  while (hs.points.length && hs.points[0].t < cutoff) hs.points.shift();
}

function resizeCanvasToDisplaySize(canvas){
  const dpr = window.devicePixelRatio || 1;
  const rect = canvas.getBoundingClientRect();
  const w = Math.max(10, Math.floor(rect.width * dpr));
  const h = Math.max(10, Math.floor(rect.height * dpr));
  if (canvas.width !== w || canvas.height !== h){
    canvas.width = w; canvas.height = h;
    return true;
  }
  return false;
}

function drawGraphWidget(w){
  const root = document.querySelector(`.rt-widget[data-id="${w.id}"]`);
  if (!root) return;
  const canvas = root.querySelector('[data-role="graphCanvas"]');
  if (!canvas) return;

  const dpr = window.devicePixelRatio || 1;
  const rect = canvas.getBoundingClientRect();
  const cssW = Math.max(50, rect.width);
  const cssH = Math.max(40, rect.height);
  const W = Math.floor(cssW * dpr);
  const H = Math.floor(cssH * dpr);
  if (canvas.width !== W || canvas.height !== H){
    canvas.width = W; canvas.height = H;
  }

  const ctx = canvas.getContext('2d');
  // draw in CSS pixels for predictable fonts/line widths
  ctx.setTransform(dpr,0,0,dpr,0,0);
  ctx.clearRect(0,0,cssW,cssH);

  const seriesCount = Math.max(1, Math.min(10, parseInt(w.series ?? 1, 10)));
  const hs = ensureGraphState(w.id, seriesCount);
  const pts = hs.points || [];


  // legend (kid-friendly)
  const legend = root.querySelector('[data-role="graphLegend"]');
  if (legend){
    const names = (w.seriesNames || '').split(',').map(s => s.trim()).filter(Boolean);
    legend.innerHTML = Array.from({length: seriesCount}).map((_,i) => {
      const nm = esc(names[i] || `S${i+1}`);
      return `<span class="legend-item"><span class="rt-graph-dot" data-s="${i}"></span>${nm}</span>`;
    }).join('');
  }

  // layout
  const mL = 36, mR = 10, mT = 10, mB = 22;
  const plotX = mL, plotY = mT;
  const plotW = Math.max(10, cssW - mL - mR);
  const plotH = Math.max(10, cssH - mT - mB);

  // background
  ctx.globalAlpha = 1;
  ctx.fillStyle = 'rgba(0,0,0,0)';
  ctx.fillRect(0,0,cssW,cssH);

  // axes + grid
  ctx.strokeStyle = 'rgba(255,255,255,0.15)';
  ctx.lineWidth = 1;

  // y grid + labels
  ctx.font = '10px system-ui, Segoe UI, sans-serif';
  ctx.fillStyle = 'rgba(255,255,255,0.7)';

  // if no data, draw frame + hint
  ctx.strokeRect(plotX, plotY, plotW, plotH);
  if (pts.length < 2){
    ctx.fillStyle = 'rgba(255,255,255,0.55)';
    ctx.fillText('waiting for UPD...', plotX + 8, plotY + 16);
    // legend colors
    const legend2 = root.querySelector('[data-role="graphLegend"]');
    if (legend2){
      legend2.querySelectorAll('.rt-graph-dot').forEach(dot => {
        const i = parseInt(dot.getAttribute('data-s') || '0', 10);
        dot.style.background = hs.colors[i] || 'var(--accent)';
      });
    }
    return;
  }

  const t0 = pts[0].t;
  const t1 = pts[pts.length-1].t;
  const span = Math.max(0.001, t1 - t0);

  // y scale
  let yMin = Infinity, yMax = -Infinity;
  if (w.autoScale ?? true){
    pts.forEach(p => p.v.forEach(v => { if (isFinite(v)) { yMin = Math.min(yMin, v); yMax = Math.max(yMax, v); } }));
    if (!isFinite(yMin) || !isFinite(yMax)){ yMin = 0; yMax = 1; }
  } else {
    yMin = parseFloat(w.yMin ?? 0);
    yMax = parseFloat(w.yMax ?? 100);
    if (!isFinite(yMin) || !isFinite(yMax)){ yMin = 0; yMax = 1; }
  }
  if (yMin === yMax){ yMin -= 1; yMax += 1; }
  const pad = (yMax - yMin) * 0.08;
  yMin -= pad; yMax += pad;

  const xForT = t => plotX + ((t - t0) / span) * plotW;
  const yForV = v => plotY + plotH - ((v - yMin) / (yMax - yMin)) * plotH;

  // Y ticks
  const yTicks = 4;
  for (let i=0;i<=yTicks;i++){
    const p = i / yTicks;
    const y = plotY + p * plotH;
    ctx.beginPath(); ctx.moveTo(plotX, y); ctx.lineTo(plotX+plotW, y); ctx.stroke();
    const v = (yMax - (yMax - yMin) * p);
    ctx.fillText(v.toFixed(1), 4, y + 3);
  }

  
  // Y axis label
  if ((w.yLabel || '').trim()){
    ctx.save();
    ctx.fillStyle = 'rgba(255,255,255,0.75)';
    ctx.font = '11px system-ui, Segoe UI, sans-serif';
    ctx.translate(12, plotY + plotH/2);
    ctx.rotate(-Math.PI/2);
    ctx.fillText(w.yLabel, 0, 0);
    ctx.restore();
  }

  // X ticks (seconds)
  const xTicks = 4;
  for (let i=0;i<=xTicks;i++){
    const p = i / xTicks;
    const x = plotX + p * plotW;
    ctx.beginPath(); ctx.moveTo(x, plotY); ctx.lineTo(x, plotY+plotH); ctx.stroke();
    const sec = ((t0 + span * p) - t1) / 1000; // negative to 0
    ctx.fillText(sec.toFixed(0) + 's', x - 10, plotY + plotH + 16);
  }

  // draw each series
  hs.colors.forEach((c, si) => {
    ctx.strokeStyle = c;
    ctx.lineWidth = 2;
    ctx.beginPath();
    let started = false;
    for (let i=0;i<pts.length;i++){
      const v = pts[i].v[si];
      if (!isFinite(v)) continue;
      const x = xForT(pts[i].t);
      const y = yForV(v);
      if (!started){ ctx.moveTo(x,y); started = true; }
      else { ctx.lineTo(x,y); }
    }
    if (started) ctx.stroke();
  });

  // update legend dots colors
  const legend2 = root.querySelector('[data-role="graphLegend"]');
  if (legend2){
    legend2.querySelectorAll('.rt-graph-dot').forEach(dot => {
      const i = parseInt(dot.getAttribute('data-s') || '0', 10);
      dot.style.background = hs.colors[i] || 'var(--accent)';
    });
  }
}

function stopDemoSim(){
  if (state._demoTimer){
    clearInterval(state._demoTimer);
    state._demoTimer = null;
  }
}

function startDemoSim(){
  stopDemoSim();
  const hasGraph = !!document.querySelector('.rt-widget[data-id="graph_env"] [data-role="graphCanvas"]');
  const hasGauge = !!document.querySelector('.rt-widget[data-id="gauge_temp"] .rt-gauge-wrap');
  if (!hasGraph && !hasGauge) return;

  let t0 = Date.now();
  state._demoTimer = setInterval(() => {
    const t = (Date.now() - t0) / 1000;

    const temp = 25 + 10 * Math.sin(t / 2);
    const level = 50 + 40 * Math.sin(t / 3);

    state.values['gauge_temp'] = temp.toFixed(1);
    state.values['gauge_level'] = level.toFixed(0);

    updateRuntimeWidget('gauge_temp', state.values['gauge_temp']);
    updateRuntimeWidget('gauge_level', state.values['gauge_level']);

    const s1 = 50 + 25 * Math.sin(t);
    const s2 = 30 + 15 * Math.cos(t * 1.2);
    const csv = `${s1.toFixed(1)},${s2.toFixed(1)}`;
    state.values['graph_env'] = csv;
    updateRuntimeWidget('graph_env', csv);

    const scoreEl = state.config?.widgets?.find(x => x.id === 'label_score');
    if (scoreEl){
      const sc = Math.floor((t * 3) % 999);
      const txt = `Score: ${sc}`;
      state.values['label_score'] = txt;
      updateRuntimeWidget('label_score', txt);
    }
  }, 250);
}


function updateGaugeWidget(w, valStr){
  const root = document.querySelector(`.rt-widget[data-id="${w.id}"]`);
  if (!root) return;
  const wrap = root.querySelector('.rt-gauge-wrap');
  if (!wrap) return;

  const arc = wrap.querySelector('[data-role="gaugeArc"]') || wrap.querySelector('.rt-gauge-fg');
  const txt = wrap.querySelector('[data-role="gaugeValue"]');
  const emo = wrap.querySelector('[data-role="gaugeEmoji"]');

  const min = parseFloat(w.min ?? 0);
  const max = parseFloat(w.max ?? 100);
  const dec = parseInt(w.decimals ?? 0, 10);

  let v = parseFloat(valStr);
  if (!isFinite(v)) v = min;

  const denom = (max - min) || 1;
  const t = Math.max(0, Math.min(1, (v - min) / denom));

  // Match CSS dasharray (half-ish arc). If changed in CSS, keep in sync.
  const L = 157.1;

  // Color zones (kid-friendly)
  const warn = (w.warn != null) ? parseFloat(w.warn) : null;
  const danger = (w.danger != null) ? parseFloat(w.danger) : null;

  let color = 'var(--green)';
  if (danger != null && isFinite(danger) && v >= danger) color = 'var(--red)';
  else if (warn != null && isFinite(warn) && v >= warn) color = 'var(--orange)';
  else color = 'var(--green)';

  if (arc){
    arc.style.strokeDasharray = String(L);
    arc.style.strokeDashoffset = String(L * (1 - t));
    arc.style.stroke = color;
  }

  if (txt){
    const d = isFinite(dec) ? dec : 0;
    txt.textContent = v.toFixed(d);
  }

  if (emo){
    // Cute emoji based on percent
    const pct = Math.round(t * 100);
    emo.textContent = pct < 20 ? 'ðŸ˜´' : pct < 40 ? 'ðŸ™‚' : pct < 60 ? 'ðŸ˜ƒ' : pct < 80 ? 'ðŸ¤©' : 'ðŸš€';
  }
}



function updateRuntimeWidget(id, val) {
  console.log('[UI] Updating widget:', id, 'to', val);
  const el = $(`.rt-widget[data-id="${id}"]`);
  if (!el || !state.config) {
    console.log('[UI] Widget not found or no config');
    return;
  }
  const w = state.config.widgets.find(x => x.id === id);
  if (!w) {
    console.log('[UI] Widget definition not found');
    return;
  }
  console.log('[UI] Widget type:', w.t);
  switch (w.t) {
    case 'slider': el.querySelector('.rt-slider').value = val; el.querySelector('.rt-slider-val').textContent = val; break;
    case 'toggle': el.querySelector('.rt-toggle').classList.toggle('on', val === '1'); el.querySelector('.rt-toggle').textContent = val === '1' ? 'âœ“' : 'â—‹'; break;
    case 'led': {
      const ledEl = el.querySelector('.rt-led');
      const wdef = state.config.widgets.find(x => x.id === id);
      const onColor = wdef?.colorOn || '#ff5252';
      const offColor = wdef?.colorOff || '#2a2a3a';
      const model = (wdef?.model || 'dot');
      const on = val === '1';

      // Ensure model class is present (in case config changed live)
      ledEl.className = `rt-led model-${model}${on ? ' on' : ''}`;

      if (model === 'ring'){
        ledEl.style.background = 'transparent';
        ledEl.style.borderColor = on ? onColor : 'rgba(255,255,255,0.18)';
        ledEl.style.boxShadow = on ? `0 0 40px ${onColor}` : 'none';
      } else {
        ledEl.style.borderColor = '';
        ledEl.style.background = on ? onColor : offColor;
        ledEl.style.boxShadow = on ? `0 0 40px ${onColor}` : 'none';
      }

      console.log('[UI] LED', id, 'is now', on ? 'ON' : 'OFF');
      break;
    }
    case 'label': el.querySelector('.rt-label-text').textContent = val; break;
    case 'gauge': updateGaugeWidget(w, val); break;
    case 'graph': {
      // val is comma-separated numbers: "23.4,2.1"
      pushGraphPoint(w, val);
      const last = el.querySelector('[data-role="graphLast"]');
      if (last) last.textContent = val;
      drawGraphWidget(w);
      break;
    }
  }
}

document.addEventListener('DOMContentLoaded', init);
</script>

<input type="file" id="jsonFileInput" accept="application/json" style="display:none" />
</body>
</html>
