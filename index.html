<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>micro:bit Remote</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/interact.js/1.10.27/interact.min.js"></script>
<style>
:root {
  --bg: #1a1a2e;
  --surface: #16213e;
  --card: #1f3460;
  --accent: #00d4ff;
  --pink: #ff6b9d;
  --green: #00e676;
  --orange: #ff9100;
  --purple: #b388ff;
  --red: #ff5252;
  --yellow: #ffea00;
  --text: #ffffff;
  --text-dim: #8892b0;
}

* { box-sizing: border-box; margin: 0; padding: 0; }
html, body { height: 100%; overflow: hidden; touch-action: manipulation; font-family: 'Segoe UI', system-ui, sans-serif; }
body { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); color: var(--text); }

.app { display: flex; flex-direction: column; height: 100dvh; }

/* Header */
header {
  display: flex; align-items: center; gap: 10px;
  padding: 8px 12px; background: rgba(22,33,62,0.95);
  border-bottom: 2px solid var(--card);
}
.logo { font-size: 1.3rem; font-weight: 800; }
.logo span { background: linear-gradient(90deg, var(--accent), var(--pink)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
.spacer { flex: 1; }

.tabs { display: flex; background: var(--card); border-radius: 30px; padding: 4px; }
.tab {
  padding: 10px 20px; border: none; background: none;
  color: var(--text-dim); font-weight: 700; font-size: 0.9rem;
  border-radius: 30px; cursor: pointer; transition: 0.2s;
}
.tab.active { background: linear-gradient(135deg, var(--accent), var(--purple)); color: #000; }

.ble-btn {
  display: flex; align-items: center; gap: 8px;
  padding: 10px 16px; border-radius: 30px;
  background: var(--card); border: 2px solid var(--red);
  color: var(--red); font-weight: 700; cursor: pointer;
}
.ble-btn.connected { border-color: var(--green); color: var(--green); }
.ble-dot { width: 12px; height: 12px; border-radius: 50%; background: currentColor; }

/* Main Content */
main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
.view { display: none; flex-direction: column; height: 100%; }
.view.active { display: flex; }

/* Builder View */
.builder-header {
  display: flex; align-items: center; gap: 8px;
  padding: 10px 12px; background: var(--surface);
  flex-wrap: wrap;
}
.title-input {
  flex: 1; min-width: 120px; padding: 12px 16px;
  background: var(--card); border: 2px solid transparent;
  border-radius: 16px; color: var(--text); font-size: 1rem; font-weight: 600;
}
.title-input:focus { outline: none; border-color: var(--accent); }
.header-btn {
  padding: 12px 20px; border: none; border-radius: 16px;
  font-weight: 700; font-size: 0.85rem; cursor: pointer; transition: 0.2s;
  display: flex; align-items: center; gap: 6px;
}
.header-btn:hover { transform: scale(1.05); }
.btn-demo { background: linear-gradient(135deg, var(--yellow), var(--orange)); color: #000; }
.btn-code { background: linear-gradient(135deg, var(--accent), var(--purple)); color: #000; }
.btn-delete { background: var(--red); color: #fff; }

/* Palette - Bottom on mobile */
.palette {
  display: flex; gap: 8px; padding: 10px;
  background: var(--surface); border-top: 2px solid var(--card);
  overflow-x: auto; order: 2;
}
.palette-item {
  flex-shrink: 0; display: flex; flex-direction: column;
  align-items: center; gap: 6px; padding: 12px 16px;
  background: var(--card); border: 3px solid transparent;
  border-radius: 16px; cursor: pointer; transition: 0.2s;
  min-width: 72px;
}
.palette-item:hover, .palette-item.selected { border-color: var(--accent); transform: scale(1.05); }
.palette-item.selected { background: linear-gradient(135deg, var(--accent), var(--purple)); }
.palette-item.selected .palette-name { color: #000; }
.palette-icon { font-size: 28px; }
.palette-name { font-size: 0.7rem; font-weight: 700; color: var(--text-dim); text-transform: uppercase; }

/* Canvas */
.canvas-wrap { flex: 1; padding: 10px; overflow: hidden; order: 1; display: flex; flex-direction: column; }
.canvas-hint { text-align: center; padding: 8px; color: var(--text-dim); font-size: 0.85rem; }
.canvas-hint span { color: var(--accent); font-weight: 700; }
.canvas {
  flex: 1; position: relative; background: var(--card);
  border: 3px dashed var(--text-dim); border-radius: 20px;
  overflow: auto; min-height: 250px;
}
#widgetsLayer { position: absolute; inset: 0; }

.widget {
  position: absolute; background: var(--surface);
  border: 3px solid var(--text-dim); border-radius: 16px;
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  cursor: move; touch-action: none; user-select: none; gap: 4px; padding: 8px;
}
.widget.selected { border-color: var(--accent); box-shadow: 0 0 30px rgba(0,212,255,0.5); }
.widget-icon { font-size: 2rem; pointer-events: none; }
.widget-label { font-size: 0.75rem; font-weight: 700; color: var(--text-dim); pointer-events: none; }
.widget .resize-handle {
  position: absolute; bottom: -2px; right: -2px;
  width: 24px; height: 24px; cursor: se-resize;
  background: var(--accent); border-radius: 0 0 14px 0;
  clip-path: polygon(100% 0, 100% 100%, 0 100%);
}

/* Runtime View */
.runtime-view { align-items: center; justify-content: center; padding: 20px; }
.connect-box { text-align: center; }
.connect-icon { font-size: 6rem; margin-bottom: 20px; animation: bounce 1s infinite; }
@keyframes bounce { 0%,100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }
.connect-text { font-size: 1.3rem; font-weight: 700; margin-bottom: 24px; }
.connect-btn {
  padding: 18px 40px; border: none; border-radius: 30px;
  background: linear-gradient(135deg, var(--green), var(--accent));
  color: #000; font-size: 1.2rem; font-weight: 800; cursor: pointer;
}
#runtimeContent { display: none; flex-direction: column; align-items: center; width: 100%; }
#runtimeTitle { font-size: 1.6rem; font-weight: 800; color: var(--accent); margin-bottom: 20px; }
#runtimeGrid { position: relative; background: var(--card); border: 3px solid var(--surface); border-radius: 20px; }

/* Runtime Widgets */
.rt-widget { position: absolute; padding: 10px; display: flex; align-items: center; justify-content: center; }
.rt-button {
  width: 100%; height: 100%; border: none; border-radius: 16px;
  background: linear-gradient(135deg, #6366f1, var(--purple));
  color: #fff; font-weight: 700; cursor: pointer;
  display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 6px;
  font-size: 1rem; transition: 0.1s;
}
.rt-button:active { transform: scale(0.9); }
.rt-button .icon { font-size: 2rem; }

.rt-slider-wrap { width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; gap: 10px; }
.rt-slider-info { display: flex; justify-content: space-between; font-weight: 700; }
.rt-slider { width: 100%; height: 12px; border-radius: 6px; background: var(--surface); -webkit-appearance: none; }
.rt-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 30px; height: 30px; border-radius: 50%; background: linear-gradient(135deg, var(--purple), var(--pink)); cursor: pointer; }

.rt-toggle-wrap { display: flex; flex-direction: column; align-items: center; gap: 10px; }
.rt-toggle { width: 70px; height: 70px; border: none; border-radius: 16px; background: var(--red); color: #fff; font-size: 2rem; cursor: pointer; transition: 0.2s; }
.rt-toggle.on { background: var(--green); }

.rt-led-wrap { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 10px; }
.rt-led { width: 60px; height: 60px; border-radius: 50%; background: rgba(255,82,82,0.2); transition: 0.2s; }
.rt-led.on { background: var(--red); box-shadow: 0 0 40px var(--red); }

.rt-joystick-wrap { display: flex; flex-direction: column; align-items: center; gap: 6px; }
.rt-joystick-base { width: 100px; height: 100px; border-radius: 50%; background: var(--surface); border: 4px solid var(--accent); display: flex; align-items: center; justify-content: center; touch-action: none; }
.rt-joystick-stick { width: 50px; height: 50px; border-radius: 50%; background: linear-gradient(135deg, var(--accent), var(--purple)); pointer-events: none; }

.rt-label-text { font-weight: 700; font-size: 1.2rem; text-align: center; }

/* Toast */
.toast { position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%); padding: 16px 32px; background: var(--card); border: 3px solid var(--accent); border-radius: 30px; font-weight: 700; font-size: 1rem; transition: 0.3s; z-index: 1000; }
.toast.show { bottom: 30px; }
.toast.success { border-color: var(--green); color: var(--green); }
.toast.error { border-color: var(--red); color: var(--red); }

/* Modal */
.modal-bg { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 200; align-items: center; justify-content: center; padding: 20px; }
.modal-bg.show { display: flex; }
.modal { background: var(--surface); border: 3px solid var(--accent); border-radius: 24px; padding: 24px; max-width: 600px; width: 100%; max-height: 85vh; overflow-y: auto; }
.modal-title { font-size: 1.4rem; font-weight: 800; color: var(--accent); margin-bottom: 16px; }
.modal-code { background: var(--card); padding: 16px; border-radius: 16px; font-family: 'Fira Code', 'Consolas', monospace; font-size: 0.8rem; max-height: 400px; overflow: auto; color: var(--green); white-space: pre-wrap; word-break: break-all; margin-bottom: 16px; line-height: 1.5; }
.modal-buttons { display: flex; gap: 10px; flex-wrap: wrap; }
.modal-btn { flex: 1; padding: 14px 20px; border: none; border-radius: 16px; font-weight: 700; cursor: pointer; }
.modal-btn.primary { background: linear-gradient(135deg, var(--accent), var(--purple)); color: #000; }
.modal-btn.secondary { background: var(--card); color: var(--text); }

/* Template Modal */
.template-modal { position: fixed; inset: 0; background: rgba(26,26,46,0.98); z-index: 100; display: flex; align-items: center; justify-content: center; padding: 20px; }
.template-modal.hidden { display: none; }
.template-content { text-align: center; max-width: 500px; width: 100%; }
.template-content h2 { font-size: 1.8rem; margin-bottom: 10px; background: linear-gradient(90deg, var(--accent), var(--pink)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
.template-content p { color: var(--text-dim); margin-bottom: 24px; font-size: 1rem; }
.templates-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
.template-card { background: var(--card); border: 3px solid transparent; border-radius: 20px; padding: 20px 10px; cursor: pointer; transition: 0.2s; }
.template-card:hover { border-color: var(--accent); transform: scale(1.05); }
.template-card:active { transform: scale(0.95); }
.template-icon { font-size: 3rem; margin-bottom: 10px; }
.template-name { font-weight: 700; font-size: 0.9rem; }

/* Responsive */
@media (min-width: 768px) {
  .builder-view { flex-direction: row; }
  .palette { flex-direction: column; width: 100px; border-top: none; border-right: 2px solid var(--card); order: 0; overflow-y: auto; overflow-x: visible; }
  .canvas-wrap { order: 0; }
  .palette-item { width: 100%; min-width: unset; }
}
@media (max-width: 500px) {
  .logo { font-size: 1rem; }
  .tab { padding: 8px 14px; font-size: 0.8rem; }
  .ble-btn span:last-child { display: none; }
  .templates-grid { grid-template-columns: repeat(2, 1fr); }
  .template-icon { font-size: 2.2rem; }
  .header-btn { padding: 10px 14px; font-size: 0.75rem; }
}
</style>
</head>
<body>
<div class="app">
  <header>
    <div class="logo">üéÆ <span>micro:bit</span></div>
    <div class="spacer"></div>
    <div class="tabs">
      <button class="tab active" data-tab="builder">‚úèÔ∏è Build</button>
      <button class="tab" data-tab="runtime">‚ñ∂Ô∏è Play</button>
    </div>
    <button id="bleBtn" class="ble-btn">
      <span class="ble-dot"></span>
      <span>Connect</span>
    </button>
  </header>

  <div id="templateModal" class="template-modal">
    <div class="template-content">
      <h2>üé® Choose a Template!</h2>
      <p>Pick one to start building your remote</p>
      <div class="templates-grid">
        <div class="template-card" data-tpl="gamepad"><div class="template-icon">üéÆ</div><div class="template-name">Game Pad</div></div>
        <div class="template-card" data-tpl="robot"><div class="template-icon">ü§ñ</div><div class="template-name">Robot</div></div>
        <div class="template-card" data-tpl="mixer"><div class="template-icon">üéµ</div><div class="template-name">DJ Mixer</div></div>
        <div class="template-card" data-tpl="racing"><div class="template-icon">üèéÔ∏è</div><div class="template-name">Race Car</div></div>
        <div class="template-card" data-tpl="lights"><div class="template-icon">üí°</div><div class="template-name">Lights</div></div>
        <div class="template-card" data-tpl="blank"><div class="template-icon">‚ú®</div><div class="template-name">Start Fresh</div></div>
      </div>
    </div>
  </div>

  <main>
    <div class="view builder-view active">
      <div class="builder-header">
        <input type="text" id="titleInput" class="title-input" placeholder="üè∑Ô∏è Name your remote..." maxlength="25">
        <button class="header-btn btn-demo" id="demoBtn">üéÆ Try All Widgets!</button>
        <button class="header-btn btn-code" id="codeBtn">üìÑ Code</button>
        <button class="header-btn btn-delete" id="deleteBtn">üóëÔ∏è</button>
      </div>
      <div class="canvas-wrap">
        <div class="canvas-hint">üëÜ Tap a widget below, then <span>tap here</span> to place it!</div>
        <div id="canvas" class="canvas"><div id="widgetsLayer"></div></div>
      </div>
      <div class="palette">
        <div class="palette-item" data-type="button"><div class="palette-icon">üëÜ</div><div class="palette-name">Button</div></div>
        <div class="palette-item" data-type="slider"><div class="palette-icon">üéöÔ∏è</div><div class="palette-name">Slider</div></div>
        <div class="palette-item" data-type="toggle"><div class="palette-icon">üîò</div><div class="palette-name">Switch</div></div>
        <div class="palette-item" data-type="joystick"><div class="palette-icon">üïπÔ∏è</div><div class="palette-name">Joystick</div></div>
        <div class="palette-item" data-type="led"><div class="palette-icon">üí°</div><div class="palette-name">Light</div></div>
        <div class="palette-item" data-type="label"><div class="palette-icon">üè∑Ô∏è</div><div class="palette-name">Label</div></div>
      </div>
    </div>

    <div class="view runtime-view">
      <div id="connectPrompt" class="connect-box">
        <div class="connect-icon">üì°</div>
        <div class="connect-text">Connect your micro:bit!</div>
        <button id="connectBtn" class="connect-btn">üîó Connect</button>
      </div>
      <div id="runtimeContent"><div id="runtimeTitle"></div><div id="runtimeGrid"></div></div>
    </div>
  </main>
</div>

<div id="toast" class="toast"></div>
<div id="modalBg" class="modal-bg">
  <div class="modal">
    <div id="modalTitle" class="modal-title"></div>
    <pre id="modalCode" class="modal-code"></pre>
    <div class="modal-buttons">
      <button class="modal-btn primary" id="copyBtn">üìã Copy</button>
      <button class="modal-btn primary" id="downloadBtn">üíæ Save</button>
      <button class="modal-btn secondary" id="modalClose">‚úñÔ∏è Close</button>
    </div>
  </div>
</div>
<input type="file" id="fileInput" accept=".json" hidden>

<script>
const UART_SERVICE = '6e400001-b5a3-f393-e0a9-e50e24dcca9e';
const UART_TX_CHAR = '6e400002-b5a3-f393-e0a9-e50e24dcca9e';
const UART_RX_CHAR = '6e400003-b5a3-f393-e0a9-e50e24dcca9e';

const encoder = new TextEncoder();
const esc = s => { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; };
const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);

const ICONS = { button:'üëÜ', slider:'üéöÔ∏è', toggle:'üîò', joystick:'üïπÔ∏è', led:'üí°', label:'üè∑Ô∏è' };
const SIZES = { button:[90,90], slider:[90,160], toggle:[90,90], joystick:[120,120], led:[90,90], label:[120,60] };

const templates = {
  gamepad: [
    { t:'joystick', x:20, y:30, w:120, h:120, label:'Move' },
    { t:'button', x:180, y:40, w:90, h:90, label:'Jump' },
    { t:'button', x:290, y:40, w:90, h:90, label:'Fire' },
    { t:'toggle', x:180, y:160, w:90, h:90, label:'Turbo' }
  ],
  robot: [
    { t:'slider', x:20, y:20, w:90, h:180, label:'Arm 1' },
    { t:'slider', x:130, y:20, w:90, h:180, label:'Arm 2' },
    { t:'slider', x:240, y:20, w:90, h:180, label:'Arm 3' },
    { t:'toggle', x:350, y:80, w:90, h:90, label:'Grip' }
  ],
  mixer: [
    { t:'slider', x:20, y:20, w:80, h:200, label:'Bass' },
    { t:'slider', x:120, y:20, w:80, h:200, label:'Mid' },
    { t:'slider', x:220, y:20, w:80, h:200, label:'High' },
    { t:'toggle', x:320, y:80, w:90, h:90, label:'FX' },
    { t:'led', x:320, y:20, w:90, h:50, label:'Beat' }
  ],
  racing: [
    { t:'joystick', x:150, y:20, w:130, h:130, label:'Steer' },
    { t:'slider', x:20, y:170, w:80, h:140, label:'Gas' },
    { t:'slider', x:330, y:170, w:80, h:140, label:'Brake' },
    { t:'button', x:150, y:180, w:130, h:80, label:'Nitro!' }
  ],
  lights: [
    { t:'toggle', x:30, y:30, w:100, h:100, label:'Red' },
    { t:'toggle', x:160, y:30, w:100, h:100, label:'Green' },
    { t:'toggle', x:290, y:30, w:100, h:100, label:'Blue' },
    { t:'led', x:90, y:160, w:100, h:100, label:'Status' },
    { t:'led', x:230, y:160, w:100, h:100, label:'Alert' }
  ],
  blank: []
};

const state = {
  widgets: [], selected: null, nextId: 1, selectedType: null,
  ble: { device:null, server:null, service:null, notifyChar:null, writeChar:null, connected:false },
  config: null, values: {}, rxBuffer: ''
};

// BLE send with verbose debug logging
async function send(msg) {
  console.log('[BLE] Attempting to send:', msg);
  
  if (!state.ble.writeChar) {
    console.log('[BLE] ERROR: No writeChar available');
    return;
  }
  
  // Check if still connected
  const gattConnected = state.ble.device?.gatt?.connected;
  console.log('[BLE] GATT connected:', gattConnected);
  
  if (!gattConnected) {
    console.log('[BLE] ERROR: GATT disconnected, triggering onDisconnect');
    onDisconnect();
    return;
  }
  
  try {
    console.log('[BLE] Writing value...');
    await state.ble.writeChar.writeValue(encoder.encode(msg + '\n'));
    console.log('[BLE] Write SUCCESS');
  } catch (err) { 
    console.error('[BLE] Write FAILED:', err.name, err.message);
    // If write fails with certain errors, assume disconnected
    if (err.message?.includes('GATT') || err.message?.includes('disconnected')) {
      console.log('[BLE] Triggering disconnect due to GATT error');
      onDisconnect();
    }
  }
}

// One-click Demo - creates full showcase with all widgets
function showDemo() {
  // Create a demo with ALL widget types
  state.widgets = [
    { id: 'btn_jump', t: 'button', x: 20, y: 20, w: 100, h: 100, label: 'Jump!' },
    { id: 'btn_fire', t: 'button', x: 140, y: 20, w: 100, h: 100, label: 'Fire!' },
    { id: 'slider_speed', t: 'slider', x: 260, y: 20, w: 90, h: 180, label: 'Speed' },
    { id: 'slider_power', t: 'slider', x: 370, y: 20, w: 90, h: 180, label: 'Power' },
    { id: 'toggle_turbo', t: 'toggle', x: 20, y: 140, w: 100, h: 100, label: 'Turbo' },
    { id: 'toggle_shield', t: 'toggle', x: 140, y: 140, w: 100, h: 100, label: 'Shield' },
    { id: 'joy_move', t: 'joystick', x: 20, y: 260, w: 140, h: 140, label: 'Move' },
    { id: 'led_status', t: 'led', x: 180, y: 260, w: 100, h: 100, label: 'Status' },
    { id: 'led_alert', t: 'led', x: 300, y: 260, w: 100, h: 100, label: 'Alert' },
    { id: 'label_score', t: 'label', x: 180, y: 380, w: 150, h: 50, label: 'Score: 0' }
  ];
  state.nextId = 20;
  state.selected = null;
  $('#titleInput').value = 'Super Demo Remote';
  renderWidgets();
  
  // Show the code modal with demo code
  const cfg = { title: 'Super Demo Remote', widgets: state.widgets };
  $('#modalTitle').textContent = 'Demo Ready! Copy this code to MakeCode:';
  $('#modalCode').textContent = generateDemoCode(cfg);
  $('#modalBg').classList.add('show');
  
  toast('Demo loaded with ALL widgets!', 'success');
}

function generateDemoCode(cfg) {
  // Unicode-safe base64 encoding (handles emojis!)
  const b64 = btoa(unescape(encodeURIComponent(JSON.stringify(cfg))));
  
  // Group widgets by type
  const buttons = cfg.widgets.filter(w => w.t === 'button');
  const sliders = cfg.widgets.filter(w => w.t === 'slider');
  const toggles = cfg.widgets.filter(w => w.t === 'toggle');
  const joysticks = cfg.widgets.filter(w => w.t === 'joystick');
  const leds = cfg.widgets.filter(w => w.t === 'led');
  const labels = cfg.widgets.filter(w => w.t === 'label');
  
  // Generate handler code for each widget
  let buttonCode = buttons.map(w => `    // Button: ${w.label || w.id}
    if (id == "${w.id}" && val == "1") {
        basic.showIcon(IconNames.Heart)
        // Add your code here!
    }`).join('\n');
  
  let sliderCode = sliders.map(w => `    // Slider: ${w.label || w.id} (val = 0-100)
    if (id == "${w.id}") {
        let value = parseInt(val)
        led.plotBarGraph(value, 100)
        // Use value for motors, sounds, etc!
    }`).join('\n');
  
  let toggleCode = toggles.map(w => `    // Toggle: ${w.label || w.id} (val = "1" or "0")
    if (id == "${w.id}") {
        if (val == "1") {
            basic.showIcon(IconNames.Yes)
        } else {
            basic.showIcon(IconNames.No)
        }
    }`).join('\n');
  
  let joystickCode = joysticks.map(w => `    // Joystick: ${w.label || w.id} (val = "angle distance")
    if (id == "${w.id}") {
        let parts = val.split(" ")
        let angle = parseInt(parts[0])  // -180 to 180
        let dist = parseInt(parts[1])   // 0 to ~50
        // Use for steering, movement, etc!
        if (dist > 10) {
            basic.showArrow(angle > 0 ? ArrowNames.East : ArrowNames.West)
        } else {
            basic.showLeds(\`
                . . . . .
                . . # . .
                . # # # .
                . . # . .
                . . . . .
            \`)
        }
    }`).join('\n');

  let ledList = leds.map(w => `//   sendValue("${w.id}", "1")  // Turn ON ${w.label || 'LED'}
//   sendValue("${w.id}", "0")  // Turn OFF`).join('\n');

  let labelList = labels.map(w => `//   sendValue("${w.id}", "Hello!")  // Update ${w.label || 'label'}`).join('\n');

  return `// ${cfg.title} - micro:bit Remote
// Copy this to MakeCode: https://makecode.microbit.org
// Then flash it to your micro:bit!

bluetooth.startUartService()
let cfgSent = false
let blinkState = false
const CFG = "${b64}"

// This sends the remote layout to the app
bluetooth.onUartDataReceived(serial.delimiters(Delimiters.NewLine), function() {
    let cmd = bluetooth.uartReadUntil(serial.delimiters(Delimiters.NewLine))
    
    if (cmd == "GETCFG") {
        bluetooth.uartWriteLine("CFGBEGIN")
        for (let i = 0; i < CFG.length; i += 18) {
            bluetooth.uartWriteLine("CFG " + CFG.substr(i, 18))
        }
        bluetooth.uartWriteLine("CFGEND")
        cfgSent = true
        basic.showIcon(IconNames.Yes)
    } 
    else if (cmd.indexOf("SET ") == 0) {
        let parts = cmd.substr(4).split(" ")
        let id = parts[0]
        let val = parts.slice(1).join(" ")
        handleWidget(id, val)
    }
})

// HANDLE YOUR WIDGETS HERE!
function handleWidget(id: string, val: string) {
    serial.writeLine(id + " = " + val)
    
${buttonCode || '    // No buttons in this remote'}

${sliderCode || '    // No sliders in this remote'}

${toggleCode || '    // No toggles in this remote'}

${joystickCode || '    // No joysticks in this remote'}
}

// Send values TO the app (for LEDs and Labels)
function sendValue(id: string, val: string) {
    if (cfgSent) bluetooth.uartWriteLine("UPD " + id + " " + val)
}

// Show we are ready!
basic.showIcon(IconNames.Heart)

// BLINK THE APP LEDs! This runs forever in background
basic.forever(function() {
    if (cfgSent) {
        blinkState = !blinkState
        ${leds.length > 0 ? leds.map(l => `sendValue("${l.id}", blinkState ? "1" : "0")`).join('\n        ') : '// No LEDs to blink'}
        ${labels.length > 0 ? `sendValue("${labels[0].id}", blinkState ? "ON!" : "OFF")` : ''}
    }
    basic.pause(1000)
})

// BONUS: Use micro:bit buttons too!
input.onButtonPressed(Button.A, function() {
    basic.showString("A")
    ${leds.length > 0 ? `sendValue("${leds[0].id}", "1")` : '// Add an LED to control it here!'}
})
input.onButtonPressed(Button.B, function() {
    basic.showString("B")
    ${leds.length > 0 ? `sendValue("${leds[0].id}", "0")` : '// Add an LED to control it here!'}
})`;
}

function init() {
  // Tabs
  $$('.tab').forEach(t => t.onclick = () => switchTab(t.dataset.tab));
  
  // Templates
  $$('.template-card').forEach(c => c.onclick = () => selectTemplate(c.dataset.tpl));
  
  // Palette - tap to select
  $$('.palette-item').forEach(p => {
    p.onclick = () => {
      $$('.palette-item').forEach(x => x.classList.remove('selected'));
      p.classList.add('selected');
      state.selectedType = p.dataset.type;
      toast(`‚úÖ ${ICONS[state.selectedType]} selected! Tap canvas to place`, 'success');
    };
  });
  
  // Canvas - tap to place
  $('#canvas').onclick = e => {
    if (e.target.closest('.widget')) return;
    if (state.selectedType) {
      const rect = $('#canvas').getBoundingClientRect();
      const [w, h] = SIZES[state.selectedType];
      const x = Math.max(0, Math.min(e.clientX - rect.left - w/2, rect.width - w));
      const y = Math.max(0, Math.min(e.clientY - rect.top - h/2, rect.height - h));
      state.widgets.push({ id: `${state.selectedType}${state.nextId++}`, t: state.selectedType, x, y, w, h, label: '' });
      renderWidgets();
      toast(`‚ú® ${ICONS[state.selectedType]} added!`, 'success');
    } else {
      state.selected = null;
      renderWidgets();
    }
  };
  
  // Buttons
  $('#bleBtn').onclick = connectBle;
  $('#connectBtn').onclick = connectBle;
  $('#demoBtn').onclick = showDemo;
  $('#codeBtn').onclick = showCode;
  $('#deleteBtn').onclick = deleteSelected;
  $('#modalClose').onclick = () => $('#modalBg').classList.remove('show');
  $('#modalBg').onclick = e => { if (e.target === $('#modalBg')) $('#modalBg').classList.remove('show'); };
  $('#copyBtn').onclick = () => { navigator.clipboard.writeText($('#modalCode').textContent); toast('üìã Copied!', 'success'); };
  $('#downloadBtn').onclick = downloadCode;
  
  $('#templateModal').classList.remove('hidden');
}

function selectTemplate(name) {
  const t = templates[name];
  if (!t) return;
  state.widgets = t.map((w, i) => ({ id: `${w.t}${state.nextId + i}`, ...w }));
  state.nextId += t.length || 1;
  state.selected = null;
  $('#templateModal').classList.add('hidden');
  renderWidgets();
  if (name === 'blank') toast('‚ú® Canvas ready! Pick a widget below', 'success');
}

function switchTab(tab) {
  $$('.tab').forEach(t => t.classList.toggle('active', t.dataset.tab === tab));
  $$('.view').forEach(v => v.classList.remove('active'));
  $(`.${tab === 'builder' ? 'builder-view' : 'runtime-view'}`).classList.add('active');
}

function renderWidgets() {
  const layer = $('#widgetsLayer');
  layer.innerHTML = '';
  state.widgets.forEach(w => {
    const el = document.createElement('div');
    el.className = 'widget' + (state.selected === w.id ? ' selected' : '');
    el.dataset.id = w.id;
    el.style.cssText = `left:${w.x}px;top:${w.y}px;width:${w.w}px;height:${w.h}px`;
    el.innerHTML = `<div class="widget-icon">${ICONS[w.t]}</div><div class="widget-label">${esc(w.label) || w.t}</div><div class="resize-handle"></div>`;
    layer.appendChild(el);
    
    interact(el).draggable({
      inertia: true,
      modifiers: [interact.modifiers.restrictRect({ restriction: 'parent' })],
      listeners: {
        start() { state.selected = w.id; renderWidgets(); },
        move(e) {
          w.x += e.dx; w.y += e.dy;
          e.target.style.left = w.x + 'px';
          e.target.style.top = w.y + 'px';
        }
      }
    }).resizable({
      edges: { right: true, bottom: true },
      modifiers: [interact.modifiers.restrictSize({ min: { width: 60, height: 60 } })],
      listeners: {
        move(e) {
          w.w = e.rect.width; w.h = e.rect.height;
          e.target.style.width = w.w + 'px';
          e.target.style.height = w.h + 'px';
        }
      }
    });
    
    el.onclick = e => { e.stopPropagation(); state.selected = w.id; renderWidgets(); };
  });
}

function deleteSelected() {
  if (!state.selected) { toast('üëÜ Select a widget first!', 'error'); return; }
  state.widgets = state.widgets.filter(w => w.id !== state.selected);
  state.selected = null;
  renderWidgets();
  toast('üóëÔ∏è Deleted!', 'success');
}

function showCode() {
  if (state.widgets.length === 0) {
    toast('üëÜ Add some widgets first!', 'error');
    return;
  }
  const cfg = { title: $('#titleInput').value || 'My Remote', widgets: state.widgets };
  $('#modalTitle').textContent = 'üìÑ Your micro:bit Code';
  $('#modalCode').textContent = generateDemoCode(cfg);
  $('#modalBg').classList.add('show');
}

function downloadCode() {
  const blob = new Blob([$('#modalCode').textContent], { type: 'text/plain' });
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
  a.download = 'microbit-remote.ts'; a.click();
  toast('üíæ Downloaded!', 'success');
}

function toast(msg, type = '') {
  const t = $('#toast'); t.textContent = msg;
  t.className = `toast ${type} show`;
  setTimeout(() => t.classList.remove('show'), 2500);
}

// BLE Connection
async function connectBle() {
  console.log('[BLE] Starting connection...');
  try {
    console.log('[BLE] Requesting device...');
    const device = await navigator.bluetooth.requestDevice({
      filters: [{ namePrefix: 'BBC micro:bit' }],
      optionalServices: [UART_SERVICE]
    });
    console.log('[BLE] Device selected:', device.name);
    
    device.addEventListener('gattserverdisconnected', () => {
      console.log('[BLE] GATT server disconnected event');
      onDisconnect();
    });
    
    console.log('[BLE] Connecting to GATT server...');
    const server = await device.gatt.connect();
    console.log('[BLE] GATT connected');
    
    console.log('[BLE] Getting UART service...');
    const service = await server.getPrimaryService(UART_SERVICE);
    console.log('[BLE] UART service found');
    
    console.log('[BLE] Getting TX characteristic...');
    const notifyChar = await service.getCharacteristic(UART_TX_CHAR);
    console.log('[BLE] TX characteristic found');
    
    console.log('[BLE] Getting RX characteristic...');
    const writeChar = await service.getCharacteristic(UART_RX_CHAR);
    console.log('[BLE] RX characteristic found');
    
    console.log('[BLE] Starting notifications...');
    await notifyChar.startNotifications();
    notifyChar.addEventListener('characteristicvaluechanged', onNotify);
    console.log('[BLE] Notifications started');
    
    state.ble = { device, server, service, notifyChar, writeChar, connected: true };
    state.rxBuffer = '';
    updateBleUI();
    toast('Connected!', 'success');
    
    console.log('[BLE] Waiting 500ms then sending GETCFG...');
    setTimeout(() => { 
      console.log('[BLE] Sending GETCFG now');
      state.rxBuffer = ''; 
      send('GETCFG'); 
    }, 500);
  } catch (err) {
    console.error('[BLE] Connection error:', err);
    toast('Connection failed', 'error');
  }
}

function onDisconnect() {
  console.log('[BLE] Disconnected!');
  state.ble = { device:null, server:null, service:null, notifyChar:null, writeChar:null, connected:false };
  updateBleUI();
  toast('Disconnected', 'error');
}

function updateBleUI() {
  const btn = $('#bleBtn');
  if (state.ble.connected) {
    btn.classList.add('connected');
    btn.querySelector('span:last-child').textContent = 'Connected';
    $('#connectPrompt').style.display = 'none';
    $('#runtimeContent').style.display = 'flex';
  } else {
    btn.classList.remove('connected');
    btn.querySelector('span:last-child').textContent = 'Connect';
    $('#connectPrompt').style.display = 'block';
    $('#runtimeContent').style.display = 'none';
  }
}

let configBuffer = '';
function onNotify(event) {
  const value = event.target.value;
  let str = '';
  for (let i = 0; i < value.byteLength; i++) {
    const byte = value.getUint8(i);
    if (byte !== 13) str += String.fromCharCode(byte);
  }
  console.log('[BLE RX] Received:', str.replace(/\n/g, '\\n'));
  state.rxBuffer += str;
  let nl;
  while ((nl = state.rxBuffer.indexOf('\n')) !== -1) {
    const line = state.rxBuffer.slice(0, nl).trim();
    state.rxBuffer = state.rxBuffer.slice(nl + 1);
    if (line) processLine(line);
  }
}

function processLine(line) {
  console.log('[BLE] Processing line:', line);
  if (line.startsWith('CFGBEGIN')) {
    console.log('[BLE] Config begin');
    configBuffer = '';
  }
  else if (line.startsWith('CFG ')) {
    configBuffer += line.substring(4);
    console.log('[BLE] Config chunk, total length:', configBuffer.length);
  }
  else if (line === 'CFGEND') {
    console.log('[BLE] Config end, decoding...');
    try { 
      // Unicode-safe base64 decoding (handles emojis!)
      state.config = JSON.parse(decodeURIComponent(escape(atob(configBuffer)))); 
      console.log('[BLE] Config decoded:', state.config);
      renderRuntime(); 
      toast('Remote loaded!', 'success'); 
    }
    catch(e) { console.error('[BLE] Config parse error:', e); toast('Config error', 'error'); }
  } else if (line.startsWith('UPD ')) {
    const parts = line.substring(4).split(' ');
    const id = parts[0];
    const val = parts.slice(1).join(' ');
    console.log('[BLE] Update widget:', id, '=', val);
    state.values[id] = val;
    updateRuntimeWidget(id, val);
  }
}

function renderRuntime() {
  if (!state.config) return;
  const cfg = state.config;
  $('#runtimeTitle').textContent = cfg.title || 'My Remote';
  const grid = $('#runtimeGrid');
  let maxX = 0, maxY = 0;
  cfg.widgets.forEach(w => { maxX = Math.max(maxX, w.x + w.w); maxY = Math.max(maxY, w.y + w.h); });
  grid.style.width = `${Math.max(400, maxX + 20)}px`;
  grid.style.height = `${Math.max(320, maxY + 20)}px`;
  grid.innerHTML = '';
  cfg.widgets.forEach(w => {
    const el = document.createElement('div');
    el.className = 'rt-widget'; el.dataset.id = w.id;
    el.style.cssText = `left:${w.x}px;top:${w.y}px;width:${w.w}px;height:${w.h}px`;
    el.innerHTML = createRuntimeWidget(w);
    grid.appendChild(el);
    bindRuntimeWidget(el, w);
  });
}

function createRuntimeWidget(w) {
  const val = esc(state.values[w.id] || '0');
  const label = esc(w.label || w.t);
  const rawVal = state.values[w.id] || '0';
  switch (w.t) {
    case 'button': return `<button class="rt-button"><span class="icon">üëÜ</span><span>${label}</span></button>`;
    case 'slider': return `<div class="rt-slider-wrap"><div class="rt-slider-info"><span>${label}</span><span class="rt-slider-val">${val}</span></div><input type="range" class="rt-slider" min="0" max="100" value="${rawVal}"></div>`;
    case 'toggle': return `<div class="rt-toggle-wrap"><button class="rt-toggle${rawVal === '1' ? ' on' : ''}">${rawVal === '1' ? '‚úì' : '‚óã'}</button><span>${label}</span></div>`;
    case 'led': return `<div class="rt-led-wrap"><div class="rt-led${rawVal === '1' ? ' on' : ''}"></div><span>${label}</span></div>`;
    case 'joystick': return `<div class="rt-joystick-wrap"><div class="rt-joystick-base"><div class="rt-joystick-stick"></div></div><span>${label}</span></div>`;
    case 'label': return `<div class="rt-label-text">${val || label}</div>`;
    default: return `<div>${w.t}</div>`;
  }
}

function bindRuntimeWidget(el, w) {
  switch (w.t) {
    case 'button':
      const btn = el.querySelector('.rt-button');
      const press = e => { 
        e.preventDefault(); 
        console.log('[BUTTON] Pressed:', w.id);
        send(`SET ${w.id} 1`); 
        btn.style.transform = 'scale(0.9)'; 
      };
      const release = () => { 
        console.log('[BUTTON] Released:', w.id);
        send(`SET ${w.id} 0`); 
        btn.style.transform = ''; 
      };
      btn.onmousedown = btn.ontouchstart = press;
      btn.onmouseup = btn.onmouseleave = btn.ontouchend = release;
      break;
    case 'slider':
      let sliderTimer = null;
      el.querySelector('.rt-slider').oninput = e => {
        el.querySelector('.rt-slider-val').textContent = e.target.value;
        // Debounce: only send after 50ms of no changes
        clearTimeout(sliderTimer);
        sliderTimer = setTimeout(() => {
          console.log('[SLIDER] Sending value:', e.target.value);
          send(`SET ${w.id} ${e.target.value}`);
        }, 50);
      };
      break;
    case 'toggle':
      el.querySelector('.rt-toggle').onclick = function() {
        const on = this.classList.toggle('on');
        this.textContent = on ? '‚úì' : '‚óã';
        send(`SET ${w.id} ${on ? '1' : '0'}`);
      };
      break;
    case 'joystick':
      const stick = el.querySelector('.rt-joystick-stick');
      const base = el.querySelector('.rt-joystick-base');
      let isDown = false;
      let joyTimer = null;
      let lastJoyMsg = '';
      const handleMove = e => {
        if (!isDown) return;
        const rect = base.getBoundingClientRect();
        const centerX = rect.left + rect.width / 2;
        const centerY = rect.top + rect.height / 2;
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        const dx = clientX - centerX;
        const dy = clientY - centerY;
        const angle = Math.atan2(dy, dx) * 180 / Math.PI;
        const distance = Math.min(40, Math.hypot(dx, dy));
        stick.style.transform = `translate(${Math.cos(angle * Math.PI / 180) * distance}px, ${Math.sin(angle * Math.PI / 180) * distance}px)`;
        // Debounce joystick messages
        const msg = `SET ${w.id} ${Math.round(angle)} ${Math.round(distance)}`;
        if (msg !== lastJoyMsg) {
          lastJoyMsg = msg;
          clearTimeout(joyTimer);
          joyTimer = setTimeout(() => {
            console.log('[JOYSTICK] Sending:', msg);
            send(msg);
          }, 50);
        }
      };
      base.onmousedown = () => { console.log('[JOYSTICK] Down'); isDown = true; };
      base.ontouchstart = e => { e.preventDefault(); console.log('[JOYSTICK] Touch start'); isDown = true; };
      document.addEventListener('mousemove', handleMove);
      document.addEventListener('touchmove', handleMove, { passive: false });
      document.addEventListener('mouseup', () => { console.log('[JOYSTICK] Up'); isDown = false; stick.style.transform = ''; clearTimeout(joyTimer); });
      document.addEventListener('touchend', () => { console.log('[JOYSTICK] Touch end'); isDown = false; stick.style.transform = ''; clearTimeout(joyTimer); });
      break;
  }
}

function updateRuntimeWidget(id, val) {
  console.log('[UI] Updating widget:', id, 'to', val);
  const el = $(`.rt-widget[data-id="${id}"]`);
  if (!el || !state.config) {
    console.log('[UI] Widget not found or no config');
    return;
  }
  const w = state.config.widgets.find(x => x.id === id);
  if (!w) {
    console.log('[UI] Widget definition not found');
    return;
  }
  console.log('[UI] Widget type:', w.t);
  switch (w.t) {
    case 'slider': el.querySelector('.rt-slider').value = val; el.querySelector('.rt-slider-val').textContent = val; break;
    case 'toggle': el.querySelector('.rt-toggle').classList.toggle('on', val === '1'); el.querySelector('.rt-toggle').textContent = val === '1' ? '‚úì' : '‚óã'; break;
    case 'led': 
      const ledEl = el.querySelector('.rt-led');
      ledEl.classList.toggle('on', val === '1'); 
      console.log('[UI] LED', id, 'is now', val === '1' ? 'ON' : 'OFF');
      break;
    case 'label': el.querySelector('.rt-label-text').textContent = val; break;
  }
}

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
